<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Routine Planner</title>

<style>
  :root{
    --bg:#000;
    --fg:#fff;
    --muted:#aaa;
    --line:#2a2a2a;
    --panel:#0c0c0c;
    --panel2:#101010;
    --accent:#00ff6a;
    --warn:#ffcc00;
    --bad:#ff5b5b;
  }
  body{
    background:var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    max-width: 1100px;
    margin: 38px auto;
    padding: 0 16px;
  }
  h1{ margin:0; font-size: 30px; letter-spacing:-0.3px; }
  h2{ margin:6px 0 0 0; font-size: 18px; color:var(--muted); font-weight:600; }
  h3{ margin:0 0 10px 0; font-size: 16px; }
  .muted{ color:var(--muted); }
  .small{ font-size: 12px; color:var(--muted); }
  hr{ border:none; border-top:1px solid var(--line); margin: 22px 0; }

  .topbar{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
    background: var(--panel);
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
  }
  .buttons{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  button{
    border:1px solid var(--line);
    background: var(--panel2);
    color: var(--fg);
    border-radius: 10px;
    padding: 8px 10px;
    cursor:pointer;
  }
  button:hover{ background:#151515; }
  .danger{ color:var(--bad); }

  .card{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
    background: var(--panel);
    margin-bottom: 14px;
  }

  input, select{
    width: 100%;
    box-sizing:border-box;
    background: var(--panel2);
    color: var(--fg);
    border:1px solid var(--line);
    border-radius: 10px;
    padding: 7px 9px;
  }
  input[type="checkbox"]{ width:auto; }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .checklist{ display:grid; gap:8px; }
  .checkRow{ display:flex; gap:10px; align-items:flex-start; }
  .checkRow label{ line-height: 1.2; }

  /* ===================== DASHBOARD (3 BOXEN NEBENEINANDER) ===================== */
  .dashWrap{
    display:grid;
    grid-template-columns: repeat(3, minmax(260px, 1fr));
    gap:12px;
    margin-top:12px;
  }
  @media (max-width: 980px){
    .dashWrap{ grid-template-columns: 1fr; }
  }
  .dashCard{
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
    background: linear-gradient(180deg, #0d0d0d, #070707);
    position:relative;
    overflow:hidden;
  }
  .dashCard::before{
    content:"";
    position:absolute;
    inset:-60px -60px auto auto;
    width:220px;
    height:220px;
    border-radius:999px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,106,0.18), rgba(0,0,0,0) 60%);
    pointer-events:none;
  }
  .dashTitle{
    font-weight:900;
    margin-bottom:10px;
    letter-spacing:-0.2px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .dashHint{ font-size:12px; color:var(--muted); margin-top:-6px; margin-bottom:10px; }
  .chipGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .chip{
    border:1px solid var(--line);
    background: rgba(16,16,16,0.95);
    border-radius:14px;
    padding:10px;
  }
  .chip .v{ font-size:18px; font-weight:900; color: var(--accent); }
  .chip .l{ font-size:12px; color: var(--muted); margin-top:4px; line-height:1.2; }
  .miniList{
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px;
    background:#0b0b0b;
    margin-top:10px;
  }
  .miniList ul{ margin:8px 0 0 18px; }

  /* ===================== SPORT ===================== */
  .dayBlock{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 12px;
    background: var(--panel2);
    margin-top: 10px;
  }
  .dayHeader{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .dayTitle{ font-weight:700; }
  .sessions{ display:grid; gap:10px; margin-top:10px; }
  .session{
    border:1px solid var(--line);
    border-radius: 12px;
    padding: 10px;
    background: #0b0b0b;
  }
  .sessionGrid{
    display:grid;
    grid-template-columns: 1.1fr 0.6fr 0.6fr 0.6fr 0.6fr 1fr auto;
    gap:8px;
    align-items:start;
  }
  @media (max-width: 980px){
    .sessionGrid{ grid-template-columns: 1fr 1fr; }
  }
  .sessionActions{ display:flex; gap:8px; justify-content:flex-end; }
  .miniBtn{ padding: 7px 9px; border-radius: 10px; }
  .miniBtn.danger{ border-color:#3a1a1a; }
  .disabledLook{ opacity:0.35; }

  /* ===================== SUPPLEMENTS ===================== */
  .suppDayBlock{ border:1px solid var(--line); border-radius:14px; padding:12px; background: var(--panel2); margin-top:10px; }
  .suppHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .suppList{ margin-top:10px; display:grid; gap:8px; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--line); background:#0b0b0b;
    border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted);
  }
  .pill button{
    padding:2px 8px; border-radius:999px;
  }

  /* ===================== NAMAZ ===================== */
  .namazGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width: 980px){
    .namazGrid{ grid-template-columns: 1.2fr 0.8fr; }
  }
  .calHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .calendar{
    width:100%;
    border-collapse: collapse;
    overflow:hidden;
    border-radius: 12px;
    border:1px solid var(--line);
    background: #0b0b0b;
  }
  .calendar th, .calendar td{
    border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    padding:8px;
    vertical-align:top;
  }
  .calendar th:last-child, .calendar td:last-child{ border-right:none; }
  .calendar tr:last-child td{ border-bottom:none; }
  .calDayBtn{
    width:100%;
    border:1px solid var(--line);
    background:#101010;
    color:#fff;
    border-radius:10px;
    padding:8px;
    text-align:left;
    cursor:pointer;
  }
  .calDayBtn:hover{ background:#151515; }
  .badge{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border:1px solid var(--line);
    border-radius:999px;
    margin-left:6px;
    color: var(--muted);
  }
  .badge.ok{ color: var(--accent); border-color:#164b2a; }
  .badge.warn{ color: var(--warn); border-color:#5a4b12; }
  .badge.bad{ color: var(--bad); border-color:#5a1b1b; }

  .panel{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 12px;
    background: var(--panel2);
  }
</style>
</head>

<body>

<div class="topbar">
  <div style="min-width:260px;">
    <h1 id="plannerTitle">Routine Planner</h1>
    <h2>Ottoman Power Routinen</h2>
    <div class="small">Woche: <span id="weekLabel"></span> ¬∑ Speicherung lokal (Archiv).</div>
  </div>

  <div style="min-width:280px; flex:1;">
    <div class="small muted" style="margin-bottom:6px;">Name des Routineplaners</div>
    <div class="row" style="gap:8px;">
      <input id="plannerNameInput" placeholder="z.B. Niyazi Tuncay" style="flex:1; min-width:160px;">
      <button id="savePlannerName" style="white-space:nowrap;">Speichern</button>
    </div>
    <div class="small muted" style="margin-top:6px;">
      Bleibt gespeichert (Safari), au√üer im Privatmodus oder wenn Website-Daten gel√∂scht werden.
    </div>
  </div>

  <div class="buttons">
    <button id="prevWeek">‚óÄ Vorherige Woche</button>
    <button id="todayWeek">Diese Woche</button>
    <button id="nextWeek">N√§chste Woche ‚ñ∂</button>
    <button id="resetWeek" class="danger" title="Setzt nur die aktuelle Woche zur√ºck">Woche zur√ºcksetzen</button>
  </div>
</div>

<hr>

<!-- ===================== AUSWERTUNG: 3 BOXEN HORIZONTAL ===================== -->
<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <h3>üìà Gesamt√ºbersicht</h3>
      <div class="small">Sport ¬∑ Lesen ¬∑ Namaz ‚Äî kompakt, motivierend, alles auf einen Blick.</div>
    </div>
    <button id="refreshDash">Aktualisieren</button>
  </div>

  <div class="dashWrap">
    <div class="dashCard">
      <div class="dashTitle">üèãÔ∏è Sport <span class="small muted">Woche + Gesamt</span></div>
      <div class="dashHint">Kurzwerte: Zeit, Kalorien, Joggen, Pace.</div>
      <div id="dashSport"></div>
    </div>

    <div class="dashCard">
      <div class="dashTitle">üìö Lesen <span class="small muted">Woche + Gesamt</span></div>
      <div class="dashHint">Minuten, Seiten, fertige B√ºcher.</div>
      <div id="dashReading"></div>

      <div class="miniList">
        <div style="font-weight:700;">Fertige B√ºcher</div>
        <ul id="finishedBooksList"></ul>
      </div>

      <div style="margin-top:10px;">
        <button id="clearFinishedBooks" class="danger" style="width:100%;">Liste fertiger B√ºcher leeren</button>
      </div>
    </div>

    <div class="dashCard">
      <div class="dashTitle">üïå Namaz <span class="small muted">Gesamt</span></div>
      <div class="dashHint">Gebete gesamt, vollst√§ndige Tage, Jahre (‚âà/365).</div>
      <div id="dashNamaz"></div>
    </div>
  </div>
</div>

<hr>

<div class="card">
  <h3>üïå Namaz-Tracker (Datum, r√ºckwirkend bis 2000)</h3>
  <div class="small">W√§hle Datum/Monat, hake Sabach/√ñƒüle/ƒ∞kindi/Ak≈üam/Yatsƒ± ab. Ein kompletter Tag z√§hlt nur, wenn alle 5 abgehakt sind.</div>

  <div class="namazGrid" style="margin-top:10px;">
    <div class="panel">
      <div class="calHeader">
        <div class="row" style="gap:8px;">
          <button id="calPrev">‚óÄ</button>
          <button id="calToday">Heute</button>
          <button id="calNext">‚ñ∂</button>
          <span class="small muted">Monat:</span>
          <span id="calLabel" style="font-weight:700;"></span>
        </div>
        <div class="row" style="gap:8px;">
          <input id="jumpDate" type="date" style="max-width:220px;">
          <button id="jumpBtn">Zu Datum</button>
        </div>
      </div>

      <div class="small" style="margin-top:8px;">
        Legende: <span class="badge ok">5/5</span> komplett ¬∑ <span class="badge warn">1‚Äì4/5</span> teilweise ¬∑ <span class="badge bad">0/5</span> nichts
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table class="calendar" id="calendar"></table>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin-bottom:8px;">Ausgew√§hlter Tag: <span id="selDateLabel"></span></h3>
      <div id="namazForm" class="checklist"></div>

      <div style="margin-top:10px;">
        <input id="namazNote" placeholder="Notiz (optional)" />
      </div>

      <div class="row" style="margin-top:10px; justify-content:space-between;">
        <button id="clearDay" class="danger">Tag zur√ºcksetzen</button>
        <button id="closeDay">Schlie√üen</button>
      </div>

      <hr style="margin:14px 0;">
      <h3 style="margin-bottom:8px;">Namaz-Gesamtbilanz</h3>
      <div id="namazTotals"></div>
    </div>
  </div>
</div>

<hr>

<div class="card">
  <h3>üíä Supplements</h3>
  <div class="small">Start ist leer. W√§hle aus deiner Liste oder f√ºge eigene Supplements hinzu. Erst dann erscheinen sie im Wochen-Tracker.</div>

  <div class="panel" style="margin-top:10px;">
    <div style="font-weight:800; margin-bottom:8px;">Supplements ausw√§hlen</div>
    <div class="small muted">‚úî ankreuzen = in deinen Plan √ºbernehmen</div>
    <div id="suppCatalog" style="margin-top:10px;"></div>

    <div style="margin-top:14px;">
      <div style="font-weight:800; margin-bottom:8px;">Eigenes Supplement hinzuf√ºgen</div>
      <div class="row" style="gap:8px;">
        <input id="addSuppInput" placeholder="z.B. Zink 15mg" style="flex:1; min-width:200px;">
        <button id="addSuppBtn" style="white-space:nowrap;">Hinzuf√ºgen</button>
      </div>
      <div class="small muted" style="margin-top:8px;">Eigene Supplements werden gespeichert (Archiv) und k√∂nnen sp√§ter entfernt werden.</div>
    </div>

    <div style="margin-top:14px;">
      <div style="font-weight:800; margin-bottom:8px;">Aktiv im Plan</div>
      <div id="suppActivePills" class="row"></div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <h3 style="margin-bottom:6px;">Wochentracker (Mo‚ÄìSo)</h3>
    <div class="small muted">Hier hake ich pro Tag ab.</div>
    <div id="suppDays"></div>
  </div>
</div>

<div class="card">
  <h3>üèãÔ∏è Sport ‚Äì mehrere Sessions pro Tag</h3>
  <div class="small">Joggen: Pace = <b>Minuten pro Kilometer</b> (Format <b>mm:ss</b> pro km, z.B. 5:30).</div>
  <div id="sportDays"></div>
</div>

<div class="card">
  <h3>üìö Lesen ‚Äì Wochenplan</h3>
  <div class="small">Pro Tag: Titel + Seiten + Minuten + ‚ÄûBuch fertig‚Äú.</div>

  <div style="overflow:auto; margin-top:10px;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="width:120px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Tag</th>
          <th style="text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Titel</th>
          <th style="width:130px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Seiten</th>
          <th style="width:130px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Minuten</th>
          <th style="width:130px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Buch fertig</th>
        </tr>
      </thead>
      <tbody id="readBody"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  // ===================== STORAGE KEYS =====================
  const WEEK_PREFIX = "op_week_v6_";
  const NAMAZ_KEY = "op_namaz_v1";
  const FINISHED_BOOKS_KEY = "op_books_finished_v1";
  const PLANNER_NAME_KEY = "op_planner_name_v1";
  const SUPP_CONFIG_KEY = "op_supp_config_v2"; 
  // { custom:[{id,text}], activeIds:[id...] }

  // ===================== CONSTANTS =====================
  const DAYS = [
    {key:"mon", label:"Montag"},
    {key:"tue", label:"Dienstag"},
    {key:"wed", label:"Mittwoch"},
    {key:"thu", label:"Donnerstag"},
    {key:"fri", label:"Freitag"},
    {key:"sat", label:"Samstag"},
    {key:"sun", label:"Sonntag"},
  ];

  // Katalog (bleibt vorhanden), aber NICHT automatisch aktiv
  const SUPP_CATALOG = [
    { id:"d3k2", text:"Vitamin D3 / K2 (pro 10kg ‚Äì 1000 IE)" },
    { id:"omega3", text:"Omega 3 ‚Äì 4 Kapseln" },
    { id:"kurkuma", text:"Kurkuma + Piperin ‚Äì 4 Kapseln" },
    { id:"cellagon", text:"Cellagon Multivitamin ‚Äì 25 ml" },
    { id:"magnesium", text:"Magnesiumkapseln" },
    { id:"granatapfel", text:"Granatapfelsaft ‚Äì 300‚Äì400 ml" },
  ];

  const SPORTS = ["", "Krafttraining", "Joggen", "Stretching", "Ringen", "Schwimmen", "Tennis"];

  const NAMAZ_PRAYERS = [
    { id:"sabach", label:"Sabach" },
    { id:"ogle", label:"√ñƒüle" },
    { id:"ikindi", label:"ƒ∞kindi" },
    { id:"aksam", label:"Ak≈üam" },
    { id:"yatsi", label:"Yatsƒ±" },
  ];

  // ===================== HELPERS =====================
  const pad2 = n => String(n).padStart(2,"0");

  function lsGet(key, fallback){
    try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch { return fallback; }
  }
  function lsSet(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function startOfWeekMonday(date){
    const d = new Date(date);
    const day = d.getDay(); // Sun=0
    const diff = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function fmtDate(d){ return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`; }
  function weekKey(monday){ return `${monday.getFullYear()}-${pad2(monday.getMonth()+1)}-${pad2(monday.getDate())}`; }
  function isoDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function parseIso(iso){ const [y,m,da] = iso.split("-").map(Number); return new Date(y, m-1, da); }

  function parsePaceToSeconds(paceStr){
    if (!paceStr || !paceStr.includes(":")) return null;
    const [m,s] = paceStr.split(":").map(Number);
    if (!Number.isFinite(m) || !Number.isFinite(s)) return null;
    return m*60 + s;
  }
  function secondsToPace(sec){
    const m = Math.floor(sec/60);
    const s = Math.round(sec%60);
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function chip(value, label){
    return `<div class="chip"><div class="v">${value}</div><div class="l">${label}</div></div>`;
  }

  function safeId(){
    return "c_" + Math.random().toString(36).slice(2,10);
  }

  // ===================== PLANNER NAME =====================
  const plannerTitleEl = document.getElementById("plannerTitle");
  const plannerNameInput = document.getElementById("plannerNameInput");
  const savePlannerNameBtn = document.getElementById("savePlannerName");

  function loadPlannerName(){
    const name = lsGet(PLANNER_NAME_KEY, "");
    if (typeof name === "string" && name.trim()){
      plannerTitleEl.textContent = name.trim();
      plannerNameInput.value = name.trim();
    } else {
      plannerTitleEl.textContent = "Routine Planner";
      plannerNameInput.value = "";
    }
  }

  function savePlannerName(){
    const name = (plannerNameInput.value || "").trim();
    lsSet(PLANNER_NAME_KEY, name);
    plannerTitleEl.textContent = name || "Routine Planner";
  }

  savePlannerNameBtn.addEventListener("click", savePlannerName);

  // ===================== SUPPLEMENT CONFIG =====================
  // activeIds: welche Supplements √ºberhaupt im Wochen-Tracker erscheinen
  // custom: eigene Supplements
  let suppCfg = lsGet(SUPP_CONFIG_KEY, { custom: [], activeIds: [] });

  function normalizeSuppText(t){
    return (t || "").trim().replace(/\s+/g, " ");
  }

  function allSuppOptions(){
    const custom = (suppCfg.custom || []).map(x => ({ id:x.id, text:x.text, custom:true }));
    return [...SUPP_CATALOG.map(x => ({...x, custom:false})), ...custom];
  }

  function isActiveSupp(id){
    return Array.isArray(suppCfg.activeIds) && suppCfg.activeIds.includes(id);
  }

  function setActiveSupp(id, active){
    suppCfg.activeIds = Array.isArray(suppCfg.activeIds) ? suppCfg.activeIds : [];
    const has = suppCfg.activeIds.includes(id);
    if (active && !has) suppCfg.activeIds.push(id);
    if (!active && has) suppCfg.activeIds = suppCfg.activeIds.filter(x => x !== id);
    lsSet(SUPP_CONFIG_KEY, suppCfg);
  }

  function addCustomSupp(text){
    const clean = normalizeSuppText(text);
    if (!clean) return;

    const exists = allSuppOptions().some(s => s.text.toLowerCase() === clean.toLowerCase());
    if (exists) return;

    const id = safeId();
    suppCfg.custom = Array.isArray(suppCfg.custom) ? suppCfg.custom : [];
    suppCfg.custom.push({ id, text: clean });
    lsSet(SUPP_CONFIG_KEY, suppCfg);
  }

  function removeCustomSupp(id){
    suppCfg.custom = Array.isArray(suppCfg.custom) ? suppCfg.custom : [];
    suppCfg.custom = suppCfg.custom.filter(x => x.id !== id);
    // auch aus active entfernen
    setActiveSupp(id, false);
    lsSet(SUPP_CONFIG_KEY, suppCfg);
  }

  // ===================== WEEK DATA =====================
  let currentMonday = startOfWeekMonday(new Date());
  const weekLabelEl = document.getElementById("weekLabel");

  function weekStorageKey(){ return WEEK_PREFIX + weekKey(currentMonday); }

  function emptyWeek(){
    const supplements = Object.fromEntries(DAYS.map(d => [d.key, { note:"", items:{} }]));
    const sport = Object.fromEntries(DAYS.map(d => [d.key, { sessions: [] }]));
    const reading = Object.fromEntries(DAYS.map(d => [d.key, { title:"", pages:"", minutes:"", finished:false }]));
    return { supplements, sport, reading };
  }

  let weekData = lsGet(weekStorageKey(), emptyWeek());
  function saveWeek(){ lsSet(weekStorageKey(), weekData); }

  function renderWeekLabel(){
    const end = new Date(currentMonday); end.setDate(end.getDate()+6);
    weekLabelEl.textContent = `${fmtDate(currentMonday)} ‚Äì ${fmtDate(end)}`;
  }

  function listAllWeeks(){
    const keys = Object.keys(localStorage).filter(k => k.startsWith(WEEK_PREFIX));
    return keys.map(k => ({ key:k, data: lsGet(k, null) })).filter(x => x.data && typeof x.data === "object");
  }

  // ===================== FINISHED BOOKS =====================
  let finishedBooks = lsGet(FINISHED_BOOKS_KEY, []);
  const finishedBooksListEl = document.getElementById("finishedBooksList");

  function saveFinishedBooks(){ lsSet(FINISHED_BOOKS_KEY, finishedBooks); }

  function addFinishedBookOnce(title){
    const clean = (title || "").trim().replace(/\s+/g, " ");
    if (!clean) return;
    const exists = finishedBooks.some(b => (b.title||"").toLowerCase() === clean.toLowerCase());
    if (exists) return;
    finishedBooks.push({ title: clean, isoFinished: isoDate(new Date()) });
    saveFinishedBooks();
  }

  function renderFinishedBooksList(){
    finishedBooksListEl.innerHTML = "";
    if (!finishedBooks.length){
      const li = document.createElement("li");
      li.className = "small muted";
      li.textContent = "Noch keine fertigen B√ºcher.";
      finishedBooksListEl.appendChild(li);
      return;
    }
    finishedBooks
      .slice()
      .sort((a,b) => (a.isoFinished||"").localeCompare(b.isoFinished||""))
      .forEach(b => {
        const li = document.createElement("li");
        li.textContent = `${b.title} (${b.isoFinished})`;
        finishedBooksListEl.appendChild(li);
      });
  }

  document.getElementById("clearFinishedBooks").addEventListener("click", () => {
    finishedBooks = [];
    saveFinishedBooks();
    renderFinishedBooksList();
    renderDashboard();
  });

  // ===================== SUPPLEMENTS UI =====================
  const suppCatalogEl = document.getElementById("suppCatalog");
  const addSuppInput = document.getElementById("addSuppInput");
  const addSuppBtn = document.getElementById("addSuppBtn");
  const suppActivePillsEl = document.getElementById("suppActivePills");
  const suppDaysEl = document.getElementById("suppDays");

  function renderSuppCatalog(){
    suppCatalogEl.innerHTML = "";
    const opts = allSuppOptions();

    opts.forEach(s => {
      const row = document.createElement("div");
      row.className = "checkRow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = isActiveSupp(s.id);

      cb.addEventListener("change", () => {
        setActiveSupp(s.id, cb.checked);
        // sicherstellen, dass weekData.items existieren
        DAYS.forEach(d => {
          weekData.supplements[d.key].items[s.id] = weekData.supplements[d.key].items[s.id] || false;
        });
        saveWeek();
        renderSuppActivePills();
        renderSuppDays();
        renderDashboard();
      });

      const label = document.createElement("label");
      label.textContent = s.text + (s.custom ? " (custom)" : "");

      row.appendChild(cb);
      row.appendChild(label);

      // Delete button for custom items
      if (s.custom){
        const del = document.createElement("button");
        del.className = "miniBtn danger";
        del.textContent = "Entfernen";
        del.addEventListener("click", () => {
          removeCustomSupp(s.id);
          renderSuppCatalog();
          renderSuppActivePills();
          renderSuppDays();
          renderDashboard();
        });
        row.appendChild(del);
      }

      suppCatalogEl.appendChild(row);
    });
  }

  addSuppBtn.addEventListener("click", () => {
    addCustomSupp(addSuppInput.value);
    addSuppInput.value = "";
    renderSuppCatalog();
  });

  function renderSuppActivePills(){
    suppActivePillsEl.innerHTML = "";
    const active = (suppCfg.activeIds || []);
    if (!active.length){
      const span = document.createElement("span");
      span.className = "small muted";
      span.textContent = "Noch keine Supplements aktiv. W√§hle oben welche aus.";
      suppActivePillsEl.appendChild(span);
      return;
    }

    const opts = allSuppOptions();
    active.forEach(id => {
      const s = opts.find(o => o.id === id);
      if (!s) return;

      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = s.text;

      const x = document.createElement("button");
      x.className = "miniBtn danger";
      x.textContent = "√ó";
      x.addEventListener("click", () => {
        setActiveSupp(id, false);
        renderSuppCatalog();
        renderSuppActivePills();
        renderSuppDays();
        renderDashboard();
      });

      pill.appendChild(x);
      suppActivePillsEl.appendChild(pill);
    });
  }

  function renderSuppDays(){
    suppDaysEl.innerHTML = "";

    const activeIds = (suppCfg.activeIds || []);
    if (!activeIds.length){
      const msg = document.createElement("div");
      msg.className = "small muted";
      msg.style.marginTop = "8px";
      msg.textContent = "Aktiviere oben Supplements, damit hier der Wochen-Tracker erscheint.";
      suppDaysEl.appendChild(msg);
      return;
    }

    const opts = allSuppOptions();

    DAYS.forEach(d => {
      if (!weekData.supplements[d.key]){
        weekData.supplements[d.key] = { note:"", items:{} };
      }
      // ensure keys exist
      activeIds.forEach(id => {
        if (typeof weekData.supplements[d.key].items[id] !== "boolean"){
          weekData.supplements[d.key].items[id] = false;
        }
      });

      const block = document.createElement("div");
      block.className = "suppDayBlock";

      const header = document.createElement("div");
      header.className = "suppHeader";
      header.innerHTML = `<div class="dayTitle">${d.label}</div>`;
      block.appendChild(header);

      const list = document.createElement("div");
      list.className = "suppList";

      activeIds.forEach(id => {
        const s = opts.find(o => o.id === id);
        if (!s) return;

        const row = document.createElement("div");
        row.className = "checkRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!weekData.supplements[d.key].items[id];
        cb.addEventListener("change", () => {
          weekData.supplements[d.key].items[id] = cb.checked;
          saveWeek();
          renderDashboard();
        });

        const label = document.createElement("label");
        label.textContent = s.text;

        row.appendChild(cb);
        row.appendChild(label);
        list.appendChild(row);
      });

      const note = document.createElement("input");
      note.placeholder = "Notiz (optional)";
      note.value = weekData.supplements[d.key].note || "";
      note.addEventListener("input", () => {
        weekData.supplements[d.key].note = note.value;
        saveWeek();
      });

      block.appendChild(list);
      block.appendChild(document.createElement("div")).style.height = "8px";
      block.appendChild(note);

      suppDaysEl.appendChild(block);
    });

    saveWeek();
  }

  // ===================== SPORT (MULTI) =====================
  const sportDaysEl = document.getElementById("sportDays");

  function newSession(){
    return { type:"", minutes:"", calories:"", km:"", pace:"", note:"" };
  }

  function renderSportMulti(){
    sportDaysEl.innerHTML = "";

    DAYS.forEach(d => {
      if (!weekData.sport[d.key] || !Array.isArray(weekData.sport[d.key].sessions)){
        weekData.sport[d.key] = { sessions: [] };
      }

      const block = document.createElement("div");
      block.className = "dayBlock";

      const header = document.createElement("div");
      header.className = "dayHeader";
      header.innerHTML = `<div class="dayTitle">${d.label}</div>`;

      const addBtn = document.createElement("button");
      addBtn.className = "miniBtn";
      addBtn.textContent = "+ Session hinzuf√ºgen";
      addBtn.addEventListener("click", () => {
        weekData.sport[d.key].sessions.push(newSession());
        saveWeek();
        renderSportMulti();
        renderDashboard();
      });

      header.appendChild(addBtn);
      block.appendChild(header);

      const sessionsWrap = document.createElement("div");
      sessionsWrap.className = "sessions";

      const sessions = weekData.sport[d.key].sessions;

      if (sessions.length === 0){
        const empty = document.createElement("div");
        empty.className = "small muted";
        empty.textContent = "Keine Sport-Session eingetragen.";
        empty.style.marginTop = "8px";
        block.appendChild(empty);
      } else {
        sessions.forEach((sess, idx) => {
          const card = document.createElement("div");
          card.className = "session";

          const grid = document.createElement("div");
          grid.className = "sessionGrid";

          const sel = document.createElement("select");
          SPORTS.forEach(opt => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt === "" ? "‚Äî Sport ‚Äî" : opt;
            sel.appendChild(o);
          });
          sel.value = sess.type || "";

          const inpMin = document.createElement("input");
          inpMin.type = "number";
          inpMin.min = "0";
          inpMin.placeholder = "Dauer (min)";
          inpMin.value = sess.minutes ?? "";

          const inpCal = document.createElement("input");
          inpCal.type = "number";
          inpCal.min = "0";
          inpCal.placeholder = "Kalorien";
          inpCal.value = sess.calories ?? "";

          const inpKm = document.createElement("input");
          inpKm.type = "number";
          inpKm.min = "0";
          inpKm.step = "0.1";
          inpKm.placeholder = "KM (nur Joggen)";
          inpKm.value = sess.km ?? "";

          const inpPace = document.createElement("input");
          inpPace.placeholder = "Pace (mm:ss / km)";
          inpPace.value = sess.pace ?? "";

          const inpNote = document.createElement("input");
          inpNote.placeholder = "Notiz";
          inpNote.value = sess.note ?? "";

          const actions = document.createElement("div");
          actions.className = "sessionActions";

          const del = document.createElement("button");
          del.className = "miniBtn danger";
          del.textContent = "L√∂schen";
          del.addEventListener("click", () => {
            weekData.sport[d.key].sessions.splice(idx, 1);
            saveWeek();
            renderSportMulti();
            renderDashboard();
          });
          actions.appendChild(del);

          function updateJog(){
            const isJog = sel.value === "Joggen";
            inpKm.disabled = !isJog;
            inpPace.disabled = !isJog;
            inpKm.classList.toggle("disabledLook", !isJog);
            inpPace.classList.toggle("disabledLook", !isJog);
          }

          function persist(){
            weekData.sport[d.key].sessions[idx] = {
              type: sel.value,
              minutes: inpMin.value,
              calories: inpCal.value,
              km: inpKm.value,
              pace: inpPace.value,
              note: inpNote.value
            };
            saveWeek();
            updateJog();
            renderDashboard();
          }

          [sel, inpMin, inpCal, inpKm, inpPace, inpNote].forEach(el => el.addEventListener("input", persist));
          sel.addEventListener("change", persist);

          updateJog();

          grid.appendChild(sel);
          grid.appendChild(inpMin);
          grid.appendChild(inpCal);
          grid.appendChild(inpKm);
          grid.appendChild(inpPace);
          grid.appendChild(inpNote);
          grid.appendChild(actions);

          card.appendChild(grid);
          sessionsWrap.appendChild(card);
        });

        block.appendChild(sessionsWrap);
      }

      sportDaysEl.appendChild(block);
    });

    saveWeek();
  }

  // ===================== READING (WEEK) =====================
  const readBody = document.getElementById("readBody");

  function renderReading(){
    readBody.innerHTML = "";

    DAYS.forEach(d => {
      const tr = document.createElement("tr");
      const r = weekData.reading[d.key] || (weekData.reading[d.key] = { title:"", pages:"", minutes:"", finished:false });

      function tdBase(){
        const td = document.createElement("td");
        td.style.padding="8px";
        td.style.borderBottom="1px solid var(--line)";
        return td;
      }

      const tdDay = tdBase();
      tdDay.textContent = d.label;

      const tdTitle = tdBase();
      const inpTitle = document.createElement("input");
      inpTitle.placeholder="Buchtitel";
      inpTitle.value = r.title ?? "";
      tdTitle.appendChild(inpTitle);

      const tdPages = tdBase();
      const inpPages = document.createElement("input");
      inpPages.type="number"; inpPages.min="0"; inpPages.placeholder="Seiten";
      inpPages.value = r.pages ?? "";
      tdPages.appendChild(inpPages);

      const tdMin = tdBase();
      const inpMin = document.createElement("input");
      inpMin.type="number"; inpMin.min="0"; inpMin.placeholder="Minuten";
      inpMin.value = r.minutes ?? "";
      tdMin.appendChild(inpMin);

      const tdDone = tdBase();
      const cbDone = document.createElement("input");
      cbDone.type="checkbox";
      cbDone.checked = !!r.finished;
      tdDone.appendChild(cbDone);

      function persist(){
        weekData.reading[d.key] = {
          title: inpTitle.value,
          pages: inpPages.value,
          minutes: inpMin.value,
          finished: cbDone.checked
        };
        saveWeek();

        if (cbDone.checked){
          addFinishedBookOnce(inpTitle.value);
          renderFinishedBooksList();
        }
        renderDashboard();
      }

      [inpTitle, inpPages, inpMin].forEach(el => el.addEventListener("input", persist));
      cbDone.addEventListener("change", persist);

      tr.appendChild(tdDay);
      tr.appendChild(tdTitle);
      tr.appendChild(tdPages);
      tr.appendChild(tdMin);
      tr.appendChild(tdDone);
      readBody.appendChild(tr);
    });

    saveWeek();
  }

  // ===================== NAMAZ DB =====================
  let namazDB = lsGet(NAMAZ_KEY, {});

  function ensureNamazDay(iso){
    if (!namazDB[iso]){
      namazDB[iso] = { sabach:false, ogle:false, ikindi:false, aksam:false, yatsi:false, note:"" };
    } else {
      NAMAZ_PRAYERS.forEach(p => {
        if (typeof namazDB[iso][p.id] !== "boolean") namazDB[iso][p.id] = !!namazDB[iso][p.id];
      });
      if (typeof namazDB[iso].note !== "string") namazDB[iso].note = "";
    }
  }

  function saveNamaz(){ lsSet(NAMAZ_KEY, namazDB); }

  function countNamazTotals(){
    let perPrayer = Object.fromEntries(NAMAZ_PRAYERS.map(p => [p.id, 0]));
    let fullDays = 0;
    const minDate = new Date(2000,0,1);

    Object.keys(namazDB).forEach(k => {
      const d = parseIso(k);
      if (d < minDate) return;

      const day = namazDB[k];
      let all5 = true;

      NAMAZ_PRAYERS.forEach(p => {
        if (day[p.id]) perPrayer[p.id]++;
        if (!day[p.id]) all5 = false;
      });

      if (all5) fullDays++;
    });

    return { perPrayer, fullDays, years: fullDays/365 };
  }

  // ===================== NAMAZ UI =====================
  const calEl = document.getElementById("calendar");
  const calLabelEl = document.getElementById("calLabel");
  const selDateLabelEl = document.getElementById("selDateLabel");
  const namazFormEl = document.getElementById("namazForm");
  const namazNoteEl = document.getElementById("namazNote");
  const jumpDateEl = document.getElementById("jumpDate");
  const namazTotalsEl = document.getElementById("namazTotals");

  let calMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let selectedIso = isoDate(new Date());

  jumpDateEl.min = "2000-01-01";
  jumpDateEl.max = "2099-12-31";
  jumpDateEl.value = selectedIso;

  function dayStatusBadge(iso){
    ensureNamazDay(iso);
    const day = namazDB[iso];
    let count = 0;
    NAMAZ_PRAYERS.forEach(p => { if (day[p.id]) count++; });

    if (count === 5) return { txt:"5/5", cls:"ok" };
    if (count === 0) return { txt:"0/5", cls:"bad" };
    return { txt:`${count}/5`, cls:"warn" };
  }

  function renderNamazTotals(){
    const t = countNamazTotals();
    namazTotalsEl.innerHTML = "";
    namazTotalsEl.innerHTML = `
      <div class="chipGrid">
        ${chip(t.perPrayer.sabach, "Sabach")}
        ${chip(t.perPrayer.ogle, "√ñƒüle")}
        ${chip(t.perPrayer.ikindi, "ƒ∞kindi")}
        ${chip(t.perPrayer.aksam, "Ak≈üam")}
        ${chip(t.perPrayer.yatsi, "Yatsƒ±")}
        ${chip(t.fullDays, "Tage komplett (5/5)")}
        ${chip(t.years.toFixed(2), "Jahre (‚âà/365)")}
        ${chip("üôè", "Kontinuit√§t")}
      </div>
    `;
  }

  function selectNamazDate(iso, silent=false){
    const min = new Date(2000,0,1);
    if (parseIso(iso) < min) return;

    selectedIso = iso;
    jumpDateEl.value = iso;

    ensureNamazDay(iso);
    const day = namazDB[iso];

    selDateLabelEl.textContent = iso;
    namazFormEl.innerHTML = "";

    NAMAZ_PRAYERS.forEach(p => {
      const row = document.createElement("div");
      row.className = "checkRow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!day[p.id];

      cb.addEventListener("change", () => {
        day[p.id] = cb.checked;
        saveNamaz();
        renderNamazTotals();
        renderDashboard();
        renderCalendar();
      });

      const label = document.createElement("label");
      label.textContent = p.label;

      row.appendChild(cb);
      row.appendChild(label);
      namazFormEl.appendChild(row);
    });

    namazNoteEl.value = day.note || "";
    namazNoteEl.oninput = () => {
      day.note = namazNoteEl.value;
      saveNamaz();
    };

    if (!silent) renderCalendar();
  }

  function renderCalendar(){
    const y = calMonth.getFullYear();
    const m = calMonth.getMonth();

    const monthNames = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
    calLabelEl.textContent = `${monthNames[m]} ${y}`;

    const first = new Date(y, m, 1);
    const last = new Date(y, m+1, 0);
    const daysInMonth = last.getDate();

    const jsDay = first.getDay(); // Sun=0
    const offset = (jsDay === 0 ? 6 : jsDay - 1); // Mon=0

    const headers = ["Mo","Di","Mi","Do","Fr","Sa","So"];
    let html = "<thead><tr>" + headers.map(h => `<th style="color:var(--muted); font-weight:600;">${h}</th>`).join("") + "</tr></thead><tbody>";

    let dayNum = 1 - offset;
    for (let row=0; row<6; row++){
      html += "<tr>";
      for (let col=0; col<7; col++){
        if (dayNum < 1 || dayNum > daysInMonth){
          html += `<td style="background:#070707; color:#333;">&nbsp;</td>`;
        } else {
          const d = new Date(y, m, dayNum);
          const min = new Date(2000,0,1);
          const disabled = d < min;
          const iso = isoDate(d);

          const badge = !disabled ? dayStatusBadge(iso) : {txt:"", cls:""};
          const isSel = iso === selectedIso;

          html += `<td style="background:${isSel ? "#111" : "#0b0b0b"};">
            <button class="calDayBtn" data-iso="${iso}" ${disabled ? "disabled style='opacity:.25; cursor:not-allowed;'" : ""}>
              <div style="font-weight:700;">${dayNum}
                ${!disabled ? `<span class="badge ${badge.cls}">${badge.txt}</span>` : ""}
              </div>
              <div class="small muted" style="margin-top:4px;">${iso}</div>
            </button>
          </td>`;
        }
        dayNum++;
      }
      html += "</tr>";
    }
    html += "</tbody>";
    calEl.innerHTML = html;

    calEl.querySelectorAll("button[data-iso]").forEach(btn => {
      btn.addEventListener("click", () => selectNamazDate(btn.getAttribute("data-iso")));
    });

    selectNamazDate(selectedIso, true);
  }

  // ===================== DASHBOARD RENDER =====================
  function countThisWeek(){
    let sportMinutes = 0;
    let sportCalories = 0;
    let jogKm = 0;
    let jogPaceWeighted = 0;

    let readMinutes = 0;
    let readPages = 0;
    let finishedBooksWeek = 0;

    // Supplements: wie viele aktive items abgehakt
    let suppChecked = 0;

    DAYS.forEach(d => {
      // sport
      const sessions = weekData.sport?.[d.key]?.sessions || [];
      sessions.forEach(s => {
        sportMinutes += Number(s.minutes || 0);
        sportCalories += Number(s.calories || 0);

        if (s.type === "Joggen"){
          const km = Number(s.km || 0);
          const ps = parsePaceToSeconds(s.pace);
          if (km > 0){
            jogKm += km;
            if (ps != null) jogPaceWeighted += ps * km;
          }
        }
      });

      // reading
      const r = weekData.reading?.[d.key];
      if (r){
        readMinutes += Number(r.minutes || 0);
        readPages += Number(r.pages || 0);
        if (r.finished) finishedBooksWeek++;
      }

      // supplements
      const items = weekData.supplements?.[d.key]?.items || {};
      (suppCfg.activeIds || []).forEach(id => {
        if (items[id]) suppChecked++;
      });
    });

    const avgPace = (jogKm > 0 && jogPaceWeighted > 0) ? secondsToPace(jogPaceWeighted / jogKm) : "‚Äì";

    return {
      sportMinutes, sportCalories,
      jogKm: Number(jogKm.toFixed(1)),
      avgPace,
      readMinutes, readPages, finishedBooksWeek,
      suppChecked
    };
  }

  function aggregateTotals(){
    let sportMinutes = 0;
    let sportCalories = 0;
    let jogKm = 0;
    let jogPaceWeighted = 0;

    let readMinutesTotal = 0;
    let readPagesTotal = 0;

    listAllWeeks().forEach(w => {
      const sport = w.data.sport || {};
      const reading = w.data.reading || {};

      DAYS.forEach(d => {
        const sessions = sport[d.key]?.sessions || [];
        sessions.forEach(s => {
          sportMinutes += Number(s.minutes || 0);
          sportCalories += Number(s.calories || 0);
          if (s.type === "Joggen"){
            const km = Number(s.km || 0);
            const ps = parsePaceToSeconds(s.pace);
            if (km > 0){
              jogKm += km;
              if (ps != null) jogPaceWeighted += ps * km;
            }
          }
        });

        const r = reading[d.key];
        if (r){
          readMinutesTotal += Number(r.minutes || 0);
          readPagesTotal += Number(r.pages || 0);
        }
      });
    });

    const avgPace = (jogKm > 0 && jogPaceWeighted > 0) ? secondsToPace(jogPaceWeighted / jogKm) : "‚Äì";

    return {
      sportMinutes, sportCalories,
      jogKm: Number(jogKm.toFixed(1)),
      avgPace,
      readMinutesTotal,
      readPagesTotal
    };
  }

  function renderDashboard(){
    const w = countThisWeek();
    const t = aggregateTotals();
    const n = countNamazTotals();

    // Sport
    document.getElementById("dashSport").innerHTML = `
      <div class="chipGrid">
        ${chip(w.sportMinutes, "Minuten (Woche)")}
        ${chip(w.sportCalories, "Kalorien (Woche)")}
        ${chip(w.jogKm, "Joggen KM (Woche)")}
        ${chip(w.avgPace, "√ò Pace (Woche)")}
      </div>
      <div class="chipGrid" style="margin-top:10px;">
        ${chip(t.sportMinutes, "Minuten (gesamt)")}
        ${chip(t.sportCalories, "Kalorien (gesamt)")}
        ${chip(t.jogKm, "Joggen KM (gesamt)")}
        ${chip(t.avgPace, "√ò Pace (gesamt)")}
      </div>
    `;

    // Lesen
    document.getElementById("dashReading").innerHTML = `
      <div class="chipGrid">
        ${chip(w.readMinutes, "Leseminuten (Woche)")}
        ${chip(w.readPages, "Seiten (Woche)")}
        ${chip(w.finishedBooksWeek, "B√ºcher fertig (Woche)")}
        ${chip(w.suppChecked, "Supp. H√§kchen (Woche)")}
      </div>
      <div class="chipGrid" style="margin-top:10px;">
        ${chip(t.readMinutesTotal, "Leseminuten (gesamt)")}
        ${chip(t.readPagesTotal, "Seiten (gesamt)")}
        ${chip(finishedBooks.length, "B√ºcher fertig (gesamt)")}
        ${chip("‚úì", "Dranbleiben")}
      </div>
    `;

    // Namaz
    const totalNamaz =
      n.perPrayer.sabach + n.perPrayer.ogle + n.perPrayer.ikindi + n.perPrayer.aksam + n.perPrayer.yatsi;

    document.getElementById("dashNamaz").innerHTML = `
      <div class="chipGrid">
        ${chip(totalNamaz, "Gebete gesamt")}
        ${chip(n.fullDays, "Tage komplett (5/5)")}
        ${chip(n.years.toFixed(2), "Jahre (‚âà/365)")}
        ${chip(n.perPrayer.sabach, "Sabach")}
      </div>
      <div class="chipGrid" style="margin-top:10px;">
        ${chip(n.perPrayer.ogle, "√ñƒüle")}
        ${chip(n.perPrayer.ikindi, "ƒ∞kindi")}
        ${chip(n.perPrayer.aksam, "Ak≈üam")}
        ${chip(n.perPrayer.yatsi, "Yatsƒ±")}
      </div>
    `;
  }

  // ===================== NAV BUTTONS / EVENTS =====================
  document.getElementById("prevWeek").addEventListener("click", () => {
    currentMonday.setDate(currentMonday.getDate() - 7);
    weekData = lsGet(weekStorageKey(), emptyWeek());
    rerenderWeek();
  });
  document.getElementById("nextWeek").addEventListener("click", () => {
    currentMonday.setDate(currentMonday.getDate() + 7);
    weekData = lsGet(weekStorageKey(), emptyWeek());
    rerenderWeek();
  });
  document.getElementById("todayWeek").addEventListener("click", () => {
    currentMonday = startOfWeekMonday(new Date());
    weekData = lsGet(weekStorageKey(), emptyWeek());
    rerenderWeek();
  });
  document.getElementById("resetWeek").addEventListener("click", () => {
    localStorage.removeItem(weekStorageKey());
    weekData = emptyWeek();
    saveWeek();
    rerenderWeek();
  });

  document.getElementById("refreshDash").addEventListener("click", () => {
    renderDashboard();
    renderFinishedBooksList();
    renderSuppCatalog();
    renderSuppActivePills();
    renderSuppDays();
    renderNamazTotals();
  });

  // Namaz controls
  document.getElementById("calPrev").addEventListener("click", () => {
    calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1);
    renderCalendar();
  });
  document.getElementById("calNext").addEventListener("click", () => {
    calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1);
    renderCalendar();
  });
  document.getElementById("calToday").addEventListener("click", () => {
    const t = new Date();
    calMonth = new Date(t.getFullYear(), t.getMonth(), 1);
    selectNamazDate(isoDate(t));
    renderCalendar();
  });
  document.getElementById("jumpBtn").addEventListener("click", () => {
    const iso = jumpDateEl.value;
    if (!iso) return;
    const d = parseIso(iso);
    calMonth = new Date(d.getFullYear(), d.getMonth(), 1);
    selectNamazDate(iso);
    renderCalendar();
  });
  document.getElementById("clearDay").addEventListener("click", () => {
    ensureNamazDay(selectedIso);
    NAMAZ_PRAYERS.forEach(p => namazDB[selectedIso][p.id] = false);
    namazDB[selectedIso].note = "";
    saveNamaz();
    selectNamazDate(selectedIso, true);
    renderNamazTotals();
    renderDashboard();
    renderCalendar();
  });
  document.getElementById("closeDay").addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  function rerenderWeek(){
    renderWeekLabel();
    renderSuppCatalog();
    renderSuppActivePills();
    renderSuppDays();
    renderSportMulti();
    renderReading();
    renderFinishedBooksList();
    renderNamazTotals();
    renderDashboard();
  }
    // ===================== READING / SPORT / NAMAZ / SUPP INIT HELPERS =====================

  // Reading table exists already in HTML; we already render it in renderReading()
  // Sport multi exists already in HTML; we already render it in renderSportMulti()
  // Supplements selector + weekly tracker exists already
  // Namaz calendar + day editor exists already

  // ---------------- INIT NAMAZ DEFAULTS ----------------
  ensureNamazDay(selectedIso);
  saveNamaz();

  // ---------------- FIRST RENDER ----------------
  function initAll(){
    loadPlannerName();
    renderWeekLabel();

    // Supplements UI
    renderSuppCatalog();
    renderSuppActivePills();
    renderSuppDays();

    // Sport + Reading
    renderSportMulti();
    renderReading();

    // Finished books + Namaz
    renderFinishedBooksList();
    renderNamazTotals();
    renderCalendar();

    // Dashboard overview
    renderDashboard();

    // Persist week after ensuring structures
    saveWeek();
  }

  initAll();

})();
</script>

</body>
</html>
