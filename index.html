<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#9a9a9a;
  --line:#262626;
  --panel:#0c0c0c;
  --panel2:#101010;
  --accent:#00ff6a;
  --danger:#ff5b5b;
}
*{box-sizing:border-box}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  max-width:1200px;
  margin:22px auto;
  padding:0 14px 60px;
}
h1{margin:0;font-size:30px;letter-spacing:-.2px}
h2{margin:4px 0 0;font-size:14px;color:var(--muted);font-weight:600}
h3{margin:0 0 10px;font-size:16px}
.small{font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}

.card{
  border:1px solid var(--line);
  background:var(--panel);
  border-radius:16px;
  padding:14px;
  margin-top:14px;
  overflow:hidden; /* verhindert Layout-Overflow */
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.grow{flex:1;min-width:220px}

input,select,textarea{
  width:100%;
  background:var(--panel2);
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:12px;
  padding:9px 10px;
}
button{
  border:1px solid var(--line);
  background:#111;
  color:var(--fg);
  border-radius:12px;
  padding:9px 12px;
  cursor:pointer;
}
button:hover{background:#151515}
.danger{color:var(--danger);border-color:#3a1a1a}

.tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.tab{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  cursor:pointer;
  user-select:none;
}
.tab.active{
  background:rgba(0,255,106,.15);
  color:var(--fg);
  border-color:#1b4f30;
}

.kpiGrid{
  display:grid;
  grid-template-columns:repeat(3,minmax(140px,1fr));
  gap:10px;
  margin-top:12px;
}
@media (max-width:900px){
  .kpiGrid{grid-template-columns:repeat(2,minmax(140px,1fr))}
}
.kpi{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:#0b0b0b;
}
.kpi .v{font-size:22px;font-weight:900;color:var(--accent);line-height:1.1}
.kpi .l{font-size:12px;color:var(--muted);margin-top:6px}

.dashGrid{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
}
.chartGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
@media (max-width:900px){
  .chartGrid{grid-template-columns:1fr}
}

.chartWrap{
  border:1px solid var(--line);
  border-radius:16px;
  background:#080808;
  padding:10px;
  overflow:hidden;
}
canvas{
  width:100%;
  height:260px;
  display:block;
  background:#080808;
  border-radius:12px;
}

/* Session Cards */
.sessionCard{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:#0b0b0b;
  margin-top:10px;
}
.sessionHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.sessionGrid{
  display:grid;
  grid-template-columns:repeat(6,minmax(140px,1fr));
  gap:10px;
  margin-top:10px;
}
@media (max-width:900px){
  .sessionGrid{grid-template-columns:1fr 1fr}
}

/* iOS file input fix */
.fileHidden{
  position:absolute;
  left:-9999px;
  width:1px;
  height:1px;
  opacity:0;
}
</style>

<!-- OCR Engine -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>

<!-- HEADER -->
<div class="card">
  <div class="row">
    <div class="grow">
      <h1 id="appTitle">Sport Tracker</h1>
      <h2>Multi-Sessions ¬∑ OCR ¬∑ Strichdiagramme ¬∑ Archiv</h2>
      <div class="small">Speichert lokal im Browser (bleibt, bis Website-Daten gel√∂scht werden).</div>
    </div>
    <div class="grow">
      <div class="small">Profilname</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay">
    </div>
    <button id="saveProfile">Speichern</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="card" id="dashboard">
  <h3>üìä Dashboard</h3>

  <div class="tabs">
    <div class="tab active" data-range="day">Tag</div>
    <div class="tab" data-range="week">Woche</div>
    <div class="tab" data-range="month">Monat</div>
    <div class="tab" data-range="year">Jahr</div>
    <div class="tab" data-range="all">Gesamt</div>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="focusDate" type="date" style="max-width:220px">
    <button id="todayBtn">Heute</button>
  </div>

  <div class="kpiGrid" id="kpiGrid"></div>

  <div class="chartGrid">
    <div class="chartWrap">
      <div class="small muted" style="margin-bottom:6px;">Kalorien pro Tag (Monatsansicht)</div>
      <canvas id="calorieChart"></canvas>
    </div>
    <div class="chartWrap">
      <div class="small muted" style="margin-bottom:6px;">Kilometer pro Tag (Joggen+Schwimmen)</div>
      <canvas id="kmChart"></canvas>
    </div>
  </div>
</div>

<script>
/* ===== BASIS STATE (nur 1x) ===== */
const KEY_DATA="sport_db_v2";
const KEY_PROFILE="sport_profile_v2";

let db = (()=>{ try{return JSON.parse(localStorage.getItem(KEY_DATA)||"{}");}catch{return{};} })();
let profile = localStorage.getItem(KEY_PROFILE)||"";

const $ = (id)=>document.getElementById(id);
const pad = (n)=>String(n).padStart(2,"0");
const iso = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

function saveDB(){ localStorage.setItem(KEY_DATA, JSON.stringify(db)); }

/* ===== Profile Init ===== */
$("profileName").value = profile;
$("appTitle").textContent = profile || "Sport Tracker";
$("saveProfile").onclick = ()=>{
  profile = $("profileName").value.trim();
  localStorage.setItem(KEY_PROFILE, profile);
  $("appTitle").textContent = profile || "Sport Tracker";
};

/* ===== Date Init ===== */
$("focusDate").value = iso(new Date());
$("todayBtn").onclick = ()=>{
  $("focusDate").value = iso(new Date());
  renderAll();
};

/* ===== Tabs ===== */
let activeRange="day";
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeRange=t.dataset.range;
    renderAll();
  };
});

/* ===== Placeholder KPI (wird in Teil 3 real) ===== */
function renderDashboardPlaceholder(){
  $("kpiGrid").innerHTML=`
    <div class="kpi"><div class="v">0</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">0</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">0.0</div><div class="l">Kilometer</div></div>
    <div class="kpi"><div class="v">‚Äì</div><div class="l">√ò Pace</div></div>
    <div class="kpi"><div class="v">‚Äì</div><div class="l">√ò HF</div></div>
    <div class="kpi"><div class="v">0</div><div class="l">Sessions</div></div>
  `;
}
renderDashboardPlaceholder();
</script>
<!-- ===================== SPORT SECTION ===================== -->
<div class="card" id="sportSection">
  <h3>üèãÔ∏è Sport Tracker (Multi-Sessions)</h3>
  <div class="small">Mehrere Sessions pro Tag. Kein Rausklicken beim Tippen.</div>

  <div class="row" style="margin-top:10px;">
    <div style="min-width:220px;">
      <div class="small">Datum</div>
      <input id="entryDate" type="date" />
    </div>

    <button id="addSessionBtn">+ Session</button>
    <button id="clearDayBtn" class="danger">Tag l√∂schen</button>
  </div>

  <!-- Screenshot Bereich -->
  <div class="row" style="margin-top:10px;">
    <button id="shotBtn">üì∑ Screenshot / Foto importieren</button>
    <div id="ocrStatus" class="small muted"></div>
    <input id="shotFile" class="fileHidden" type="file" accept="image/*">
  </div>

  <div class="small muted" style="margin-top:8px;">
    Joggen/Schwimmen: Dauer + KM + Pace + √ò HF. Andere: Dauer + Kalorien + √ò HF.
  </div>

  <div id="sessionList" style="margin-top:12px;"></div>
</div>

<script>
/* ===================== SPORT MODEL + UI ===================== */
const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

function getDay(dateIso){
  if(!Array.isArray(db[dateIso])) db[dateIso] = [];
  return db[dateIso];
}

// entryDate = focusDate
const entryDateInput = $("entryDate");
entryDateInput.value = $("focusDate").value;

// Buttons
$("addSessionBtn").onclick = ()=>{
  const d = entryDateInput.value;
  getDay(d).push({ time:"", type:"", duration:"", calories:"", km:"", pace:"", hr:"" });
  saveDB();
  renderSessions();
  renderAll();
};

$("clearDayBtn").onclick = ()=>{
  const d = entryDateInput.value;
  delete db[d];
  saveDB();
  renderSessions();
  renderAll();
};

entryDateInput.addEventListener("change", ()=>{
  renderSessions();
  renderAll();
});

function renderSessions(){
  const d = entryDateInput.value;
  const list = $("sessionList");
  const arr = getDay(d);

  if(!arr.length){
    list.innerHTML = `<div class="small muted">Noch keine Sessions an diesem Tag.</div>`;
    return;
  }

  list.innerHTML = arr.map((s,i)=>{
    const isKm = KM_SPORTS.has(s.type);
    return `
      <div class="sessionCard">
        <div class="sessionHeader">
          <strong>Session ${i+1}</strong>
          <button class="danger" data-del="${i}">L√∂schen</button>
        </div>

        <div class="sessionGrid">
          <div>
            <div class="small">Uhrzeit</div>
            <input data-i="${i}" data-k="time" placeholder="19:31" value="${s.time||""}">
          </div>

          <div>
            <div class="small">Sportart</div>
            <select data-i="${i}" data-k="type">
              <option value="">‚Äî</option>
              ${SPORTS.map(x=>`<option value="${x}" ${x===s.type?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>

          <div>
            <div class="small">Dauer (min)</div>
            <input data-i="${i}" data-k="duration" type="number" min="0" inputmode="numeric" value="${s.duration||""}">
          </div>

          <div>
            <div class="small">Kalorien</div>
            <input data-i="${i}" data-k="calories" type="number" min="0" inputmode="numeric" value="${s.calories||""}">
          </div>

          <div>
            <div class="small">Kilometer</div>
            <input data-i="${i}" data-k="km" type="number" min="0" step="0.01" inputmode="decimal"
              ${isKm ? "" : "disabled"} value="${s.km||""}">
          </div>

          <div>
            <div class="small">Pace (mm:ss)</div>
            <input data-i="${i}" data-k="pace" placeholder="5:30"
              ${isKm ? "" : "disabled"} value="${s.pace||""}">
          </div>

          <div>
            <div class="small">√ò HF</div>
            <input data-i="${i}" data-k="hr" type="number" min="0" inputmode="numeric" value="${s.hr||""}">
          </div>
        </div>
      </div>
    `;
  }).join("");

  attachSessionHandlers();
}

function attachSessionHandlers(){
  const d = entryDateInput.value;
  const list = $("sessionList");

  // delete
  list.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = Number(btn.dataset.del);
      const arr = getDay(d);
      arr.splice(i,1);
      if(!arr.length) delete db[d];
      saveDB();
      renderSessions();
      renderAll();
    };
  });

  // inputs + selects
  list.querySelectorAll("input[data-i], select[data-i]").forEach(el=>{
    const i = Number(el.dataset.i);
    const k = el.dataset.k;

    if(el.tagName === "SELECT"){
      el.onchange = ()=>{
        getDay(d)[i][k] = el.value;
        saveDB();
        // nur bei Sportart rerender (km/pace enable)
        renderSessions();
        renderAll();
      };
      return;
    }

    // wichtig: speichern ohne rerender -> Fokus bleibt
    el.addEventListener("input", ()=>{
      getDay(d)[i][k] = el.value;
      saveDB();
    });
  });
}

renderSessions();
</script>
<script>
/* ===================== DASHBOARD + CHARTS + OCR ===================== */

function safeNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function parsePace(p){
  if(!p || !p.includes(":")) return null;
  const [m,s] = p.split(":").map(Number);
  if(!Number.isFinite(m)||!Number.isFinite(s)||s<0||s>59||m<0) return null;
  return m*60+s;
}
function paceFromSeconds(sec){
  const t=Math.round(sec);
  return `${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
}

function inRange(dateIso, range){
  const d = new Date(dateIso);
  const f = new Date($("focusDate").value);

  if(range==="day") return dateIso === $("focusDate").value;
  if(range==="month") return d.getMonth()===f.getMonth() && d.getFullYear()===f.getFullYear();
  if(range==="year") return d.getFullYear()===f.getFullYear();
  if(range==="all") return true;

  if(range==="week"){
    const fd = new Date(f);
    const monday = new Date(fd);
    const day = monday.getDay() || 7;
    monday.setDate(fd.getDate() - day + 1);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate()+6);
    return d>=monday && d<=sunday;
  }
  return false;
}

function aggregate(range){
  let cal=0,min=0,km=0,paceSum=0,paceKm=0,hrSum=0,hrMin=0,sess=0;

  for(const [d,arr] of Object.entries(db)){
    if(!inRange(d,range)) continue;
    if(!Array.isArray(arr)) continue;

    arr.forEach(s=>{
      sess++;
      const m=safeNum(s.duration);
      min+=m;
      cal+=safeNum(s.calories);

      if(KM_SPORTS.has(s.type)){
        const k=safeNum(s.km);
        const ps=parsePace(s.pace);
        km+=k;
        if(ps!=null && k>0){
          paceSum += ps*k;
          paceKm += k;
        }
      }

      const hr=safeNum(s.hr);
      if(hr>0 && m>0){
        hrSum += hr*m;  // dauergewichtet
        hrMin += m;
      }
    });
  }

  return {
    calories:cal,
    minutes:min,
    km:km,
    avgPace: paceKm ? paceFromSeconds(paceSum/paceKm) : "‚Äì",
    avgHr: hrMin ? Math.round(hrSum/hrMin) : "‚Äì",
    sessions:sess
  };
}

function renderDashboard(){
  const a = aggregate(activeRange);
  $("kpiGrid").innerHTML = `
    <div class="kpi"><div class="v">${a.calories}</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">${a.minutes}</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">${a.km.toFixed(1)}</div><div class="l">Kilometer</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">√ò Pace</div></div>
    <div class="kpi"><div class="v">${a.avgHr}</div><div class="l">√ò HF</div></div>
    <div class="kpi"><div class="v">${a.sessions}</div><div class="l">Sessions</div></div>
  `;
}

/* ===== High-DPI Line Chart (lesbar) ===== */
function drawLine(canvas, values, title, unit){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;

  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;

  canvas.width = Math.max(1, Math.floor(cssW * dpr));
  canvas.height = Math.max(1, Math.floor(cssH * dpr));
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const w = cssW, h = cssH;
  ctx.clearRect(0,0,w,h);

  const padL=54, padR=12, padT=26, padB=34;
  const innerW=w-padL-padR;
  const innerH=h-padT-padB;

  ctx.fillStyle="#fff";
  ctx.font="13px system-ui";
  ctx.fillText(title, 10, 18);

  const max = Math.max(1, ...values);
  ctx.strokeStyle="#1f1f1f";
  ctx.fillStyle="#999";
  ctx.font="11px system-ui";

  for(let i=0;i<=5;i++){
    const v=max/5*i;
    const y=h-padB-(v/max)*innerH;
    ctx.beginPath();
    ctx.moveTo(padL,y); ctx.lineTo(w-padR,y); ctx.stroke();
    ctx.fillText(`${Math.round(v)} ${unit}`, 8, y+4);
  }

  ctx.strokeStyle="#00ff6a";
  ctx.lineWidth=2;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x = padL + (i / Math.max(1, values.length-1)) * innerW;
    const y = h-padB-(v/max)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Punkte + Werte (nicht zu viele)
  ctx.fillStyle="#00ff6a";
  const step = values.length > 16 ? Math.ceil(values.length/16) : 1;
  values.forEach((v,i)=>{
    if(v<=0) return;
    if(i % step !== 0 && i !== values.length-1) return;

    const x = padL + (i / Math.max(1, values.length-1)) * innerW;
    const y = h-padB-(v/max)*innerH;
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#fff";
    ctx.fillText(Math.round(v), x-8, y-10);
    ctx.fillStyle="#00ff6a";
  });
}

function monthSeries(){
  const f = new Date($("focusDate").value);
  const days = new Date(f.getFullYear(), f.getMonth()+1, 0).getDate();
  const cal=[], km=[];

  for(let d=1; d<=days; d++){
    const dayIso = `${f.getFullYear()}-${pad(f.getMonth()+1)}-${pad(d)}`;
    let c=0,k=0;
    (db[dayIso]||[]).forEach(s=>{
      c += safeNum(s.calories);
      if(KM_SPORTS.has(s.type)) k += safeNum(s.km);
    });
    cal.push(c);
    km.push(k);
  }
  return {cal, km};
}

function renderCharts(){
  const s = monthSeries();
  drawLine($("calorieChart"), s.cal, "Kalorien pro Tag", "kcal");
  drawLine($("kmChart"), s.km, "Kilometer pro Tag", "km");
}

/* ===== OCR Import (zeigt Upload, funktioniert) ===== */
const shotBtn = $("shotBtn");
const shotFile = $("shotFile");
const ocrStatus = $("ocrStatus");

if(shotBtn && shotFile){
  shotBtn.onclick = ()=> shotFile.click();

  shotFile.onchange = async ()=>{
    const file = shotFile.files && shotFile.files[0];
    if(!file) return;

    ocrStatus.textContent = "OCR l√§uft‚Ä¶";
    try{
      const img = new Image();
      img.src = URL.createObjectURL(file);
      await img.decode();

      // Canvas (skaliert, schneller)
      const maxDim = 1600;
      const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
      const c = document.createElement("canvas");
      c.width = Math.round(img.width*scale);
      c.height = Math.round(img.height*scale);
      const ctx = c.getContext("2d");
      ctx.fillStyle="#fff";
      ctx.fillRect(0,0,c.width,c.height);
      ctx.drawImage(img,0,0,c.width,c.height);

      const res = await Tesseract.recognize(c, "deu+eng");
      const t = (res.data.text || "").replace(/\s+/g," ").trim();

      // Datum/Uhrzeit: nur wenn im Screenshot vorhanden
      const dateMatch = t.match(/(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{4})/);
      const timeMatch = t.match(/([01]?\d|2[0-3]):([0-5]\d)/);

      const dateIso = dateMatch
        ? `${dateMatch[3]}-${pad(dateMatch[2])}-${pad(dateMatch[1])}`
        : entryDateInput.value;

      const time = timeMatch ? timeMatch[0] : "";

      const dur = (t.match(/(\d+)\s*min/i)||[])[1] || "";
      const cal = (t.match(/(\d+)\s*kcal/i)||[])[1] || "";
      const kmv = (t.match(/(\d+(?:[.,]\d+)?)\s*km/i)||[])[1] || "";
      const hr  = (t.match(/(\d+)\s*bpm/i)||[])[1] || "";

      const kmNorm = kmv ? kmv.replace(",",".") : "";

      // Auto-Type: wenn km erkannt -> Joggen (du kannst danach umstellen)
      getDay(dateIso).push({
        time,
        type: kmNorm ? "Joggen" : "Krafttraining",
        duration: dur,
        calories: cal,
        km: kmNorm,
        pace: "",
        hr: hr
      });

      saveDB();
      entryDateInput.value = dateIso;

      renderSessions();
      renderAll();
      ocrStatus.textContent = "Importiert ‚úÖ";
    }catch(e){
      console.error(e);
      ocrStatus.textContent = "OCR Fehler ‚ùå";
    }finally{
      shotFile.value = "";
    }
  };
}

/* ===== MASTER ===== */
function renderAll(){
  renderDashboard();
  renderCharts();
}
$("focusDate").addEventListener("change", ()=>{
  entryDateInput.value = $("focusDate").value;
  renderSessions();
  renderAll();
});

renderAll();
</script>

</body>
</html>