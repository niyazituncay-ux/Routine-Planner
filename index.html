<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ottoman Power Routinen ‚Äì Niyazi Tuncay</title>

<style>
  :root{
    --bg:#000;
    --fg:#fff;
    --muted:#aaa;
    --line:#2a2a2a;
    --panel:#0c0c0c;
    --panel2:#101010;
    --accent:#00ff6a;
    --warn:#ffcc00;
    --bad:#ff5b5b;
  }
  body{
    background:var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    max-width: 1100px;
    margin: 38px auto;
    padding: 0 16px;
  }
  h1{ margin:0; font-size: 30px; letter-spacing:-0.3px; }
  h2{ margin:6px 0 0 0; font-size: 18px; color:var(--muted); font-weight:600; }
  h3{ margin:0 0 10px 0; font-size: 16px; }
  .muted{ color:var(--muted); }
  .small{ font-size: 12px; color:var(--muted); }
  hr{ border:none; border-top:1px solid var(--line); margin: 22px 0; }

  .topbar{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
    background: var(--panel);
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
  }
  .buttons{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  button{
    border:1px solid var(--line);
    background: var(--panel2);
    color: var(--fg);
    border-radius: 10px;
    padding: 8px 10px;
    cursor:pointer;
  }
  button:hover{ background:#151515; }
  .danger{ color:var(--bad); }

  .card{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
    background: var(--panel);
    margin-bottom: 14px;
  }

  input, select{
    width: 100%;
    box-sizing:border-box;
    background: var(--panel2);
    color: var(--fg);
    border:1px solid var(--line);
    border-radius: 10px;
    padding: 7px 9px;
  }
  input[type="checkbox"]{ width:auto; }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; }
  .kpi{
    border:1px solid var(--line);
    background: var(--panel2);
    border-radius: 12px;
    padding: 10px 12px;
    min-width: 200px;
  }
  .kpi .num{ font-size: 20px; font-weight:800; color: var(--accent); }
  .kpi .lbl{ font-size: 12px; color: var(--muted); margin-top:4px; }

  .checklist{ display:grid; gap:8px; }
  .checkRow{ display:flex; gap:10px; align-items:flex-start; }
  .checkRow label{ line-height: 1.2; }

  .dayBlock{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 12px;
    background: var(--panel2);
    margin-top: 10px;
  }
  .dayHeader{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .dayTitle{ font-weight:700; }
  .sessions{ display:grid; gap:10px; margin-top:10px; }
  .session{
    border:1px solid var(--line);
    border-radius: 12px;
    padding: 10px;
    background: #0b0b0b;
  }
  .sessionGrid{
    display:grid;
    grid-template-columns: 1.1fr 0.6fr 0.6fr 0.6fr 0.6fr 1fr auto;
    gap:8px;
    align-items:start;
  }
  @media (max-width: 980px){
    .sessionGrid{ grid-template-columns: 1fr 1fr; }
  }
  .sessionActions{ display:flex; gap:8px; justify-content:flex-end; }
  .miniBtn{ padding: 7px 9px; border-radius: 10px; }
  .miniBtn.danger{ border-color:#3a1a1a; }
  .disabledLook{ opacity:0.35; }

  .suppDayBlock{ border:1px solid var(--line); border-radius:14px; padding:12px; background: var(--panel2); margin-top:10px; }
  .suppHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .suppList{ margin-top:10px; display:grid; gap:8px; }

  .namazGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width: 980px){
    .namazGrid{ grid-template-columns: 1.2fr 0.8fr; }
  }
  .calHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .calendar{
    width:100%;
    border-collapse: collapse;
    overflow:hidden;
    border-radius: 12px;
    border:1px solid var(--line);
    background: #0b0b0b;
  }
  .calendar th, .calendar td{
    border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    padding:8px;
    vertical-align:top;
  }
  .calendar th:last-child, .calendar td:last-child{ border-right:none; }
  .calendar tr:last-child td{ border-bottom:none; }
  .calDayBtn{
    width:100%;
    border:1px solid var(--line);
    background:#101010;
    color:#fff;
    border-radius:10px;
    padding:8px;
    text-align:left;
    cursor:pointer;
  }
  .calDayBtn:hover{ background:#151515; }
  .badge{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border:1px solid var(--line);
    border-radius:999px;
    margin-left:6px;
    color: var(--muted);
  }
  .badge.ok{ color: var(--accent); border-color:#164b2a; }
  .badge.warn{ color: var(--warn); border-color:#5a4b12; }
  .badge.bad{ color: var(--bad); border-color:#5a1b1b; }

  .panel{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 12px;
    background: var(--panel2);
  }

  .bookList{
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px;
    background:#0b0b0b;
    margin-top:10px;
  }
  .bookList ul{ margin:8px 0 0 18px; }
</style>
</head>

<body>

<div class="topbar">
  <div>
    <h1>Niyazi Tuncay</h1>
    <h2>Ottoman Power Routinen</h2>
    <div class="small">Woche: <span id="weekLabel"></span> ¬∑ Speicherung lokal im Browser (Wochen + Namaz pro Datum).</div>
  </div>
  <div class="buttons">
    <button id="prevWeek">‚óÄ Vorherige Woche</button>
    <button id="todayWeek">Diese Woche</button>
    <button id="nextWeek">N√§chste Woche ‚ñ∂</button>
    <button id="resetWeek" class="danger" title="Setzt nur die aktuelle Woche zur√ºck">Woche zur√ºcksetzen</button>
  </div>
</div>

<hr>

<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <h3>üèÜ Gesamtbilanz (bis heute)</h3>
      <div class="small">Summiert √ºber alle gespeicherten Wochen + Namaz + fertige B√ºcher.</div>
    </div>
    <button id="refreshTotals">Gesamtbilanz aktualisieren</button>
  </div>
  <div class="kpiRow" id="totalKpis"></div>

  <div class="bookList">
    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
      <div style="font-weight:700;">üìö Fertige B√ºcher (Titel)</div>
      <button id="clearFinishedBooks" class="danger">Liste leeren</button>
    </div>
    <div class="small muted">Wenn du ‚ÄûBuch fertig‚Äú anhakst, wird der Titel einmalig gespeichert.</div>
    <ul id="finishedBooksList"></ul>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <h3>üìä Wochenbilanz (diese Woche)</h3>
      <div class="small">Sport / Lesen / Supplements / Joggen-√ò Pace.</div>
    </div>
    <button id="refreshWeek">Wochenbilanz aktualisieren</button>
  </div>
  <div class="kpiRow" id="weekKpis"></div>
</div>

<hr>

<div class="card">
  <h3>üïå Namaz-Tracker (Datum, r√ºckwirkend bis 2000)</h3>
  <div class="small">W√§hle Datum/Monat, hake Sabach/√ñƒüle/ƒ∞kindi/Ak≈üam/Yatsƒ± ab. Ein kompletter Tag z√§hlt nur, wenn alle 5 abgehakt sind.</div>

  <div class="namazGrid" style="margin-top:10px;">
    <div class="panel">
      <div class="calHeader">
        <div class="row" style="gap:8px;">
          <button id="calPrev">‚óÄ</button>
          <button id="calToday">Heute</button>
          <button id="calNext">‚ñ∂</button>
          <span class="small muted">Monat:</span>
          <span id="calLabel" style="font-weight:700;"></span>
        </div>
        <div class="row" style="gap:8px;">
          <input id="jumpDate" type="date" style="max-width:220px;">
          <button id="jumpBtn">Zu Datum</button>
        </div>
      </div>

      <div class="small" style="margin-top:8px;">
        Legende: <span class="badge ok">5/5</span> komplett ¬∑ <span class="badge warn">1‚Äì4/5</span> teilweise ¬∑ <span class="badge bad">0/5</span> nichts
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table class="calendar" id="calendar"></table>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin-bottom:8px;">Ausgew√§hlter Tag: <span id="selDateLabel"></span></h3>
      <div id="namazForm" class="checklist"></div>

      <div style="margin-top:10px;">
        <input id="namazNote" placeholder="Notiz (optional)" />
      </div>

      <div class="row" style="margin-top:10px; justify-content:space-between;">
        <button id="clearDay" class="danger">Tag zur√ºcksetzen</button>
        <button id="closeDay">Schlie√üen</button>
      </div>

      <hr style="margin:14px 0;">

      <h3 style="margin-bottom:8px;">Namaz-Gesamtbilanz</h3>
      <div class="kpiRow" id="namazTotals"></div>
    </div>
  </div>
</div>

<hr>

<div class="card">
  <h3>üíä Supplements ‚Äì t√§glich (Mo‚ÄìSo)</h3>
  <div class="small">Jeden Tag abhaken.</div>
  <div id="suppDays"></div>
</div>

<div class="card">
  <h3>üèãÔ∏è Sport ‚Äì mehrere Sessions pro Tag</h3>
  <div class="small">Joggen: Pace = <b>Minuten pro Kilometer</b> (Format <b>mm:ss</b> pro km, z.B. 5:30).</div>
  <div id="sportDays"></div>
</div>

<div class="card">
  <h3>üìö Lesen ‚Äì Wochenplan</h3>
  <div class="small">Pro Tag: Titel + Seiten + Minuten + ‚ÄûBuch fertig‚Äú.</div>

  <div style="overflow:auto; margin-top:10px;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="width:120px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Tag</th>
          <th style="text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Titel</th>
          <th style="width:130px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Seiten</th>
          <th style="width:130px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Minuten</th>
          <th style="width:130px; text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--line);">Buch fertig</th>
        </tr>
      </thead>
      <tbody id="readBody"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  // ---------------- CONSTANTS ----------------
  const DAYS = [
    {key:"mon", label:"Montag"},
    {key:"tue", label:"Dienstag"},
    {key:"wed", label:"Mittwoch"},
    {key:"thu", label:"Donnerstag"},
    {key:"fri", label:"Freitag"},
    {key:"sat", label:"Samstag"},
    {key:"sun", label:"Sonntag"},
  ];

  const SUPPLEMENTS = [
    { id:"d3k2", text:"Vitamin D3 / K2 (pro 10kg ‚Äì 1000 IE)" },
    { id:"omega3", text:"Omega 3 ‚Äì 4 Kapseln" },
    { id:"kurkuma", text:"Kurkuma + Piperin ‚Äì 4 Kapseln" },
    { id:"cellagon", text:"Cellagon Multivitamin ‚Äì 25 ml" },
    { id:"magnesium", text:"Magnesiumkapseln" },
    { id:"granatapfel", text:"Granatapfelsaft ‚Äì 300‚Äì400 ml" },
  ];

  const SPORTS = ["", "Krafttraining", "Joggen", "Stretching", "Ringen", "Schwimmen", "Tennis"];

  const NAMAZ_PRAYERS = [
    { id:"sabach", label:"Sabach" },
    { id:"ogle", label:"√ñƒüle" },
    { id:"ikindi", label:"ƒ∞kindi" },
    { id:"aksam", label:"Ak≈üam" },
    { id:"yatsi", label:"Yatsƒ±" },
  ];

  // localStorage keys
  const WEEK_PREFIX = "op_week_v4_";
  const NAMAZ_KEY = "op_namaz_v1"; // { "YYYY-MM-DD": { sabach:true, ..., note:"" } }
  const FINISHED_BOOKS_KEY = "op_books_finished_v1"; // [{title, isoFinished, sourceWeekKey}]

  // ---------------- HELPERS ----------------
  const pad2 = n => String(n).padStart(2,"0");

  function startOfWeekMonday(date){
    const d = new Date(date);
    const day = d.getDay(); // Sun=0
    const diff = (day === 0 ? -6 : 1 - day); // Monday start
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }

  function fmtDate(d){
    return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
  }

  function weekKey(monday){
    return `${monday.getFullYear()}-${pad2(monday.getMonth()+1)}-${pad2(monday.getDate())}`;
  }

  function lsGet(key, fallback){
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch {
      return fallback;
    }
  }

  function lsSet(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  // Pace mm:ss per km
  function parsePaceToSeconds(paceStr){
    if (!paceStr || !paceStr.includes(":")) return null;
    const [m,s] = paceStr.split(":").map(Number);
    if (!Number.isFinite(m) || !Number.isFinite(s)) return null;
    return m*60 + s;
  }

  function secondsToPace(sec){
    const m = Math.floor(sec/60);
    const s = Math.round(sec%60);
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function isoDate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function parseIso(iso){
    const [y,m,da] = iso.split("-").map(Number);
    return new Date(y, m-1, da);
  }

  function kpi(num, label){
    const el = document.createElement("div");
    el.className = "kpi";
    el.innerHTML = `<div class="num">${num}</div><div class="lbl">${label}</div>`;
    return el;
  }

  // ---------------- WEEK STATE ----------------
  let currentMonday = startOfWeekMonday(new Date());
  const weekLabelEl = document.getElementById("weekLabel");

  function emptyWeek(){
    const supplements = Object.fromEntries(DAYS.map(d => [d.key, {
      note: "",
      items: Object.fromEntries(SUPPLEMENTS.map(s => [s.id, false]))
    }]));
    const sport = Object.fromEntries(DAYS.map(d => [d.key, { sessions: [] }]));
    const reading = Object.fromEntries(DAYS.map(d => [d.key, { title:"", pages:"", minutes:"", finished:false }]));
    return { supplements, sport, reading };
  }

  function weekStorageKey(){
    return WEEK_PREFIX + weekKey(currentMonday);
  }

  let weekData = lsGet(weekStorageKey(), emptyWeek());

  function saveWeek(){
    lsSet(weekStorageKey(), weekData);
  }

  function renderWeekLabel(){
    const end = new Date(currentMonday);
    end.setDate(end.getDate()+6);
    weekLabelEl.textContent = `${fmtDate(currentMonday)} ‚Äì ${fmtDate(end)}`;
  }

  function listAllWeeks(){
    const keys = Object.keys(localStorage).filter(k => k.startsWith(WEEK_PREFIX));
    return keys
      .map(k => ({ key:k, data: lsGet(k, null) }))
      .filter(x => x.data && typeof x.data === "object");
  }

  // ---------------- FINISHED BOOKS ----------------
  let finishedBooks = lsGet(FINISHED_BOOKS_KEY, []);

  function saveFinishedBooks(){
    lsSet(FINISHED_BOOKS_KEY, finishedBooks);
  }

  function normalizeTitle(t){
    return (t || "").trim().replace(/\s+/g, " ");
  }

  function addFinishedBookOnce(title){
    const clean = normalizeTitle(title);
    if (!clean) return;

    const exists = finishedBooks.some(b => normalizeTitle(b.title).toLowerCase() === clean.toLowerCase());
    if (exists) return;

    finishedBooks.push({
      title: clean,
      isoFinished: isoDate(new Date()),
      sourceWeekKey: weekStorageKey()
    });
    saveFinishedBooks();
  }

  const finishedBooksListEl = document.getElementById("finishedBooksList");

  function renderFinishedBooksList(){
    finishedBooksListEl.innerHTML = "";
    if (!finishedBooks.length){
      const li = document.createElement("li");
      li.className = "small muted";
      li.textContent = "Noch keine fertigen B√ºcher.";
      finishedBooksListEl.appendChild(li);
      return;
    }

    finishedBooks
      .slice()
      .sort((a,b) => (a.isoFinished||"").localeCompare(b.isoFinished||""))
      .forEach(b => {
        const li = document.createElement("li");
        li.textContent = `${b.title} (${b.isoFinished})`;
        finishedBooksListEl.appendChild(li);
      });
  }

  document.getElementById("clearFinishedBooks").addEventListener("click", () => {
    finishedBooks = [];
    saveFinishedBooks();
    renderFinishedBooksList();
    renderTotalKpis();
  });

  // ---------------- SUPPLEMENTS ----------------
  const suppDaysEl = document.getElementById("suppDays");

  function renderSupplementsDaily(){
    suppDaysEl.innerHTML = "";

    DAYS.forEach(d => {
      if (!weekData.supplements[d.key]){
        weekData.supplements[d.key] = {
          note:"",
          items: Object.fromEntries(SUPPLEMENTS.map(s => [s.id, false]))
        };
      }

      const block = document.createElement("div");
      block.className = "suppDayBlock";

      const header = document.createElement("div");
      header.className = "suppHeader";
      header.innerHTML = `<div class="dayTitle">${d.label}</div>`;
      block.appendChild(header);

      const list = document.createElement("div");
      list.className = "suppList";

      SUPPLEMENTS.forEach(s => {
        const row = document.createElement("div");
        row.className = "checkRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!weekData.supplements[d.key].items[s.id];
        cb.addEventListener("change", () => {
          weekData.supplements[d.key].items[s.id] = cb.checked;
          saveWeek();
          renderWeekKpis();
          renderTotalKpis();
        });

        const label = document.createElement("label");
        label.textContent = s.text;

        row.appendChild(cb);
        row.appendChild(label);
        list.appendChild(row);
      });

      const note = document.createElement("input");
      note.placeholder = "Notiz (optional)";
      note.value = weekData.supplements[d.key].note || "";
      note.addEventListener("input", () => {
        weekData.supplements[d.key].note = note.value;
        saveWeek();
      });

      block.appendChild(list);
      block.appendChild(document.createElement("div")).style.height = "8px";
      block.appendChild(note);

      suppDaysEl.appendChild(block);
    });

    saveWeek();
  }

  // ---------------- SPORT (MULTI) ----------------
  const sportDaysEl = document.getElementById("sportDays");

  function newSession(){
    return { type:"", minutes:"", calories:"", km:"", pace:"", note:"" };
  }

  function renderSportMulti(){
    sportDaysEl.innerHTML = "";

    DAYS.forEach(d => {
      if (!weekData.sport[d.key] || !Array.isArray(weekData.sport[d.key].sessions)){
        weekData.sport[d.key] = { sessions: [] };
      }

      const block = document.createElement("div");
      block.className = "dayBlock";

      const header = document.createElement("div");
      header.className = "dayHeader";
      header.innerHTML = `<div class="dayTitle">${d.label}</div>`;

      const addBtn = document.createElement("button");
      addBtn.className = "miniBtn";
      addBtn.textContent = "+ Session hinzuf√ºgen";
      addBtn.addEventListener("click", () => {
        weekData.sport[d.key].sessions.push(newSession());
        saveWeek();
        renderSportMulti();
        renderWeekKpis();
        renderTotalKpis();
      });

      header.appendChild(addBtn);
      block.appendChild(header);

      const sessionsWrap = document.createElement("div");
      sessionsWrap.className = "sessions";

      const sessions = weekData.sport[d.key].sessions;

      if (sessions.length === 0){
        const empty = document.createElement("div");
        empty.className = "small muted";
        empty.textContent = "Keine Sport-Session eingetragen.";
        empty.style.marginTop = "8px";
        block.appendChild(empty);
      } else {
        sessions.forEach((sess, idx) => {
          const card = document.createElement("div");
          card.className = "session";

          const grid = document.createElement("div");
          grid.className = "sessionGrid";

          const sel = document.createElement("select");
          SPORTS.forEach(opt => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt === "" ? "‚Äî Sport ‚Äî" : opt;
            sel.appendChild(o);
          });
          sel.value = sess.type || "";

          const inpMin = document.createElement("input");
          inpMin.type = "number";
          inpMin.min = "0";
          inpMin.placeholder = "Dauer (min)";
          inpMin.value = sess.minutes ?? "";

          const inpCal = document.createElement("input");
          inpCal.type = "number";
          inpCal.min = "0";
          inpCal.placeholder = "Kalorien";
          inpCal.value = sess.calories ?? "";

          const inpKm = document.createElement("input");
          inpKm.type = "number";
          inpKm.min = "0";
          inpKm.step = "0.1";
          inpKm.placeholder = "KM (nur Joggen)";
          inpKm.value = sess.km ?? "";

          const inpPace = document.createElement("input");
          inpPace.placeholder = "Pace (mm:ss / km)";
          inpPace.value = sess.pace ?? "";

          const inpNote = document.createElement("input");
          inpNote.placeholder = "Notiz";
          inpNote.value = sess.note ?? "";

          const actions = document.createElement("div");
          actions.className = "sessionActions";

          const del = document.createElement("button");
          del.className = "miniBtn danger";
          del.textContent = "L√∂schen";
          del.addEventListener("click", () => {
            weekData.sport[d.key].sessions.splice(idx, 1);
            saveWeek();
            renderSportMulti();
            renderWeekKpis();
            renderTotalKpis();
          });
          actions.appendChild(del);

          function updateJog(){
            const isJog = sel.value === "Joggen";
            inpKm.disabled = !isJog;
            inpPace.disabled = !isJog;
            inpKm.classList.toggle("disabledLook", !isJog);
            inpPace.classList.toggle("disabledLook", !isJog);
          }

          function persist(){
            weekData.sport[d.key].sessions[idx] = {
              type: sel.value,
              minutes: inpMin.value,
              calories: inpCal.value,
              km: inpKm.value,
              pace: inpPace.value,
              note: inpNote.value
            };
            saveWeek();
            updateJog();
            renderWeekKpis();
            renderTotalKpis();
          }

          [sel, inpMin, inpCal, inpKm, inpPace, inpNote].forEach(el => el.addEventListener("input", persist));
          sel.addEventListener("change", persist);

          updateJog();

          grid.appendChild(sel);
          grid.appendChild(inpMin);
          grid.appendChild(inpCal);
          grid.appendChild(inpKm);
          grid.appendChild(inpPace);
          grid.appendChild(inpNote);
          grid.appendChild(actions);

          card.appendChild(grid);
          sessionsWrap.appendChild(card);
        });

        block.appendChild(sessionsWrap);
      }

      sportDaysEl.appendChild(block);
    });

    saveWeek();
  }

  // ---------------- READING ----------------
  const readBody = document.getElementById("readBody");

  function renderReading(){
    readBody.innerHTML = "";

    DAYS.forEach(d => {
      const tr = document.createElement("tr");
      const r = weekData.reading[d.key] || (weekData.reading[d.key] = { title:"", pages:"", minutes:"", finished:false });

      function tdBase(){
        const td = document.createElement("td");
        td.style.padding="8px";
        td.style.borderBottom="1px solid var(--line)";
        return td;
      }

      const tdDay = tdBase();
      tdDay.textContent = d.label;

      const tdTitle = tdBase();
      const inpTitle = document.createElement("input");
      inpTitle.placeholder="Buchtitel";
      inpTitle.value = r.title ?? "";
      tdTitle.appendChild(inpTitle);

      const tdPages = tdBase();
      const inpPages = document.createElement("input");
      inpPages.type="number"; inpPages.min="0"; inpPages.placeholder="Seiten";
      inpPages.value = r.pages ?? "";
      tdPages.appendChild(inpPages);

      const tdMin = tdBase();
      const inpMin = document.createElement("input");
      inpMin.type="number"; inpMin.min="0"; inpMin.placeholder="Minuten";
      inpMin.value = r.minutes ?? "";
      tdMin.appendChild(inpMin);

      const tdDone = tdBase();
      const cbDone = document.createElement("input");
      cbDone.type="checkbox";
      cbDone.checked = !!r.finished;
      tdDone.appendChild(cbDone);

      function persist(){
        weekData.reading[d.key] = {
          title: inpTitle.value,
          pages: inpPages.value,
          minutes: inpMin.value,
          finished: cbDone.checked
        };
        saveWeek();

        if (cbDone.checked){
          addFinishedBookOnce(inpTitle.value);
          renderFinishedBooksList();
        }

        renderWeekKpis();
        renderTotalKpis();
      }

      [inpTitle, inpPages, inpMin].forEach(el => el.addEventListener("input", persist));
      cbDone.addEventListener("change", persist);

      tr.appendChild(tdDay);
      tr.appendChild(tdTitle);
      tr.appendChild(tdPages);
      tr.appendChild(tdMin);
      tr.appendChild(tdDone);
      readBody.appendChild(tr);
    });

    saveWeek();
  }

  // ---------------- NAMAZ DB ----------------
  let namazDB = lsGet(NAMAZ_KEY, {});

  function ensureNamazDay(iso){
    if (!namazDB[iso]){
      namazDB[iso] = { sabach:false, ogle:false, ikindi:false, aksam:false, yatsi:false, note:"" };
    } else {
      NAMAZ_PRAYERS.forEach(p => {
        if (typeof namazDB[iso][p.id] !== "boolean") namazDB[iso][p.id] = !!namazDB[iso][p.id];
      });
      if (typeof namazDB[iso].note !== "string") namazDB[iso].note = "";
    }
  }

  function saveNamaz(){ lsSet(NAMAZ_KEY, namazDB); }

  function countNamazTotals(){
    let perPrayer = Object.fromEntries(NAMAZ_PRAYERS.map(p => [p.id, 0]));
    let fullDays = 0;
    const minDate = new Date(2000,0,1);

    Object.keys(namazDB).forEach(k => {
      const d = parseIso(k);
      if (d < minDate) return;

      const day = namazDB[k];
      let all5 = true;

      NAMAZ_PRAYERS.forEach(p => {
        if (day[p.id]) perPrayer[p.id]++;
        if (!day[p.id]) all5 = false;
      });

      if (all5) fullDays++;
    });

    return { perPrayer, fullDays, years: fullDays/365 };
  }

  // ---------------- NAMAZ UI ----------------
  const calEl = document.getElementById("calendar");
  const calLabelEl = document.getElementById("calLabel");
  const selDateLabelEl = document.getElementById("selDateLabel");
  const namazFormEl = document.getElementById("namazForm");
  const namazNoteEl = document.getElementById("namazNote");
  const jumpDateEl = document.getElementById("jumpDate");
  const namazTotalsEl = document.getElementById("namazTotals");

  let calMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let selectedIso = isoDate(new Date());

  jumpDateEl.min = "2000-01-01";
  jumpDateEl.max = "2099-12-31";
  jumpDateEl.value = selectedIso;

  function dayStatusBadge(iso){
    ensureNamazDay(iso);
    const day = namazDB[iso];
    let count = 0;
    NAMAZ_PRAYERS.forEach(p => { if (day[p.id]) count++; });

    if (count === 5) return { txt:"5/5", cls:"ok" };
    if (count === 0) return { txt:"0/5", cls:"bad" };
    return { txt:`${count}/5`, cls:"warn" };
  }

  function renderNamazTotals(){
    const t = countNamazTotals();
    namazTotalsEl.innerHTML = "";
    namazTotalsEl.appendChild(kpi(`${t.perPrayer.sabach}`, "Sabach (gesamt)"));
    namazTotalsEl.appendChild(kpi(`${t.perPrayer.ogle}`, "√ñƒüle (gesamt)"));
    namazTotalsEl.appendChild(kpi(`${t.perPrayer.ikindi}`, "ƒ∞kindi (gesamt)"));
    namazTotalsEl.appendChild(kpi(`${t.perPrayer.aksam}`, "Ak≈üam (gesamt)"));
    namazTotalsEl.appendChild(kpi(`${t.perPrayer.yatsi}`, "Yatsƒ± (gesamt)"));
    namazTotalsEl.appendChild(kpi(`${t.fullDays}`, "Vollst√§ndige Tage (5/5)"));
    namazTotalsEl.appendChild(kpi(`${t.years.toFixed(2)}`, "Jahre Namaz (‚âà Tage/365)"));
  }

  function selectNamazDate(iso, silent=false){
    const min = new Date(2000,0,1);
    if (parseIso(iso) < min) return;

    selectedIso = iso;
    jumpDateEl.value = iso;

    ensureNamazDay(iso);
    const day = namazDB[iso];

    selDateLabelEl.textContent = iso;
    namazFormEl.innerHTML = "";

    NAMAZ_PRAYERS.forEach(p => {
      const row = document.createElement("div");
      row.className = "checkRow";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!day[p.id];

      cb.addEventListener("change", () => {
        day[p.id] = cb.checked;
        saveNamaz();
        renderNamazTotals();
        renderTotalKpis();
        renderCalendar();
      });

      const label = document.createElement("label");
      label.textContent = p.label;

      row.appendChild(cb);
      row.appendChild(label);
      namazFormEl.appendChild(row);
    });

    namazNoteEl.value = day.note || "";
    namazNoteEl.oninput = () => {
      day.note = namazNoteEl.value;
      saveNamaz();
    };

    if (!silent) renderCalendar();
  }

  function renderCalendar(){
    const y = calMonth.getFullYear();
    const m = calMonth.getMonth();

    const monthNames = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
    calLabelEl.textContent = `${monthNames[m]} ${y}`;

    const first = new Date(y, m, 1);
    const last = new Date(y, m+1, 0);
    const daysInMonth = last.getDate();

    const jsDay = first.getDay(); // Sun=0
    const offset = (jsDay === 0 ? 6 : jsDay - 1); // Mon=0

    const headers = ["Mo","Di","Mi","Do","Fr","Sa","So"];
    let html = "<thead><tr>" + headers.map(h => `<th style="color:var(--muted); font-weight:600;">${h}</th>`).join("") + "</tr></thead><tbody>";

    let dayNum = 1 - offset;
    for (let row=0; row<6; row++){
      html += "<tr>";
      for (let col=0; col<7; col++){
        if (dayNum < 1 || dayNum > daysInMonth){
          html += `<td style="background:#070707; color:#333;">&nbsp;</td>`;
        } else {
          const d = new Date(y, m, dayNum);
          const min = new Date(2000,0,1);
          const disabled = d < min;
          const iso = isoDate(d);

          const badge = !disabled ? dayStatusBadge(iso) : {txt:"", cls:""};
          const isSel = iso === selectedIso;

          html += `<td style="background:${isSel ? "#111" : "#0b0b0b"};">
            <button class="calDayBtn" data-iso="${iso}" ${disabled ? "disabled style='opacity:.25; cursor:not-allowed;'" : ""}>
              <div style="font-weight:700;">${dayNum}
                ${!disabled ? `<span class="badge ${badge.cls}">${badge.txt}</span>` : ""}
              </div>
              <div class="small muted" style="margin-top:4px;">${iso}</div>
            </button>
          </td>`;
        }
        dayNum++;
      }
      html += "</tr>";
    }
    html += "</tbody>";
    calEl.innerHTML = html;

    calEl.querySelectorAll("button[data-iso]").forEach(btn => {
      btn.addEventListener("click", () => selectNamazDate(btn.getAttribute("data-iso")));
    });

    selectNamazDate(selectedIso, true);
  }
    // ---------------- WEEK KPIs ----------------
  const weekKpisEl = document.getElementById("weekKpis");

  function countThisWeek(){
    let sportMinutes = 0;
    let sportCalories = 0;

    let jogSessions = 0;
    let jogKm = 0;
    let jogPaceWeightedSum = 0;

    const sessionsByType = Object.fromEntries(SPORTS.filter(s=>s).map(s => [s, 0]));

    DAYS.forEach(d => {
      const sessions = weekData.sport?.[d.key]?.sessions || [];
      sessions.forEach(s => {
        if (s.type && sessionsByType[s.type] != null) sessionsByType[s.type]++;

        sportMinutes += Number(s.minutes || 0);
        sportCalories += Number(s.calories || 0);

        if (s.type === "Joggen"){
          jogSessions++;
          const km = Number(s.km || 0);
          const paceSec = parsePaceToSeconds(s.pace);
          if (km > 0){
            jogKm += km;
            if (paceSec != null) jogPaceWeightedSum += paceSec * km; // distance-weighted
          }
        }
      });
    });

    let readMinutes = 0, readPages = 0, finishedBooksWeek = 0;
    DAYS.forEach(d => {
      const r = weekData.reading?.[d.key];
      if (!r) return;
      readMinutes += Number(r.minutes || 0);
      readPages += Number(r.pages || 0);
      if (r.finished) finishedBooksWeek++;
    });

    let suppItemsChecked = 0;
    DAYS.forEach(d => {
      const items = weekData.supplements?.[d.key]?.items || {};
      Object.values(items).forEach(v => { if (v) suppItemsChecked++; });
    });

    const avgPace = (jogKm > 0 && jogPaceWeightedSum > 0) ? secondsToPace(jogPaceWeightedSum / jogKm) : "‚Äì";

    return {
      sportMinutes, sportCalories,
      jogSessions,
      jogKm: Number(jogKm.toFixed(1)),
      avgPace,
      suppItemsChecked,
      readMinutes, readPages, finishedBooksWeek,
      sessionsByType
    };
  }

  function renderWeekKpis(){
    const c = countThisWeek();
    weekKpisEl.innerHTML = "";
    weekKpisEl.appendChild(kpi(`${c.sportMinutes}`, "Sport-Minuten (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.sportCalories}`, "Sport-Kalorien (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.jogSessions}`, "Joggen-Einheiten (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.jogKm}`, "Joggen-KM (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.avgPace}`, "√ò Pace (mm:ss / km)"));
    weekKpisEl.appendChild(kpi(`${c.sessionsByType["Krafttraining"]||0}`, "Krafttraining (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.sessionsByType["Ringen"]||0}`, "Ringen (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.sessionsByType["Stretching"]||0}`, "Stretching (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.sessionsByType["Schwimmen"]||0}`, "Schwimmen (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.sessionsByType["Tennis"]||0}`, "Tennis (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.suppItemsChecked}`, "Supplements abgehakt (Items/Woche)"));
    weekKpisEl.appendChild(kpi(`${c.readMinutes}`, "Lesen-Minuten (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.readPages}`, "Lesen-Seiten (Woche)"));
    weekKpisEl.appendChild(kpi(`${c.finishedBooksWeek}`, "B√ºcher fertig (Woche)"));
  }

  // ---------------- TOTAL KPIs ----------------
  const totalKpisEl = document.getElementById("totalKpis");

  function aggregateTotalsFromWeeks(){
    let jogSessions = 0;
    let jogKm = 0;
    let jogPaceWeightedSum = 0;

    const counts = { "Krafttraining":0, "Ringen":0, "Stretching":0, "Schwimmen":0, "Tennis":0 };
    let sportMinutes = 0;
    let sportCalories = 0;

    let readMinutesTotal = 0;
    let readPagesTotal = 0;

    listAllWeeks().forEach(w => {
      const sport = w.data.sport || {};
      const reading = w.data.reading || {};

      DAYS.forEach(d => {
        const sessions = sport[d.key]?.sessions || [];
        sessions.forEach(s => {
          sportMinutes += Number(s.minutes || 0);
          sportCalories += Number(s.calories || 0);

          if (s.type === "Joggen"){
            jogSessions++;
            const km = Number(s.km || 0);
            const paceSec = parsePaceToSeconds(s.pace);
            if (km > 0){
              jogKm += km;
              if (paceSec != null) jogPaceWeightedSum += paceSec * km;
            }
          } else if (counts[s.type] != null){
            counts[s.type]++;
          }
        });

        const r = reading[d.key];
        if (r){
          readMinutesTotal += Number(r.minutes || 0);
          readPagesTotal += Number(r.pages || 0);
        }
      });
    });

    const avgPace = (jogKm > 0 && jogPaceWeightedSum > 0) ? secondsToPace(jogPaceWeightedSum / jogKm) : "‚Äì";

    return {
      sportMinutes,
      sportCalories,
      jogSessions,
      jogKm: Number(jogKm.toFixed(1)),
      avgPace,
      readMinutesTotal,
      readPagesTotal,
      ...counts
    };
  }

  function renderTotalKpis(){
    const totals = aggregateTotalsFromWeeks();
    const namaz = countNamazTotals();

    const totalNamazPrayers =
      namaz.perPrayer.sabach + namaz.perPrayer.ogle + namaz.perPrayer.ikindi + namaz.perPrayer.aksam + namaz.perPrayer.yatsi;

    totalKpisEl.innerHTML = "";
    totalKpisEl.appendChild(kpi(`${totals.sportMinutes}`, "Sport-Minuten (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.sportCalories}`, "Sport-Kalorien (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.jogSessions}`, "Joggen-Einheiten (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.jogKm}`, "Joggen-KM (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.avgPace}`, "√ò Pace (gesamt, mm:ss/km)"));
    totalKpisEl.appendChild(kpi(`${totals.Krafttraining}`, "Krafttraining (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.Ringen}`, "Ringen (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.Stretching}`, "Stretching (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.Schwimmen}`, "Schwimmen (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.Tennis}`, "Tennis (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.readMinutesTotal}`, "Lesen-Minuten (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totals.readPagesTotal}`, "Lesen-Seiten (gesamt)"));
    totalKpisEl.appendChild(kpi(`${finishedBooks.length}`, "B√ºcher fertig (gesamt)"));
    totalKpisEl.appendChild(kpi(`${totalNamazPrayers}`, "Namaz (Gebete gesamt)"));
    totalKpisEl.appendChild(kpi(`${namaz.fullDays}`, "Namaz (vollst√§ndige Tage 5/5)"));
    totalKpisEl.appendChild(kpi(`${namaz.years.toFixed(2)}`, "Namaz (Jahre ‚âà Tage/365)"));
  }

  // ---------------- NAV + BUTTONS ----------------
  function rerenderWeekParts(){
    renderWeekLabel();
    renderSupplementsDaily();
    renderSportMulti();
    renderReading();
    renderWeekKpis();
    renderTotalKpis();
    renderFinishedBooksList();
    renderNamazTotals();
  }

  document.getElementById("prevWeek").addEventListener("click", () => {
    currentMonday.setDate(currentMonday.getDate() - 7);
    weekData = lsGet(weekStorageKey(), emptyWeek());
    rerenderWeekParts();
  });

  document.getElementById("nextWeek").addEventListener("click", () => {
    currentMonday.setDate(currentMonday.getDate() + 7);
    weekData = lsGet(weekStorageKey(), emptyWeek());
    rerenderWeekParts();
  });

  document.getElementById("todayWeek").addEventListener("click", () => {
    currentMonday = startOfWeekMonday(new Date());
    weekData = lsGet(weekStorageKey(), emptyWeek());
    rerenderWeekParts();
  });

  document.getElementById("resetWeek").addEventListener("click", () => {
    localStorage.removeItem(weekStorageKey());
    weekData = emptyWeek();
    saveWeek();
    rerenderWeekParts();
  });

  document.getElementById("refreshWeek").addEventListener("click", renderWeekKpis);

  document.getElementById("refreshTotals").addEventListener("click", () => {
    renderTotalKpis();
    renderFinishedBooksList();
    renderNamazTotals();
  });

  // Namaz nav buttons
  document.getElementById("calPrev").addEventListener("click", () => {
    calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1);
    renderCalendar();
  });

  document.getElementById("calNext").addEventListener("click", () => {
    calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1);
    renderCalendar();
  });

  document.getElementById("calToday").addEventListener("click", () => {
    const t = new Date();
    calMonth = new Date(t.getFullYear(), t.getMonth(), 1);
    selectNamazDate(isoDate(t));
    renderCalendar();
  });

  document.getElementById("jumpBtn").addEventListener("click", () => {
    const iso = jumpDateEl.value;
    if (!iso) return;
    const d = parseIso(iso);
    calMonth = new Date(d.getFullYear(), d.getMonth(), 1);
    selectNamazDate(iso);
    renderCalendar();
  });

  document.getElementById("clearDay").addEventListener("click", () => {
    ensureNamazDay(selectedIso);
    NAMAZ_PRAYERS.forEach(p => namazDB[selectedIso][p.id] = false);
    namazDB[selectedIso].note = "";
    saveNamaz();
    selectNamazDate(selectedIso, true);
    renderNamazTotals();
    renderTotalKpis();
    renderCalendar();
  });

  document.getElementById("closeDay").addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // ---------------- INIT ----------------
  renderWeekLabel();
  renderSupplementsDaily();
  renderSportMulti();
  renderReading();
  renderWeekKpis();

  ensureNamazDay(selectedIso);
  saveNamaz();

  renderNamazTotals();
  renderTotalKpis();
  renderFinishedBooksList();
  renderCalendar();
})();
</script>

</body>
</html>
