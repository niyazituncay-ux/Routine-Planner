<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#9a9a9a;
  --line:#262626;
  --panel:#0c0c0c;
  --panel2:#101010;
  --accent:#00ff6a;
}
*{box-sizing:border-box}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  max-width:1200px;
  margin:24px auto;
  padding:0 16px 60px;
}
h1{margin:0;font-size:30px}
h2{margin:4px 0 0;font-size:14px;color:var(--muted)}
h3{margin:0 0 10px;font-size:16px}
.small{font-size:12px;color:var(--muted)}

.card{
  border:1px solid var(--line);
  background:var(--panel);
  border-radius:16px;
  padding:14px;
  margin-top:14px;
}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1;min-width:220px}

input,select,textarea{
  width:100%;
  background:var(--panel2);
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:12px;
  padding:9px 10px;
}

button{
  border:1px solid var(--line);
  background:#111;
  color:var(--fg);
  border-radius:12px;
  padding:9px 12px;
  cursor:pointer;
}
button:hover{background:#151515}

.tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.tab{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  cursor:pointer;
}
.tab.active{
  background:rgba(0,255,106,.15);
  color:var(--fg);
  border-color:#1b4f30;
}

.kpiGrid{
  display:grid;
  grid-template-columns:repeat(3,minmax(140px,1fr));
  gap:10px;
}
.kpi{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:#0b0b0b;
}
.kpi .v{font-size:22px;font-weight:900;color:var(--accent)}
.kpi .l{font-size:12px;color:var(--muted);margin-top:4px}

canvas{
  width:100%;
  height:260px;
  background:#080808;
  border:1px solid var(--line);
  border-radius:16px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="card">
  <div class="row">
    <div class="grow">
      <h1 id="appTitle">Sport Tracker</h1>
      <h2>Multi-Sessions ¬∑ OCR ¬∑ Liniendiagramme ¬∑ Archiv</h2>
    </div>
    <div class="grow">
      <div class="small">Profilname</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay">
    </div>
    <button id="saveProfile">Speichern</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="card">
  <h3>üìä Dashboard</h3>

  <div class="tabs">
    <div class="tab active" data-range="day">Tag</div>
    <div class="tab" data-range="week">Woche</div>
    <div class="tab" data-range="month">Monat</div>
    <div class="tab" data-range="year">Jahr</div>
    <div class="tab" data-range="all">Gesamt</div>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="focusDate" type="date" style="max-width:220px">
    <button id="todayBtn">Heute</button>
  </div>

  <div class="kpiGrid" id="kpiGrid" style="margin-top:12px"></div>

  <div class="row" style="margin-top:14px">
    <div class="grow">
      <canvas id="calorieChart"></canvas>
    </div>
    <div class="grow">
      <canvas id="kmChart"></canvas>
    </div>
  </div>
</div>

<script>
/* ===== BASIS STATE ===== */
const KEY_DATA="sport_db_v1";
const KEY_PROFILE="sport_profile_v1";

let db = JSON.parse(localStorage.getItem(KEY_DATA)||"{}");
let profile = localStorage.getItem(KEY_PROFILE)||"";

const $=id=>document.getElementById(id);
const iso=d=>d.toISOString().slice(0,10);

/* ===== INIT ===== */
$("profileName").value=profile;
$("appTitle").textContent=profile||"Sport Tracker";
$("saveProfile").onclick=()=>{
  profile=$("profileName").value.trim();
  localStorage.setItem(KEY_PROFILE,profile);
  $("appTitle").textContent=profile||"Sport Tracker";
};

$("focusDate").value=iso(new Date());
$("todayBtn").onclick=()=>{
  $("focusDate").value=iso(new Date());
  renderDashboard();
};

let activeRange="day";
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeRange=t.dataset.range;
    renderDashboard();
  };
});

/* ===== PLACEHOLDER DASHBOARD (kommt voll in Teil 3) ===== */
function renderDashboard(){
  $("kpiGrid").innerHTML=`
    <div class="kpi"><div class="v">0</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">0</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">0</div><div class="l">Kilometer</div></div>
    <div class="kpi"><div class="v">‚Äì</div><div class="l">√ò Pace</div></div>
    <div class="kpi"><div class="v">‚Äì</div><div class="l">√ò HF</div></div>
    <div class="kpi"><div class="v">0</div><div class="l">Sessions</div></div>
  `;
}
renderDashboard();
</script>
<!-- ===================== SECTION 2: SPORT-TRACKER ===================== -->
<div class="card" id="sportSection">
  <h3>üèãÔ∏è Sport Tracker (Multi-Sessions)</h3>
  <div class="small">Mehrere Sessions pro Tag. Kein Fokusverlust beim Tippen. Uhrzeit optional.</div>

  <div class="row" style="margin-top:10px;">
    <div style="min-width:220px;">
      <div class="small">Datum</div>
      <input id="entryDate" type="date" />
    </div>

    <button id="addSessionBtn">+ Session</button>
    <button id="clearDayBtn" class="danger">Tag l√∂schen</button>
  </div>

  <div class="small" style="margin-top:10px;">
    Joggen/Schwimmen: Dauer + KM + Pace + √ò HF. Andere: Dauer + Kalorien + √ò HF.
  </div>

  <div id="sessionList" style="margin-top:12px;"></div>
</div>

<script>
/* ===================== SPORT SECTION LOGIC ===================== */
const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

function saveDB(){
  localStorage.setItem(KEY_DATA, JSON.stringify(db));
}

function getDay(dateIso){
  if(!Array.isArray(db[dateIso])) db[dateIso] = [];
  return db[dateIso];
}

// init entry date = focus date
const entryDateInput = document.getElementById("entryDate");
entryDateInput.value = document.getElementById("focusDate").value;

// Buttons
document.getElementById("addSessionBtn").onclick = () => {
  const d = entryDateInput.value;
  getDay(d).push({
    time: "",
    type: "",
    duration: "",
    calories: "",
    km: "",
    pace: "",
    hr: ""
  });
  saveDB();
  renderSessions();
};

document.getElementById("clearDayBtn").onclick = () => {
  const d = entryDateInput.value;
  delete db[d];
  saveDB();
  renderSessions();
};

// Wenn Datum ge√§ndert wird -> neue Liste laden
entryDateInput.addEventListener("change", () => renderSessions());

// Session UI (WICHTIG: kein Re-render bei jedem Input -> kein Fokusverlust)
function renderSessions(){
  const d = entryDateInput.value;
  const list = document.getElementById("sessionList");
  const arr = getDay(d);

  if(!arr.length){
    list.innerHTML = `<div class="small muted">Noch keine Sessions an diesem Tag.</div>`;
    return;
  }

  list.innerHTML = arr.map((s,i)=>{
    const isKm = KM_SPORTS.has(s.type);
    return `
      <div class="card" style="background:#0b0b0b; border-color:#262626; margin-top:10px;">
        <div class="row" style="justify-content:space-between;">
          <strong>Session ${i+1}</strong>
          <button class="danger" data-del="${i}">L√∂schen</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <div style="min-width:140px;">
            <div class="small">Uhrzeit</div>
            <input data-i="${i}" data-k="time" placeholder="19:31" value="${s.time||""}">
          </div>

          <div class="grow" style="min-width:190px;">
            <div class="small">Sportart</div>
            <select data-i="${i}" data-k="type">
              <option value="">‚Äî</option>
              ${SPORTS.map(x=>`<option value="${x}" ${x===s.type?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>

          <div style="min-width:140px;">
            <div class="small">Dauer (min)</div>
            <input data-i="${i}" data-k="duration" type="number" min="0" inputmode="numeric" value="${s.duration||""}">
          </div>

          <div style="min-width:140px;">
            <div class="small">Kalorien</div>
            <input data-i="${i}" data-k="calories" type="number" min="0" inputmode="numeric" value="${s.calories||""}">
          </div>

          <div style="min-width:140px;">
            <div class="small">Kilometer</div>
            <input data-i="${i}" data-k="km" type="number" min="0" step="0.01" inputmode="decimal"
              ${isKm ? "" : "disabled"} value="${s.km||""}">
          </div>

          <div style="min-width:140px;">
            <div class="small">Pace (mm:ss)</div>
            <input data-i="${i}" data-k="pace" placeholder="5:30"
              ${isKm ? "" : "disabled"} value="${s.pace||""}">
          </div>

          <div style="min-width:140px;">
            <div class="small">√ò HF</div>
            <input data-i="${i}" data-k="hr" type="number" min="0" inputmode="numeric" value="${s.hr||""}">
          </div>
        </div>
      </div>
    `;
  }).join("");

  attachSessionHandlers();
}

// Event handling OHNE Fokusverlust:
// - wir speichern "oninput", aber rendern NICHT neu
// - nur bei Sportart-Wechsel rendern wir neu (wegen km/pace enable/disable)
function attachSessionHandlers(){
  const list = document.getElementById("sessionList");
  const d = entryDateInput.value;

  // Delete
  list.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = () => {
      const i = Number(btn.dataset.del);
      const arr = getDay(d);
      arr.splice(i,1);
      if(!arr.length) delete db[d];
      saveDB();
      renderSessions();
    };
  });

  // Inputs
  list.querySelectorAll("input[data-i], select[data-i]").forEach(el=>{
    const i = Number(el.dataset.i);
    const k = el.dataset.k;

    if(el.tagName === "SELECT"){
      el.onchange = () => {
        getDay(d)[i][k] = el.value;
        saveDB();
        // Nur bei type neu rendern (enable/disable)
        renderSessions();
      };
      return;
    }

    // normal inputs: speichern ohne re-render
    el.addEventListener("input", () => {
      getDay(d)[i][k] = el.value;
      saveDB();
      // KEIN renderSessions() -> Fokus bleibt stabil
    });
  });
}

// Start
renderSessions();
<script>
/* ===================== DASHBOARD + CHARTS ===================== */

/* ---------- Helpers ---------- */
function safeNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function parsePace(p){
  if(!p || !p.includes(":")) return null;
  const [m,s] = p.split(":").map(Number);
  if(!Number.isFinite(m)||!Number.isFinite(s)||s>59) return null;
  return m*60+s;
}
function paceFromSeconds(sec){
  const t=Math.round(sec);
  return `${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
}

/* ---------- Range handling ---------- */
function inRange(dateIso, range){
  const d = new Date(dateIso);
  const f = new Date(document.getElementById("focusDate").value);

  if(range==="day") return dateIso === document.getElementById("focusDate").value;
  if(range==="month") return d.getMonth()===f.getMonth() && d.getFullYear()===f.getFullYear();
  if(range==="year") return d.getFullYear()===f.getFullYear();
  if(range==="all") return true;

  if(range==="week"){
    const fd = new Date(f);
    const monday = new Date(fd);
    const day = monday.getDay() || 7;
    monday.setDate(fd.getDate() - day + 1);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate()+6);
    return d>=monday && d<=sunday;
  }
  return false;
}

/* ---------- Aggregation ---------- */
function aggregate(range){
  let cal=0,min=0,km=0,paceSum=0,paceKm=0,hrSum=0,hrMin=0,sess=0;

  for(const [d,arr] of Object.entries(db)){
    if(!inRange(d,range)) continue;
    arr.forEach(s=>{
      sess++;
      const m=safeNum(s.duration);
      min+=m;
      cal+=safeNum(s.calories);

      if(KM_SPORTS.has(s.type)){
        const k=safeNum(s.km);
        const ps=parsePace(s.pace);
        km+=k;
        if(ps && k){
          paceSum+=ps*k;
          paceKm+=k;
        }
      }

      const hr=safeNum(s.hr);
      if(hr && m){
        hrSum+=hr*m;
        hrMin+=m;
      }
    });
  }

  return {
    calories:cal,
    minutes:min,
    km:km,
    avgPace: paceKm ? paceFromSeconds(paceSum/paceKm) : "‚Äì",
    avgHr: hrMin ? Math.round(hrSum/hrMin) : "‚Äì",
    sessions:sess
  };
}

/* ---------- Render Dashboard ---------- */
function renderDashboard(){
  const a = aggregate(activeRange);
  document.getElementById("kpiGrid").innerHTML = `
    <div class="kpi"><div class="v">${a.calories}</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">${a.minutes}</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">${a.km.toFixed(1)}</div><div class="l">Kilometer</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">√ò Pace</div></div>
    <div class="kpi"><div class="v">${a.avgHr}</div><div class="l">√ò HF</div></div>
    <div class="kpi"><div class="v">${a.sessions}</div><div class="l">Sessions</div></div>
  `;
}

/* ---------- Chart Drawing (Line) ---------- */
function drawLine(canvas, values, labels, title, unit){
  const ctx=canvas.getContext("2d");
  const dpr=window.devicePixelRatio||1;
  const w=canvas.clientWidth;
  const h=canvas.clientHeight;
  canvas.width=w*dpr; canvas.height=h*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,w,h);

  const padL=46,padR=10,padT=26,padB=30;
  const max=Math.max(1,...values);
  const innerW=w-padL-padR;
  const innerH=h-padT-padB;

  ctx.fillStyle="#fff";
  ctx.font="13px system-ui";
  ctx.fillText(title,10,18);

  ctx.strokeStyle="#1f1f1f";
  ctx.font="11px system-ui";
  ctx.fillStyle="#999";

  for(let i=0;i<=5;i++){
    const v=max/5*i;
    const y=h-padB-(v/max)*innerH;
    ctx.beginPath();
    ctx.moveTo(padL,y); ctx.lineTo(w-padR,y); ctx.stroke();
    ctx.fillText(Math.round(v)+" "+unit,6,y+4);
  }

  ctx.strokeStyle="#00ff6a";
  ctx.lineWidth=2;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x=padL + (i/(values.length-1||1))*innerW;
    const y=h-padB-(v/max)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle="#00ff6a";
  values.forEach((v,i)=>{
    if(v<=0) return;
    const x=padL + (i/(values.length-1||1))*innerW;
    const y=h-padB-(v/max)*innerH;
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.fillText(Math.round(v),x-6,y-8);
    ctx.fillStyle="#00ff6a";
  });
}

/* ---------- Render Charts ---------- */
function renderCharts(){
  const f = new Date(document.getElementById("focusDate").value);
  const days = new Date(f.getFullYear(), f.getMonth()+1, 0).getDate();
  const labels=[], cal=[], km=[];

  for(let d=1;d<=days;d++){
    const isoDay = `${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    labels.push(String(d));
    let c=0,k=0;
    (db[isoDay]||[]).forEach(s=>{
      c+=safeNum(s.calories);
      if(KM_SPORTS.has(s.type)) k+=safeNum(s.km);
    });
    cal.push(c);
    km.push(k);
  }

  drawLine(document.getElementById("calorieChart"), cal, labels, "Kalorien pro Tag", "kcal");
  drawLine(document.getElementById("kmChart"), km, labels, "Kilometer pro Tag", "km");
}

/* ---------- OCR IMPORT (Datum + Uhrzeit, best effort) ---------- */
const shotBtn=document.getElementById("shotBtn");
const shotFile=document.getElementById("shotFile");
const ocrStatus=document.getElementById("ocrStatus");

shotBtn.onclick=()=>shotFile.click();

shotFile.onchange=async()=>{
  const file=shotFile.files[0];
  if(!file) return;
  ocrStatus.textContent="OCR l√§uft‚Ä¶";

  const img=new Image();
  img.src=URL.createObjectURL(file);
  await img.decode();

  const c=document.createElement("canvas");
  c.width=img.width; c.height=img.height;
  c.getContext("2d").drawImage(img,0,0);

  const res=await Tesseract.recognize(c,"deu+eng");
  const t=res.data.text.replace(/\s+/g," ");

  const dateMatch=t.match(/(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{4})/);
  const timeMatch=t.match(/([01]?\d|2[0-3]):([0-5]\d)/);

  const dateIso = dateMatch
    ? `${dateMatch[3]}-${String(dateMatch[2]).padStart(2,"0")}-${String(dateMatch[1]).padStart(2,"0")}`
    : document.getElementById("entryDate").value;

  const time = timeMatch ? timeMatch[0] : "";

  const cal = (t.match(/(\d+)\s*kcal/i)||[])[1]||"";
  const kmv = (t.match(/(\d+[.,]\d+)\s*km/i)||[])[1]?.replace(",","")||"";
  const dur = (t.match(/(\d+)\s*min/i)||[])[1]||"";
  const hr  = (t.match(/(\d+)\s*bpm/i)||[])[1]||"";

  getDay(dateIso).push({
    time, type: kmv?"Joggen":"Krafttraining",
    duration:dur, calories:cal, km:kmv, pace:"", hr
  });
  saveDB();
  document.getElementById("entryDate").value=dateIso;
  renderSessions();
  renderAll();
  ocrStatus.textContent="Importiert ‚úÖ";
};

/* ---------- MASTER ---------- */
function renderAll(){
  renderDashboard();
  renderCharts();
}
renderAll();
</script>
</script>
</body>
</html>
