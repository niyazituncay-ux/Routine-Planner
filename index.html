<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
:root{
  --bg:#000; --fg:#fff; --muted:#9a9a9a; --line:#262626;
  --panel:#0c0c0c; --panel2:#101010; --accent:#00ff6a; --danger:#ff5b5b;
}
*{box-sizing:border-box}
body{
  background:var(--bg); color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  max-width:1200px; margin:20px auto; padding:0 14px 60px;
}
h1{margin:0;font-size:30px;letter-spacing:-.2px}
h2{margin:6px 0 0;font-size:14px;color:var(--muted);font-weight:600}
h3{margin:0 0 10px;font-size:16px}
.small{font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}
.card{
  border:1px solid var(--line);
  background:var(--panel);
  border-radius:16px;
  padding:14px;
  margin-top:14px;
  overflow:hidden;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1;min-width:220px}
input,select,textarea{
  width:100%;
  background:var(--panel2); color:var(--fg);
  border:1px solid var(--line); border-radius:12px;
  padding:9px 10px;
}
button{
  border:1px solid var(--line);
  background:#111; color:var(--fg);
  border-radius:12px; padding:9px 12px;
  cursor:pointer;
}
button:hover{background:#151515}
.danger{color:var(--danger);border-color:#3a1a1a}

/* Tabs */
.tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.tab{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  cursor:pointer;
  user-select:none;
}
.tab.active{
  background:rgba(0,255,106,.15);
  color:var(--fg);
  border-color:#1b4f30;
}

/* KPI */
.kpiGrid{
  display:grid;
  grid-template-columns:repeat(3,minmax(140px,1fr));
  gap:10px;
  margin-top:12px;
}
@media (max-width:900px){
  .kpiGrid{grid-template-columns:repeat(2,minmax(140px,1fr))}
}
.kpi{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:#0b0b0b;
}
.kpi .v{font-size:22px;font-weight:900;color:var(--accent);line-height:1.1}
.kpi .l{font-size:12px;color:var(--muted);margin-top:6px}

/* Charts */
.chartGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
@media (max-width:900px){ .chartGrid{grid-template-columns:1fr} }
.chartWrap{
  border:1px solid var(--line);
  border-radius:16px;
  background:#080808;
  padding:10px;
  overflow:hidden;
}
canvas{width:100%;height:260px;display:block;background:#080808;border-radius:12px}

/* Calendar */
.calHead{
  display:flex; justify-content:space-between; align-items:center;
  gap:10px; flex-wrap:wrap; margin-bottom:10px;
}
.calBtnRow{display:flex;gap:8px;flex-wrap:wrap}
.calendar{
  width:100%;
  border-collapse:collapse;
  border:1px solid var(--line);
  border-radius:16px;
  overflow:hidden;
  background:#080808;
}
.calendar th,.calendar td{
  border-right:1px solid var(--line);
  border-bottom:1px solid var(--line);
  padding:10px; vertical-align:top; height:72px;
}
.calendar th:last-child,.calendar td:last-child{border-right:none}
.calendar tr:last-child td{border-bottom:none}
.calCell{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
.calDay{font-weight:900}
.calDim{color:#444}
.calCheck{
  width:22px;height:22px;border-radius:999px;
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid #1b4f30;background:rgba(0,255,106,.12);
  color:var(--accent);font-weight:900;font-size:12px;
}
.fileHidden{position:absolute;left:-9999px;width:1px;height:1px;opacity:0}

/* Sessions */
.sessionCard{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background:#0b0b0b;
  margin-top:10px;
}
.sessionHeader{
  display:flex;justify-content:space-between;align-items:center;
  gap:10px;flex-wrap:wrap;
}
.sessionGrid{
  display:grid;
  grid-template-columns:repeat(6,minmax(140px,1fr));
  gap:10px;
  margin-top:10px;
}
@media (max-width:900px){ .sessionGrid{grid-template-columns:1fr 1fr} }
</style>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>

<div class="card">
  <div class="row">
    <div class="grow">
      <h1 id="appTitle">Sport Tracker</h1>
      <h2>Multi-Sessions ¬∑ OCR Import ¬∑ Kalender ¬∑ Strichdiagramme</h2>
      <div class="small">Speichert lokal im Browser. (Archiv bleibt bis Website-Daten gel√∂scht werden)</div>
    </div>
    <div class="grow">
      <div class="small">Profilname</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay">
    </div>
    <button id="saveProfile">Speichern</button>
  </div>
</div>

<div class="card" id="dashboard">
  <h3>üìä Dashboard</h3>
  <div class="tabs">
    <div class="tab active" data-range="day">Tag</div>
    <div class="tab" data-range="week">Woche</div>
    <div class="tab" data-range="month">Monat</div>
    <div class="tab" data-range="year">Jahr</div>
    <div class="tab" data-range="all">Gesamt</div>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="focusDate" type="date" style="max-width:220px">
    <button id="todayBtn">Heute</button>
  </div>

  <div class="kpiGrid" id="kpiGrid"></div>

  <div class="chartGrid">
    <div class="chartWrap">
      <div class="small muted" style="margin-bottom:6px;">Kalorien pro Tag (Monat)</div>
      <canvas id="calorieChart"></canvas>
    </div>
    <div class="chartWrap">
      <div class="small muted" style="margin-bottom:6px;">Kilometer pro Tag (Joggen+Schwimmen)</div>
      <canvas id="kmChart"></canvas>
    </div>
  </div>
</div>

<div class="card" id="calendarCard">
  <h3>üóìÔ∏è Monatskalender</h3>
  <div class="small muted">‚úì wenn du an dem Tag mindestens 1 Session hast. Klick setzt Datum.</div>

  <div class="calHead">
    <div class="calBtnRow">
      <button id="calPrev">‚óÄ</button>
      <button id="calNext">‚ñ∂</button>
      <button id="calThis">Dieser Monat</button>
    </div>
    <div style="font-weight:900" id="calLabel">‚Äî</div>
  </div>

  <div style="overflow:auto">
    <table class="calendar" id="monthCal"></table>
  </div>
</div>

<script>
/* ===================== STATE ===================== */
const KEY_DATA="sport_db_v4";
const KEY_PROFILE="sport_profile_v4";

let db = (()=>{ try{return JSON.parse(localStorage.getItem(KEY_DATA)||"{}");}catch{return{};} })();
let profile = localStorage.getItem(KEY_PROFILE)||"";

const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,"0");
const iso = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function safeNum(v){ const n=Number(v); return Number.isFinite(n)?n:0; }
function saveDB(){ localStorage.setItem(KEY_DATA, JSON.stringify(db)); }

const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

function getDay(dayIso){
  if(!Array.isArray(db[dayIso])) db[dayIso]=[];
  return db[dayIso];
}

/* ===================== INIT UI ===================== */
$("profileName").value = profile;
$("appTitle").textContent = profile || "Sport Tracker";
$("saveProfile").onclick = ()=>{
  profile = $("profileName").value.trim();
  localStorage.setItem(KEY_PROFILE, profile);
  $("appTitle").textContent = profile || "Sport Tracker";
};

$("focusDate").value = iso(new Date());
$("todayBtn").onclick = ()=>{
  $("focusDate").value = iso(new Date());
  renderAll();
};

let activeRange="day";
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeRange = t.dataset.range;
    renderAll();
  };
});
</script>
<div class="card" id="sportSection">
  <h3>üèãÔ∏è Sport Tracker (Multi-Sessions)</h3>
  <div class="small">Datum w√§hlen ‚Üí Sessions geh√∂ren exakt zu diesem Datum. Dashboard springt automatisch mit.</div>

  <div class="row" style="margin-top:10px;">
    <div style="min-width:220px;">
      <div class="small">Datum</div>
      <input id="entryDate" type="date" />
    </div>
    <button id="addSessionBtn">+ Session</button>
    <button id="clearDayBtn" class="danger">Tag l√∂schen</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="shotBtn">üì∑ Screenshot / Foto importieren</button>
    <div id="ocrStatus" class="small muted"></div>
    <input id="shotFile" class="fileHidden" type="file" accept="image/*">
  </div>

  <div id="sessionList" style="margin-top:12px;"></div>
</div>

<script>
/* ===================== DATE SYNC (WICHTIG) ===================== */
const entryDateInput = $("entryDate");
entryDateInput.value = $("focusDate").value;

function syncFocusToEntry(){
  const e = entryDateInput.value;
  if(e && $("focusDate").value !== e){
    $("focusDate").value = e;
  }
}

/* ===================== BUTTONS ===================== */
$("addSessionBtn").onclick = ()=>{
  const d = entryDateInput.value;
  getDay(d).push({ time:"", type:"", duration:"", calories:"", km:"", pace:"", hr:"" });
  saveDB();
  syncFocusToEntry();
  renderSessions();
  renderAll();
};

$("clearDayBtn").onclick = ()=>{
  const d = entryDateInput.value;
  delete db[d];
  saveDB();
  syncFocusToEntry();
  renderSessions();
  renderAll();
};

entryDateInput.addEventListener("change", ()=>{
  syncFocusToEntry();
  renderSessions();
  renderAll();
});

/* ===================== SESSIONS RENDER ===================== */
function renderSessions(){
  const d = entryDateInput.value;
  const list = $("sessionList");
  const arr = getDay(d);

  if(!arr.length){
    list.innerHTML = `<div class="small muted">Noch keine Sessions an diesem Tag.</div>`;
    return;
  }

  list.innerHTML = arr.map((s,i)=>{
    const isKm = KM_SPORTS.has(s.type);
    return `
      <div class="sessionCard">
        <div class="sessionHeader">
          <strong>Session ${i+1}</strong>
          <button class="danger" data-del="${i}">L√∂schen</button>
        </div>

        <div class="sessionGrid">
          <div>
            <div class="small">Uhrzeit</div>
            <input data-i="${i}" data-k="time" placeholder="19:31" value="${s.time||""}">
          </div>

          <div>
            <div class="small">Sportart</div>
            <select data-i="${i}" data-k="type">
              <option value="">‚Äî</option>
              ${SPORTS.map(x=>`<option value="${x}" ${x===s.type?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>

          <div>
            <div class="small">Dauer (min)</div>
            <input data-i="${i}" data-k="duration" type="number" min="0" inputmode="numeric" value="${s.duration||""}">
          </div>

          <div>
            <div class="small">Kalorien</div>
            <input data-i="${i}" data-k="calories" type="number" min="0" inputmode="numeric" value="${s.calories||""}">
          </div>

          <div>
            <div class="small">Kilometer</div>
            <input data-i="${i}" data-k="km" type="number" min="0" step="0.01" inputmode="decimal"
              ${isKm ? "" : "disabled"} value="${s.km||""}">
          </div>

          <div>
            <div class="small">Pace (mm:ss)</div>
            <input data-i="${i}" data-k="pace" placeholder="5:30"
              ${isKm ? "" : "disabled"} value="${s.pace||""}">
          </div>

          <div>
            <div class="small">√ò HF</div>
            <input data-i="${i}" data-k="hr" type="number" min="0" inputmode="numeric" value="${s.hr||""}">
          </div>
        </div>
      </div>
    `;
  }).join("");

  attachSessionHandlers();
}

function attachSessionHandlers(){
  const d = entryDateInput.value;
  const list = $("sessionList");

  list.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick=()=>{
      const i=Number(btn.dataset.del);
      const arr=getDay(d);
      arr.splice(i,1);
      if(!arr.length) delete db[d];
      saveDB();
      syncFocusToEntry();
      renderSessions();
      renderAll();
    };
  });

  list.querySelectorAll("input[data-i], select[data-i]").forEach(el=>{
    const i=Number(el.dataset.i);
    const k=el.dataset.k;

    if(el.tagName==="SELECT"){
      el.onchange=()=>{
        getDay(d)[i][k]=el.value;
        saveDB();
        syncFocusToEntry();
        renderSessions(); // enable/disable km/pace
        renderAll();
      };
      return;
    }

    el.addEventListener("input", ()=>{
      getDay(d)[i][k]=el.value;
      saveDB();
      syncFocusToEntry();
      renderAll();
    });
  });
}

renderSessions();
</script>
<script>
/* ===================== AGGREGATION ===================== */
function parsePace(p){
  if(!p || !p.includes(":")) return null;
  const [m,s] = p.split(":").map(Number);
  if(!Number.isFinite(m)||!Number.isFinite(s)||s<0||s>59||m<0) return null;
  return m*60+s;
}
function paceFromSeconds(sec){
  const t=Math.round(sec);
  return `${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
}

function inRange(dayIso, range){
  const d=new Date(dayIso);
  const f=new Date($("focusDate").value);

  if(range==="day") return dayIso === $("focusDate").value;
  if(range==="month") return d.getMonth()===f.getMonth() && d.getFullYear()===f.getFullYear();
  if(range==="year") return d.getFullYear()===f.getFullYear();
  if(range==="all") return true;

  if(range==="week"){
    const fd=new Date(f);
    const monday=new Date(fd);
    const dow = monday.getDay() || 7;
    monday.setDate(fd.getDate()-dow+1);
    const sunday=new Date(monday);
    sunday.setDate(monday.getDate()+6);
    return d>=monday && d<=sunday;
  }
  return false;
}

function aggregate(range){
  let calSum=0,minSum=0,kmSum=0,sessions=0;
  let paceSum=0, paceKm=0;
  let hrSum=0, hrW=0;

  for(const [dayIso, arr] of Object.entries(db)){
    if(!inRange(dayIso, range)) continue;
    if(!Array.isArray(arr)) continue;

    for(const s of arr){
      sessions++;
      const mins=safeNum(s.duration);
      const kcal=safeNum(s.calories);
      calSum += kcal;
      minSum += mins;

      if(KM_SPORTS.has(s.type)){
        const km=safeNum(s.km);
        kmSum += km;
        const ps=parsePace(s.pace);
        if(ps!=null && km>0){
          paceSum += ps*km;
          paceKm += km;
        }
      }

      const hr=safeNum(s.hr);
      const w = mins>0 ? mins : (hr>0 ? 1 : 0);
      if(hr>0 && w>0){
        hrSum += hr*w;
        hrW += w;
      }
    }
  }

  return {
    caloriesTotal: Math.round(calSum),
    minutesTotal: Math.round(minSum),
    kmTotal: kmSum,
    sessionsTotal: sessions,
    avgPace: paceKm ? paceFromSeconds(paceSum/paceKm) : "‚Äì",
    avgHr: hrW ? Math.round(hrSum/hrW) : "‚Äì",
    avgCaloriesPerSession: sessions ? Math.round(calSum/sessions) : 0,
    avgMinutesPerSession: sessions ? Math.round(minSum/sessions) : 0
  };
}

function renderDashboard(){
  const a=aggregate(activeRange);
  $("kpiGrid").innerHTML = `
    <div class="kpi"><div class="v">${a.caloriesTotal}</div><div class="l">Kalorien (Summe)</div></div>
    <div class="kpi"><div class="v">${a.minutesTotal}</div><div class="l">Minuten (Summe)</div></div>
    <div class="kpi"><div class="v">${a.kmTotal.toFixed(1)}</div><div class="l">KM (Summe)</div></div>

    <div class="kpi"><div class="v">${a.sessionsTotal}</div><div class="l">Sessions</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">√ò Pace</div></div>
    <div class="kpi"><div class="v">${a.avgHr}</div><div class="l">√ò Herzfrequenz</div></div>
  `;
}

/* ===================== CHARTS (Month, High-DPI Line) ===================== */
function drawLine(canvas, values, title, unit){
  const ctx=canvas.getContext("2d");
  const dpr=window.devicePixelRatio||1;
  const cssW=canvas.clientWidth;
  const cssH=canvas.clientHeight;

  canvas.width=Math.max(1,Math.floor(cssW*dpr));
  canvas.height=Math.max(1,Math.floor(cssH*dpr));
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const w=cssW, h=cssH;
  ctx.clearRect(0,0,w,h);

  const padL=54,padR=12,padT=26,padB=34;
  const innerW=w-padL-padR, innerH=h-padT-padB;
  const max=Math.max(1,...values);

  ctx.fillStyle="#fff";
  ctx.font="13px system-ui";
  ctx.fillText(title,10,18);

  ctx.strokeStyle="#1f1f1f";
  ctx.fillStyle="#999";
  ctx.font="11px system-ui";
  for(let i=0;i<=5;i++){
    const v=max/5*i;
    const y=h-padB-(v/max)*innerH;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(w-padR,y); ctx.stroke();
    ctx.fillText(`${Math.round(v)} ${unit}`, 8, y+4);
  }

  ctx.strokeStyle="#00ff6a";
  ctx.lineWidth=2;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x=padL + (i/Math.max(1,values.length-1))*innerW;
    const y=h-padB-(v/max)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  const step = values.length>16 ? Math.ceil(values.length/16) : 1;
  ctx.fillStyle="#00ff6a";
  values.forEach((v,i)=>{
    if(v<=0) return;
    if(i%step!==0 && i!==values.length-1) return;
    const x=padL + (i/Math.max(1,values.length-1))*innerW;
    const y=h-padB-(v/max)*innerH;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#fff"; ctx.fillText(Math.round(v),x-8,y-10);
    ctx.fillStyle="#00ff6a";
  });
}

function monthSeries(){
  const f=new Date($("focusDate").value);
  const days=new Date(f.getFullYear(), f.getMonth()+1, 0).getDate();
  const cal=[], km=[];
  for(let d=1; d<=days; d++){
    const dayIso=`${f.getFullYear()}-${pad(f.getMonth()+1)}-${pad(d)}`;
    let c=0,k=0;
    (db[dayIso]||[]).forEach(s=>{
      c += safeNum(s.calories);
      if(KM_SPORTS.has(s.type)) k += safeNum(s.km);
    });
    cal.push(c); km.push(k);
  }
  return {cal, km, y:f.getFullYear(), m:f.getMonth()};
}

function renderCharts(){
  const s=monthSeries();
  drawLine($("calorieChart"), s.cal, "Kalorien pro Tag", "kcal");
  drawLine($("kmChart"), s.km, "Kilometer pro Tag", "km");
}

/* ===================== MONTH CALENDAR ===================== */
let calView = (()=>{ const f=new Date($("focusDate").value); return {y:f.getFullYear(), m:f.getMonth()}; })();

function hasTraining(dayIso){
  const arr=db[dayIso];
  return Array.isArray(arr) && arr.length>0;
}

function renderCalendar(){
  const y=calView.y, m=calView.m;
  const first=new Date(y,m,1);
  const last=new Date(y,m+1,0);
  const startDow=(first.getDay()+6)%7; // Mo=0
  const days=last.getDate();

  $("calLabel").textContent = first.toLocaleDateString("de-DE",{month:"long",year:"numeric"});

  const names=["Mo","Di","Mi","Do","Fr","Sa","So"];
  let html=`<tr>${names.map(n=>`<th class="small muted">${n}</th>`).join("")}</tr>`;

  let d=1;
  for(let r=0;r<6;r++){
    let row="<tr>";
    for(let c=0;c<7;c++){
      const idx=r*7+c;
      if(idx<startDow || d>days){
        row += `<td><span class="calDim"> </span></td>`;
      }else{
        const dayIso=`${y}-${pad(m+1)}-${pad(d)}`;
        const check = hasTraining(dayIso) ? `<span class="calCheck">‚úì</span>` : "";
        row += `
          <td data-iso="${dayIso}" style="cursor:pointer">
            <div class="calCell">
              <div class="calDay">${d}</div>
              ${check}
            </div>
          </td>`;
        d++;
      }
    }
    row+="</tr>";
    html+=row;
    if(d>days) break;
  }
  $("monthCal").innerHTML=html;

  $("monthCal").querySelectorAll("td[data-iso]").forEach(td=>{
    td.onclick=()=>{
      const dayIso=td.dataset.iso;
      $("focusDate").value=dayIso;
      entryDateInput.value=dayIso;
      calView={y:new Date(dayIso).getFullYear(), m:new Date(dayIso).getMonth()};
      renderSessions();
      renderAll();
    };
  });
}

$("calPrev").onclick=()=>{
  calView.m--; if(calView.m<0){calView.m=11;calView.y--;}
  renderCalendar();
};
$("calNext").onclick=()=>{
  calView.m++; if(calView.m>11){calView.m=0;calView.y++;}
  renderCalendar();
};
$("calThis").onclick=()=>{
  const f=new Date($("focusDate").value);
  calView={y:f.getFullYear(), m:f.getMonth()};
  renderCalendar();
};

/* ===================== OCR (Datum zuverl√§ssig) ===================== */
function parseDateFromText(t){
  let m=t.match(/(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})/);
  if(m){
    let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy+=2000;
    if(dd>=1&&dd<=31&&mm>=1&&mm<=12) return `${yy}-${pad(mm)}-${pad(dd)}`;
  }
  m=t.match(/(20\d{2})[.\-/](\d{1,2})[.\-/](\d{1,2})/);
  if(m){
    const yy=+m[1], mm=+m[2], dd=+m[3];
    if(dd>=1&&dd<=31&&mm>=1&&mm<=12) return `${yy}-${pad(mm)}-${pad(dd)}`;
  }
  return null;
}
function parseTimeFromText(t){
  const m=t.match(/([01]?\d|2[0-3])[:. ]([0-5]\d)/);
  return m ? `${pad(m[1])}:${pad(m[2])}` : "";
}
function bestDateForOCR(t){
  // Wichtig: wenn kein Datum im Bild => entryDate (zuverl√§ssig)
  return parseDateFromText(t) || entryDateInput.value || $("focusDate").value || iso(new Date());
}

$("shotBtn").onclick=()=>$("shotFile").click();
$("shotFile").onchange=async()=>{
  const file=$("shotFile").files && $("shotFile").files[0];
  if(!file) return;
  $("ocrStatus").textContent="OCR l√§uft‚Ä¶";

  try{
    const img=new Image();
    img.src=URL.createObjectURL(file);
    await img.decode();

    const maxDim=1800;
    const scale=Math.min(1, maxDim/Math.max(img.width,img.height));
    const c=document.createElement("canvas");
    c.width=Math.round(img.width*scale);
    c.height=Math.round(img.height*scale);
    const ctx=c.getContext("2d");
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,c.width,c.height);
    ctx.drawImage(img,0,0,c.width,c.height);

    const res=await Tesseract.recognize(c,"deu+eng");
    const t=(res.data.text||"").replace(/\s+/g," ").trim();

    const dayIso = bestDateForOCR(t);
    const time = parseTimeFromText(t);

    const dur=(t.match(/(\d+)\s*min/i)||[])[1]||"";
    const cal=(t.match(/(\d+)\s*kcal/i)||[])[1]||"";
    const kmv=(t.match(/(\d+(?:[.,]\d+)?)\s*km/i)||[])[1]||"";
    const hr =(t.match(/(\d+)\s*bpm/i)||[])[1]||"";
    const kmNorm = kmv ? kmv.replace(",",".") : "";

    getDay(dayIso).push({
      time,
      type: kmNorm ? "Joggen" : "Krafttraining",
      duration: dur,
      calories: cal,
      km: kmNorm,
      pace: "",
      hr: hr
    });
    saveDB();

    // UI auf richtigen Tag setzen
    $("focusDate").value = dayIso;
    entryDateInput.value = dayIso;
    calView={y:new Date(dayIso).getFullYear(), m:new Date(dayIso).getMonth()};

    renderSessions();
    renderAll();
    $("ocrStatus").textContent = `Importiert ‚úÖ (${dayIso}${time?(" "+time):""})`;
  }catch(e){
    console.error(e);
    $("ocrStatus").textContent="OCR Fehler ‚ùå";
  }finally{
    $("shotFile").value="";
  }
};

/* ===================== MASTER ===================== */
function renderAll(){
  renderDashboard();
  renderCharts();
  renderCalendar();
}

$("focusDate").addEventListener("change", ()=>{
  entryDateInput.value = $("focusDate").value;
  calView={y:new Date($("focusDate").value).getFullYear(), m:new Date($("focusDate").value).getMonth()};
  renderSessions();
  renderAll();
});

// initial
renderAll();
</script>

</body>
</html>