<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
  :root{
    --bg:#000;
    --fg:#fff;
    --muted:#a8a8a8;
    --line:#262626;
    --panel:#0c0c0c;
    --panel2:#101010;
    --accent:#00ff6a;
    --warn:#ffcc00;
    --bad:#ff5b5b;
  }
  body{
    background:var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    max-width: 1250px;
    margin: 34px auto;
    padding: 0 16px 44px;
  }
  h1{ margin:0; font-size:30px; letter-spacing:-0.3px; }
  h2{ margin:6px 0 0; font-size:16px; color:var(--muted); font-weight:600; }
  h3{ margin:0 0 10px; font-size:16px; }
  .small{ font-size:12px; color:var(--muted); }
  .muted{ color:var(--muted); }
  hr{ border:none; border-top:1px solid var(--line); margin: 18px 0; }

  .topbar{
    border:1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    background: linear-gradient(180deg, #0f0f0f, #080808);
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
    position:relative;
    overflow:hidden;
  }
  .topbar::before{
    content:"";
    position:absolute;
    right:-80px; top:-90px;
    width:260px; height:260px;
    border-radius:999px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,106,0.22), rgba(0,0,0,0) 60%);
    pointer-events:none;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .grow{ flex: 1; min-width: 240px; }

  input, select{
    width: 100%;
    box-sizing:border-box;
    background: var(--panel2);
    color: var(--fg);
    border:1px solid var(--line);
    border-radius: 12px;
    padding: 8px 10px;
  }
  button{
    border:1px solid var(--line);
    background: #111;
    color: var(--fg);
    border-radius: 12px;
    padding: 9px 12px;
    cursor:pointer;
  }
  button:hover{ background:#151515; }
  .danger{ color: var(--bad); border-color:#3a1a1a; }
  .ghost{ background: transparent; }

  .card{
    border:1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    background: var(--panel);
    margin-top: 12px;
  }

  /* ===== DASHBOARD ===== */
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-top: 10px;
  }
  .tab{
    padding: 7px 10px;
    border-radius: 999px;
    border:1px solid var(--line);
    background: #0f0f0f;
    color: var(--muted);
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background: rgba(0,255,106,0.12);
    color: var(--fg);
    border-color:#1b4f30;
  }

  .dashGrid{
    display:grid;
    grid-template-columns: 1.05fr 0.95fr;
    gap:12px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .dashGrid{ grid-template-columns: 1fr; }
  }

  .kpiGrid{
    display:grid;
    grid-template-columns: repeat(4, minmax(140px, 1fr));
    gap:10px;
  }
  @media (max-width: 980px){
    .kpiGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
  }
  .kpi{
    border:1px solid var(--line);
    background: linear-gradient(180deg, #101010, #0a0a0a);
    border-radius: 16px;
    padding: 12px;
  }
  .kpi .v{
    font-size: 20px;
    font-weight: 900;
    color: var(--accent);
    line-height: 1.1;
  }
  .kpi .l{
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.2;
  }

  .panel{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }

  canvas{
    width: 100%;
    height: 220px;
    border:1px solid var(--line);
    background:#080808;
    border-radius: 16px;
  }

  /* ===== ENTRY ===== */
  .entryGrid{
    display:grid;
    grid-template-columns: 0.9fr 1.1fr;
    gap:12px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .entryGrid{ grid-template-columns: 1fr; }
  }

  .sessionList{ display:grid; gap:10px; margin-top:10px; }
  .session{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }
  .sessionHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .grid7{
    display:grid;
    grid-template-columns: repeat(5, minmax(140px, 1fr)) auto;
    gap:8px;
    align-items:start;
    margin-top: 10px;
  }
  @media (max-width: 980px){
    .grid7{ grid-template-columns: 1fr 1fr; }
  }
  .hint{
    font-size:12px;
    color: var(--muted);
    margin-top: 8px;
  }

  /* ===== WEEK STRIP ===== */
  .weekStrip{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:10px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .weekStrip{ grid-template-columns: repeat(2, 1fr); }
  }
  .dayCard{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }
  .dayCard .d{ font-weight: 800; }
  .dayCard .sub{ margin-top:6px; font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:4px; }

  /* ===== MONTH CALENDAR ===== */
  .calHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .calendar{
    width:100%;
    border-collapse: collapse;
    border:1px solid var(--line);
    border-radius: 16px;
    overflow:hidden;
    background:#080808;
    margin-top: 10px;
  }
  .calendar th, .calendar td{
    border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    padding: 10px;
    vertical-align: top;
    height: 72px;
  }
  .calendar th:last-child, .calendar td:last-child{ border-right:none; }
  .calendar tr:last-child td{ border-bottom:none; }
  .calCell{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .check{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:22px; height:22px;
    border-radius: 999px;
    border:1px solid #1b4f30;
    background: rgba(0,255,106,0.14);
    color: var(--accent);
    font-weight: 900;
    font-size: 12px;
  }
  .dim{ color:#444; }
</style>
</head>

<body>

<div class="topbar">
  <div>
    <h1 id="appTitle">Sport Tracker</h1>
    <h2>Mehrere Sessions pro Tag ¬∑ Auswertung: Tag/Woche/Monat/Jahr/Gesamt</h2>
    <div class="small">Speicherung lokal im Browser (Archiv). Code-Updates l√∂schen Daten nicht (au√üer Privatmodus/Website-Daten l√∂schen).</div>
  </div>

  <div class="row" style="min-width:280px;">
    <div class="grow">
      <div class="small muted" style="margin-bottom:6px;">Name / Profil</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay" />
    </div>
    <div style="display:flex; gap:8px; align-items:end;">
      <button id="saveProfile">Speichern</button>
      <button id="exportBtn" class="ghost" title="Backup als JSON">Export</button>
      <button id="importBtn" class="ghost" title="Restore aus JSON">Import</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />
    </div>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <h3>üìä √úbersicht</h3>
      <div class="small">W√§hle Zeitraum ‚Äì alles auf einen Blick, ohne Scroll-Marathon.</div>
    </div>
    <div class="row">
      <input id="focusDate" type="date" style="max-width:220px;" />
      <button id="todayBtn">Heute</button>
    </div>
  </div>

  <div class="tabs" id="rangeTabs">
    <div class="tab active" data-range="day">Tag</div>
    <div class="tab" data-range="week">Woche</div>
    <div class="tab" data-range="month">Monat</div>
    <div class="tab" data-range="year">Jahr</div>
    <div class="tab" data-range="all">Gesamt</div>
  </div>

  <div class="dashGrid">
    <div class="panel">
      <div class="small muted" id="rangeLabel">‚Äî</div>
      <div class="kpiGrid" id="kpiGrid"></div>

      <div id="weekStripWrap" style="display:none;">
        <hr>
        <h3 style="margin-bottom:8px;">üî• Tageskalorien (Woche)</h3>
        <div class="weekStrip" id="weekStrip"></div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin-bottom:10px;">üìà Diagramme</h3>
      <div class="small muted" style="margin-bottom:8px;">Monat: Kalorien pro Tag ¬∑ Jahr: Kilometer pro Woche</div>
      <canvas id="chartA" width="900" height="260"></canvas>
      <div style="height:10px;"></div>
      <canvas id="chartB" width="900" height="260"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <h3>‚ûï Sport eintragen (Multi-Sessions)</h3>
  <div class="small">Joggen & Schwimmen: Dauer + Kilometer + Pace (mm:ss / km). Alles andere: Dauer + Kalorien.</div>

  <div class="entryGrid">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div style="min-width:220px;">
          <div class="small muted">Datum</div>
          <input id="entryDate" type="date" />
        </div>
        <div style="display:flex; gap:8px; align-items:end;">
          <button id="addSessionBtn">+ Session</button>
          <button id="clearDayBtn" class="danger" title="L√∂scht alle Sessions an diesem Datum">Tag l√∂schen</button>
        </div>
      </div>

      <div class="hint">
        Pace Format: <b>mm:ss</b> (z.B. <b>5:30</b>). Kein 5:60 ‚Äì wird sauber normalisiert.
      </div>

      <div class="sessionList" id="sessionList"></div>
    </div>

    <div class="panel">
      <h3 style="margin-bottom:10px;">üóìÔ∏è Monatskalender</h3>
      <div class="small muted">‚úî erscheint, wenn du an dem Tag mindestens 1 Training hast.</div>

      <div class="calHeader" style="margin-top:10px;">
        <div class="row">
          <button id="calPrev">‚óÄ</button>
          <button id="calNext">‚ñ∂</button>
          <button id="calThis">Dieser Monat</button>
        </div>
        <div style="font-weight:900;" id="calLabel">‚Äî</div>
      </div>

      <div style="overflow:auto;">
        <table class="calendar" id="monthCal"></table>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
/* ===================== STORAGE ===================== */
const KEY_DATA = "sport_tracker_data_v2";
const KEY_PROFILE = "sport_tracker_profile_v2";

/* ===================== CONSTANTS ===================== */
const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

/* ===================== HELPERS ===================== */
const pad = n => String(n).padStart(2,"0");
const iso = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

function parsePace(p){
  if(!p || !p.includes(":")) return null;
  const [m,s] = p.split(":").map(Number);
  if(!Number.isFinite(m) || !Number.isFinite(s) || s<0 || s>59 || m<0) return null;
  return m*60 + s;
}
function paceFromSeconds(sec){
  let total = Math.round(sec);
  const m = Math.floor(total/60);
  const s = total % 60;
  return `${m}:${pad(s)}`;
}

/* ===================== STATE ===================== */
let db = (() => {
  try { return JSON.parse(localStorage.getItem(KEY_DATA) || "{}"); }
  catch { return {}; }
})();
let profile = localStorage.getItem(KEY_PROFILE) || "";

/* ===================== DOM ===================== */
const profileInput = document.getElementById("profileName");
const saveProfileBtn = document.getElementById("saveProfile");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

const entryDateInput = document.getElementById("entryDate");
const focusDateInput = document.getElementById("focusDate");
const todayBtn = document.getElementById("todayBtn");

const sessionList = document.getElementById("sessionList");
const kpiGrid = document.getElementById("kpiGrid");
const rangeLabel = document.getElementById("rangeLabel");

const weekStripWrap = document.getElementById("weekStripWrap");
const weekStrip = document.getElementById("weekStrip");

const chartA = document.getElementById("chartA");
const chartB = document.getElementById("chartB");

const monthCal = document.getElementById("monthCal");
const calLabel = document.getElementById("calLabel");
const calPrev = document.getElementById("calPrev");
const calNext = document.getElementById("calNext");
const calThis = document.getElementById("calThis");

/* ===================== SAVE/LOAD ===================== */
function saveDB(){ localStorage.setItem(KEY_DATA, JSON.stringify(db)); }
function saveProfile(){
  localStorage.setItem(KEY_PROFILE, profile);
  document.getElementById("appTitle").textContent = profile || "Sport Tracker";
}

/* ===================== PROFILE INIT ===================== */
profileInput.value = profile;
saveProfile();
saveProfileBtn.onclick = () => { profile = profileInput.value.trim(); saveProfile(); };

/* ===================== DATE INIT ===================== */
const now = new Date();
entryDateInput.value = iso(now);
focusDateInput.value = iso(now);

todayBtn.onclick = () => {
  focusDateInput.value = iso(new Date());
  renderAll();
};

/* ===================== DATA MODEL ===================== */
/**
db[YYYY-MM-DD] = [
  { type, duration(min), calories, km, pace }
]
*/

function getDay(dateIso){
  if(!Array.isArray(db[dateIso])) db[dateIso] = [];
  return db[dateIso];
}

function addSession(dateIso){
  getDay(dateIso).push({ type:"", duration:"", calories:"", km:"", pace:"" });
  saveDB();
}

function removeSession(dateIso, idx){
  const arr = getDay(dateIso);
  arr.splice(idx,1);
  if(arr.length===0) delete db[dateIso];
  saveDB();
}

document.getElementById("addSessionBtn").onclick = () => {
  addSession(entryDateInput.value);
  renderSessions();
  updateAfterEdit();
};

document.getElementById("clearDayBtn").onclick = () => {
  delete db[entryDateInput.value];
  saveDB();
  renderAll();
};

entryDateInput.onchange = () => renderSessions();
focusDateInput.onchange = () => renderAll();

/* ===================== IMPORTANT FIX ===================== */
/* Beim Tippen NICHT renderSessions() neu bauen -> sonst Fokusverlust */
function updateAfterEdit(){
  renderDashboard();
  renderCharts();
  renderCalendar();
}

/* ===================== RENDER SESSIONS ===================== */
function renderSessions(){
  const dateIso = entryDateInput.value;
  const sessions = getDay(dateIso);

  sessionList.innerHTML = "";

  if(!sessions.length){
    sessionList.innerHTML = `<div class="small muted">Noch keine Sessions an diesem Tag.</div>`;
    return;
  }

  sessions.forEach((s, idx) => {
    const isKm = KM_SPORTS.has(s.type);

    const wrap = document.createElement("div");
    wrap.className = "session";

    wrap.innerHTML = `
      <div class="sessionHead">
        <strong>Session ${idx+1}</strong>
        <button class="danger">L√∂schen</button>
      </div>

      <div class="grid7">
        <select aria-label="Sportart">
          <option value="">Sportart</option>
          ${SPORTS.map(x => `<option value="${x}" ${x===s.type?"selected":""}>${x}</option>`).join("")}
        </select>

        <input type="number" inputmode="numeric" min="0" placeholder="Dauer (min)" value="${s.duration ?? ""}">
        <input type="number" inputmode="numeric" min="0" placeholder="Kalorien" value="${s.calories ?? ""}">
        <input type="number" inputmode="decimal" min="0" step="0.1" placeholder="Kilometer" value="${s.km ?? ""}" ${isKm?"":"disabled"}>
        <input placeholder="Pace mm:ss" value="${s.pace ?? ""}" ${isKm?"":"disabled"}>
        <div></div>
      </div>
    `;

    const delBtn = wrap.querySelector("button");
    const sel = wrap.querySelector("select");
    const inputs = wrap.querySelectorAll("input");
    const dur = inputs[0];
    const cal = inputs[1];
    const km  = inputs[2];
    const pace= inputs[3];

    delBtn.onclick = () => {
      removeSession(dateIso, idx);
      renderAll();
    };

    // Sportart-Wechsel: hier ist Re-Render ok, weil Felder enabled/disabled werden
    sel.onchange = () => {
      s.type = sel.value;
      saveDB();
      renderSessions();
      updateAfterEdit();
    };

    // LIVE speichern ohne Fokusverlust
    dur.oninput = () => { s.duration = dur.value; saveDB(); updateAfterEdit(); };
    cal.oninput = () => { s.calories = cal.value; saveDB(); updateAfterEdit(); };
    km.oninput  = () => { s.km = km.value; saveDB(); updateAfterEdit(); };
    pace.oninput= () => { s.pace = pace.value; saveDB(); updateAfterEdit(); };

    sessionList.appendChild(wrap);
  });
}

/* ===================== RANGE / TABS ===================== */
let activeRange = "day";
document.querySelectorAll(".tab").forEach(t => {
  t.onclick = () => {
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeRange = t.dataset.range;
    renderAll();
  };
});

function inRange(dateIso, range){
  const d = new Date(dateIso);
  const f = new Date(focusDateInput.value);
  if(range==="day") return dateIso === focusDateInput.value;

  if(range==="week"){
    // "letzte 7 Tage" r√ºckw√§rts inkl. Fokusdatum
    const diff = (d - f) / 86400000;
    return diff >= -6 && diff <= 0;
  }
  if(range==="month") return d.getMonth()===f.getMonth() && d.getFullYear()===f.getFullYear();
  if(range==="year")  return d.getFullYear()===f.getFullYear();
  return true; // all
}

/* ===================== AGGREGATION ===================== */
function aggregate(range){
  const total = { calories:0, minutes:0, km:0, paceSum:0, paceKm:0, sessions:0 };

  for(const [dateIso, sessions] of Object.entries(db)){
    if(!inRange(dateIso, range)) continue;
    if(!Array.isArray(sessions)) continue;

    sessions.forEach(s => {
      total.sessions++;
      total.minutes += Number(s.duration || 0);
      total.calories += Number(s.calories || 0);

      if(KM_SPORTS.has(s.type)){
        const km = Number(s.km || 0);
        const ps = parsePace(s.pace);
        if(km > 0){
          total.km += km;
          if(ps != null){
            total.paceSum += ps * km; // distanzgewichtet
            total.paceKm += km;
          }
        }
      }
    });
  }

  total.avgPace = total.paceKm ? paceFromSeconds(total.paceSum/total.paceKm) : "‚Äì";
  return total;
}

/* ===================== WEEK STRIP HELPERS ===================== */
function mondayOf(dateIso){
  const d = new Date(dateIso);
  const day = d.getDay();
  const diff = day===0 ? -6 : 1-day;
  d.setDate(d.getDate()+diff);
  return iso(d);
}
function addDays(dateIso, n){
  const d = new Date(dateIso);
  d.setDate(d.getDate()+n);
  return iso(d);
}
function sumForDate(dateIso){
  const sessions = db[dateIso] || [];
  let calories=0, minutes=0, km=0, paceSum=0, paceKm=0, count=0;
  sessions.forEach(s => {
    count++;
    minutes += Number(s.duration||0);
    calories += Number(s.calories||0);
    if(KM_SPORTS.has(s.type)){
      const k = Number(s.km||0);
      const ps = parsePace(s.pace);
      if(k>0){
        km += k;
        if(ps!=null){ paceSum += ps*k; paceKm += k; }
      }
    }
  });
  return { calories, minutes, km, avgPace: paceKm ? paceFromSeconds(paceSum/paceKm) : "‚Äì", sessions: count };
}

/* ===================== DASHBOARD (KPIs + LABEL + WEEK STRIP) ===================== */
function renderRangeLabelAndStrip(){
  const f = new Date(focusDateInput.value);

  if(activeRange==="day"){
    rangeLabel.textContent = `Tag: ${f.toLocaleDateString("de-DE")}`;
    weekStripWrap.style.display = "none";
    return;
  }

  if(activeRange==="week"){
    const mon = mondayOf(focusDateInput.value);
    const sun = addDays(mon, 6);
    rangeLabel.textContent = `Woche: ${new Date(mon).toLocaleDateString("de-DE")} ‚Äì ${new Date(sun).toLocaleDateString("de-DE")}`;

    weekStripWrap.style.display = "block";
    weekStrip.innerHTML = "";
    for(let i=0;i<7;i++){
      const dIso = addDays(mon, i);
      const s = sumForDate(dIso);
      const name = new Date(dIso).toLocaleDateString("de-DE", { weekday:"short" });
      const card = document.createElement("div");
      card.className = "dayCard";
      card.innerHTML = `
        <div class="d">${name}</div>
        <div class="sub">
          <span><b style="color:var(--accent)">${s.calories}</b> kcal</span>
          <span>${s.minutes} min ¬∑ ${s.sessions} sessions</span>
        </div>
      `;
      weekStrip.appendChild(card);
    }
    return;
  }

  if(activeRange==="month"){
    rangeLabel.textContent = `Monat: ${f.toLocaleDateString("de-DE", { month:"long", year:"numeric" })}`;
    weekStripWrap.style.display = "none";
    return;
  }

  if(activeRange==="year"){
    rangeLabel.textContent = `Jahr: ${f.getFullYear()}`;
    weekStripWrap.style.display = "none";
    return;
  }

  rangeLabel.textContent = `Gesamt: alle Daten`;
  weekStripWrap.style.display = "none";
}

function renderDashboard(){
  const a = aggregate(activeRange);

  // √ò/Tag im Range (f√ºr Motivation)
  const f = new Date(focusDateInput.value);
  let daysCount = 1;
  if(activeRange==="week") daysCount = 7;
  if(activeRange==="month") daysCount = new Date(f.getFullYear(), f.getMonth()+1, 0).getDate();
  if(activeRange==="year"){
    const y = f.getFullYear();
    daysCount = Math.round((new Date(y,11,31) - new Date(y,0,1))/86400000) + 1;
  }
  if(activeRange==="all"){
    daysCount = Math.max(1, Object.keys(db).length);
  }

  const avgSessionsPerDay = a.sessions / daysCount;
  const avgMinutesPerDay = a.minutes / daysCount;
  const avgCaloriesPerDay = a.calories / daysCount;

  kpiGrid.innerHTML = `
    <div class="kpi"><div class="v">${a.calories}</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">${a.minutes}</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">${a.km.toFixed(1)}</div><div class="l">Kilometer (Joggen/Schwimmen)</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">√ò Pace (distanzgewichtet)</div></div>

    <div class="kpi"><div class="v">${a.sessions}</div><div class="l">Sessions</div></div>
    <div class="kpi"><div class="v">${avgSessionsPerDay.toFixed(2)}</div><div class="l">√ò Sessions / Tag</div></div>
    <div class="kpi"><div class="v">${Math.round(avgMinutesPerDay)}</div><div class="l">√ò Minuten / Tag</div></div>
    <div class="kpi"><div class="v">${Math.round(avgCaloriesPerDay)}</div><div class="l">√ò Kalorien / Tag</div></div>
  `;

  renderRangeLabelAndStrip();
}

/* ===================== CHARTS (Canvas) ===================== */
function clearCanvas(c){
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
}
function drawAxes(ctx, w, h, padL, padB){
  ctx.strokeStyle = "#202020";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, 12);
  ctx.lineTo(padL, h - padB);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(padL, h - padB);
  ctx.lineTo(w - 12, h - padB);
  ctx.stroke();
}
function drawBars(ctx, values, labels, title){
  const w = ctx.canvas.width, h = ctx.canvas.height;
  const padL = 44, padB = 28;

  ctx.fillStyle = "#ffffff";
  ctx.font = "14px system-ui";
  ctx.fillText(title, 12, 18);

  drawAxes(ctx, w, h, padL, padB);

  const maxVal = Math.max(1, ...values);
  const innerW = (w - 12) - padL;
  const innerH = (h - padB) - 28;
  const n = values.length;
  const gap = 4;
  const barW = Math.max(2, (innerW - gap*(n-1)) / n);

  values.forEach((v,i) => {
    const x = padL + i*(barW+gap);
    const bh = (v/maxVal)*innerH;
    const y = (h - padB) - bh;
    ctx.fillStyle = "rgba(0,255,106,0.55)";
    ctx.fillRect(x,y,barW,bh);

    ctx.fillStyle = "#9a9a9a";
    ctx.font = "10px system-ui";
    ctx.fillText(labels[i] ?? "", x, h - 10);
  });
}
function drawLine(ctx, values, labels, title){
  const w = ctx.canvas.width, h = ctx.canvas.height;
  const padL = 44, padB = 28;

  ctx.fillStyle = "#ffffff";
  ctx.font = "14px system-ui";
  ctx.fillText(title, 12, 18);

  drawAxes(ctx, w, h, padL, padB);

  const maxVal = Math.max(1, ...values);
  const innerW = (w - 12) - padL;
  const innerH = (h - padB) - 28;
  const n = values.length;
  const stepX = n>1 ? innerW/(n-1) : innerW;

  ctx.strokeStyle = "rgba(0,255,106,0.9)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v,i) => {
    const x = padL + i*stepX;
    const y = (h - padB) - (v/maxVal)*innerH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  values.forEach((v,i) => {
    const x = padL + i*stepX;
    const y = (h - padB) - (v/maxVal)*innerH;
    ctx.fillStyle = "rgba(0,255,106,1)";
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = "#9a9a9a";
    ctx.font = "10px system-ui";
    ctx.fillText(labels[i] ?? "", x-6, h - 10);
  });
}

function getMonthDays(focusIso){
  const d = new Date(focusIso);
  const y = d.getFullYear(), m = d.getMonth();
  const days = new Date(y, m+1, 0).getDate();
  const out = [];
  for(let i=1;i<=days;i++) out.push(iso(new Date(y,m,i)));
  return out;
}

function weekNumberISO(dateIso){
  const d = new Date(dateIso);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
  const week1 = new Date(d.getFullYear(), 0, 4);
  return 1 + Math.round(((d - week1) / 86400000 - 3 + ((week1.getDay()+6)%7)) / 7);
}

function getYearWeeks(focusIso){
  const y = new Date(focusIso).getFullYear();
  const buckets = new Map();
  const start = new Date(y,0,1);
  const end = new Date(y,11,31);
  for(let cur = new Date(start); cur <= end; cur.setDate(cur.getDate()+1)){
    const k = iso(cur);
    const wn = weekNumberISO(k);
    const km = sumForDate(k).km || 0;
    buckets.set(wn, (buckets.get(wn)||0) + km);
  }
  const weeks = [];
  const kms = [];
  for(let w=1; w<=53; w++){
    if(!buckets.has(w) && w>52) break;
    weeks.push(w);
    kms.push(Number((buckets.get(w)||0).toFixed(2)));
  }
  return { weeks, kms };
}

function renderCharts(){
  const fIso = focusDateInput.value;

  // Chart A: month daily calories bars
  clearCanvas(chartA);
  const ctxA = chartA.getContext("2d");
  const days = getMonthDays(fIso);
  const valsA = days.map(d => sumForDate(d).calories);
  const labelsA = days.map(d => String(Number(d.slice(-2))));
  const monthName = new Date(fIso).toLocaleString("de-DE", { month:"long", year:"numeric" });
  drawBars(ctxA, valsA, labelsA, `Kalorien pro Tag (${monthName})`);

  // Chart B: year weekly km line
  clearCanvas(chartB);
  const ctxB = chartB.getContext("2d");
  const { weeks, kms } = getYearWeeks(fIso);
  const labelsB = weeks.map(w => (w%4===0 ? String(w) : ""));
  const year = new Date(fIso).getFullYear();
  drawLine(ctxB, kms, labelsB, `Kilometer pro Woche (${year})`);
}

/* ===================== MONTH CALENDAR (‚úî trained) ===================== */
let calMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
calPrev.onclick = () => { calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1); renderCalendar(); };
calNext.onclick = () => { calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1); renderCalendar(); };
calThis.onclick = () => { calMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1); renderCalendar(); };

function renderCalendar(){
  const y = calMonth.getFullYear();
  const m = calMonth.getMonth();
  calLabel.textContent = calMonth.toLocaleString("de-DE", { month:"long", year:"numeric" });

  const first = new Date(y,m,1);
  const daysInMonth = new Date(y,m+1,0).getDate();
  const jsDay = first.getDay(); // Sun=0
  const offset = (jsDay===0 ? 6 : jsDay-1); // Mon=0

  const headers = ["Mo","Di","Mi","Do","Fr","Sa","So"];
  let html = "<thead><tr>" + headers.map(h=>`<th class="small muted">${h}</th>`).join("") + "</tr></thead><tbody>";

  let dayNum = 1 - offset;
  for(let row=0; row<6; row++){
    html += "<tr>";
    for(let col=0; col<7; col++){
      if(dayNum < 1 || dayNum > daysInMonth){
        html += `<td class="dim">&nbsp;</td>`;
      } else {
        const d = new Date(y,m,dayNum);
        const key = iso(d);
        const trained = Array.isArray(db[key]) && db[key].length > 0;
        const sum = trained ? sumForDate(key) : null;

        html += `<td>
          <div class="calCell">
            <div style="font-weight:800;">${dayNum}</div>
            ${trained ? `<div class="check">‚úì</div>` : ""}
          </div>
          <div class="small muted" style="margin-top:6px;">
            ${trained ? `${sum.calories} kcal ¬∑ ${sum.minutes} min` : ""}
          </div>
        </td>`;
      }
      dayNum++;
    }
    html += "</tr>";
  }
  html += "</tbody>";
  monthCal.innerHTML = html;
}

/* ===================== EXPORT / IMPORT ===================== */
exportBtn.onclick = () => {
  const payload = { version: 1, exportedAt: new Date().toISOString(), profile, db };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `sport-tracker-backup-${iso(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};
importBtn.onclick = () => importFile.click();
importFile.onchange = async () => {
  const file = importFile.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const payload = JSON.parse(text);
    if(payload && payload.db && typeof payload.db === "object"){
      db = payload.db;
      if(typeof payload.profile === "string"){
        profile = payload.profile;
        profileInput.value = profile;
        saveProfile();
      }
      saveDB();
      renderAll();
      alert("Import erfolgreich ‚úÖ");
    } else if(payload && typeof payload === "object"){
      db = payload;
      saveDB();
      renderAll();
      alert("Import erfolgreich ‚úÖ");
    } else {
      alert("Import fehlgeschlagen: falsches Format.");
    }
  } catch {
    alert("Import fehlgeschlagen: Datei konnte nicht gelesen werden.");
  } finally {
    importFile.value = "";
  }
};

/* ===================== MASTER ===================== */
function renderAll(){
  renderSessions();
  renderDashboard();
  renderCharts();
  renderCalendar();
}
renderAll();

})();
</script>
</body>
</html>