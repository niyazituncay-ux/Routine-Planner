<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sport Tracker</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#a8a8a8;
  --line:#262626;
  --panel:#0c0c0c;
  --panel2:#101010;
  --accent:#00ff6a;
}
body{
  background:var(--bg);
  color:var(--fg);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  max-width:1200px;
  margin:32px auto;
  padding:0 16px 40px;
}
h1{ margin:0; font-size:30px; }
h2{ margin:4px 0 0; font-size:14px; color:var(--muted); }
h3{ margin:0 0 10px; font-size:16px; }
.small{ font-size:12px; color:var(--muted); }

.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:16px;
  padding:16px;
  margin-top:14px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.grow{ flex:1; min-width:220px; }

input, select, textarea{
  width:100%;
  background:var(--panel2);
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 10px;
}

button{
  background:#111;
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:12px;
  padding:9px 14px;
  cursor:pointer;
}
button:hover{ background:#161616; }

.session{
  border:1px solid var(--line);
  background:#0b0b0b;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}

.gridSession{
  display:grid;
  grid-template-columns: repeat(6, minmax(120px,1fr));
  gap:8px;
}

@media (max-width:900px){
  .gridSession{ grid-template-columns: 1fr 1fr; }
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="card">
  <h1 id="appTitle">Sport Tracker</h1>
  <h2>Multi-Sessions Â· OCR Â· Auswertung</h2>
</div>

<!-- PROFIL -->
<div class="card">
  <h3>Profil</h3>
  <div class="row">
    <div class="grow">
      <div class="small">Name</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay">
    </div>
    <button id="saveProfile">Speichern</button>
  </div>
</div>

<!-- EINTRAG -->
<div class="card">
  <h3>âž• Training eintragen</h3>

  <div class="row">
    <div class="grow">
      <div class="small">Datum</div>
      <input id="entryDate" type="date">
    </div>
    <button id="addSessionBtn">+ Session</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="shotBtn">ðŸ“· Screenshot / Foto importieren</button>
    <div id="ocrStatus" class="small"></div>
    <input id="shotFile" type="file" accept="image/*" style="display:none">
  </div>

  <div id="sessionList"></div>
</div>

<!-- OCR MODAL -->
<div class="card" id="ocrModal" style="display:none;">
  <h3>OCR-Vorschlag</h3>

  <div class="gridSession">
    <select id="ocrType"></select>
    <input id="ocrDuration" placeholder="Minuten">
    <input id="ocrCalories" placeholder="Kalorien">
    <input id="ocrKm" placeholder="Kilometer">
    <input id="ocrPace" placeholder="Pace mm:ss">
    <input id="ocrHr" placeholder="Ã˜ Herzfrequenz">
  </div>

  <textarea id="ocrRaw" style="margin-top:10px;" placeholder="Erkannter Text"></textarea>

  <div class="row" style="margin-top:10px;">
    <button id="ocrApply">Ãœbernehmen</button>
    <button id="ocrCancel">Abbrechen</button>
  </div>
</div>

<!-- SCRIPT KOMMT IN PART 2 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(() => {
  /* ===================== STORAGE ===================== */
  const KEY_DATA = "sport_tracker_data_v1";
  const KEY_PROFILE = "sport_tracker_profile_v1";

  /* ===================== CONSTANTS ===================== */
  const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
  const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

  /* ===================== HELPERS ===================== */
  const $ = (id) => document.getElementById(id);
  const pad = (n) => String(n).padStart(2,"0");
  const iso = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  async function fileToCanvasScaled(file, maxDim = 1600){
    // iOS-sicher: FileReader -> Image -> Canvas
    const dataUrl = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const img = await new Promise((resolve, reject) => {
      const im = new Image();
      im.onload = () => resolve(im);
      im.onerror = reject;
      im.src = dataUrl;
    });

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;
    const biggest = Math.max(w,h);
    const scale = biggest > maxDim ? (maxDim / biggest) : 1;

    const cw = Math.max(1, Math.round(w*scale));
    const ch = Math.max(1, Math.round(h*scale));

    const canvas = document.createElement("canvas");
    canvas.width = cw;
    canvas.height = ch;
    const ctx = canvas.getContext("2d", { willReadFrequently:true });

    // weiÃŸer Hintergrund hilft OCR (auch bei Dark Mode Screens)
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,cw,ch);
    ctx.drawImage(img, 0,0,cw,ch);

    return canvas;
  }

  function safeNum(v){
    const n = Number(String(v||"").replace(",", "."));
    return Number.isFinite(n) ? n : 0;
  }

  /* ===================== STATE ===================== */
  let db = (() => {
    try { return JSON.parse(localStorage.getItem(KEY_DATA) || "{}"); }
    catch { return {}; }
  })();

  let profile = localStorage.getItem(KEY_PROFILE) || "";

  function saveDB(){ localStorage.setItem(KEY_DATA, JSON.stringify(db)); }
  function saveProfile(){
    localStorage.setItem(KEY_PROFILE, profile);
    $("appTitle").textContent = profile || "Sport Tracker";
  }

  /* ===================== INIT UI ===================== */
  $("profileName").value = profile;
  saveProfile();

  $("saveProfile").addEventListener("click", () => {
    profile = $("profileName").value.trim();
    saveProfile();
  });

  $("entryDate").value = iso(new Date());

  /* ===================== MODEL ===================== */
  function getDay(dateIso){
    if(!Array.isArray(db[dateIso])) db[dateIso] = [];
    return db[dateIso];
  }

  function addSession(dateIso, sess){
    const base = { type:"", duration:"", calories:"", km:"", pace:"", hr:"" };
    getDay(dateIso).push({ ...base, ...(sess||{}) });
    saveDB();
  }

  function removeSession(dateIso, index){
    const arr = getDay(dateIso);
    arr.splice(index,1);
    if(arr.length===0) delete db[dateIso];
    saveDB();
  }

  /* ===================== RENDER SESSIONS ===================== */
  function renderSessions(){
    const dateIso = $("entryDate").value;
    const list = $("sessionList");
    const arr = getDay(dateIso);

    list.innerHTML = "";
    if(!arr.length){
      list.innerHTML = `<div class="small">Noch keine Sessions.</div>`;
      return;
    }

    arr.forEach((s, i) => {
      const isKm = KM_SPORTS.has(s.type);

      const el = document.createElement("div");
      el.className = "session";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <strong>Session ${i+1}</strong>
          <button data-del="${i}" style="border-color:#3a1a1a;color:#ff5b5b;">LÃ¶schen</button>
        </div>

        <div class="gridSession" style="margin-top:10px;">
          <select data-k="type" aria-label="Sportart"></select>
          <input data-k="duration" inputmode="numeric" placeholder="Minuten" value="${s.duration||""}">
          <input data-k="calories" inputmode="numeric" placeholder="Kalorien" value="${s.calories||""}">
          <input data-k="km" inputmode="decimal" placeholder="KM" ${isKm?"":"disabled"} value="${s.km||""}">
          <input data-k="pace" placeholder="Pace mm:ss" ${isKm?"":"disabled"} value="${s.pace||""}">
          <input data-k="hr" inputmode="numeric" placeholder="Ã˜ HF" value="${s.hr||""}">
        </div>

        <div class="small" style="margin-top:8px; color:var(--muted);">
          Joggen/Schwimmen: KM + Pace Â· Andere: Kalorien Â· Ã˜ HF immer mÃ¶glich
        </div>
      `;

      // Sport select options
      const sel = el.querySelector('select[data-k="type"]');
      sel.innerHTML = `<option value="">Sportart</option>` + SPORTS.map(x =>
        `<option value="${x}" ${x===s.type?"selected":""}>${x}</option>`
      ).join("");

      // Delete
      el.querySelector("button[data-del]").addEventListener("click", () => {
        removeSession(dateIso, i);
        renderSessions();
      });

      // Change handlers
      sel.addEventListener("change", () => {
        s.type = sel.value;
        saveDB();
        renderSessions(); // re-render to enable/disable km+pace
      });

      el.querySelectorAll("input[data-k]").forEach(inp => {
        const key = inp.dataset.k;
        inp.addEventListener("input", () => {
          s[key] = inp.value;
          saveDB(); // speichern bei jeder Eingabe
        });
      });

      list.appendChild(el);
    });
  }

  $("addSessionBtn").addEventListener("click", () => {
    addSession($("entryDate").value);
    renderSessions();
  });

  $("entryDate").addEventListener("change", renderSessions);

  /* ===================== OCR UI ===================== */
  $("ocrType").innerHTML = `<option value="">Auto</option>` + SPORTS.map(x => `<option value="${x}">${x}</option>`).join("");

  // iOS Safari: file input darf nicht display:none sein (aber wir haben es so im PART 1)
  // -> wir bauen trotzdem robust: wenn display:none Probleme macht, sag Bescheid, dann machen wir "offscreen"
  $("shotBtn").addEventListener("click", () => {
    $("shotFile").value = ""; // iOS: sonst triggert change manchmal nicht
    $("shotFile").click();
  });

  $("shotFile").addEventListener("change", async () => {
    const f = $("shotFile").files?.[0];
    if(!f) return;

    try{
      if(!window.Tesseract){
        $("ocrStatus").textContent = "Tesseract nicht geladen âŒ";
        return;
      }

      $("ocrStatus").textContent = "Bild vorbereitenâ€¦";
      const canvas = await fileToCanvasScaled(f, 1600);

      $("ocrStatus").textContent = "OCR startetâ€¦";

      const res = await Tesseract.recognize(canvas, "deu+eng", {
        logger: m => {
          if(m.status && typeof m.progress === "number"){
            $("ocrStatus").textContent = `${m.status}â€¦ ${Math.round(m.progress*100)}%`;
          }
        }
      });

      const txt = (res?.data?.text || "")
        .replace(/\u00A0/g," ")
        .replace(/\s+/g," ")
        .trim();

      $("ocrRaw").value = txt || "";

      // robustere Extraktion
      const dur = (txt.match(/(\d{1,3})\s*(min|minute[n]?)\b/i)||[])[1] || "";
      const kcal = (txt.match(/(\d{2,5})\s*(kcal|cal)\b/i)||[])[1] || "";
      const km = ((txt.match(/(\d+(?:[.,]\d+)?)\s*km\b/i)||[])[1] || "").replace(",", ".");
      const pace =
        (txt.match(/(\d{1,2}:\d{2})\s*(\/\s*km|\/km|min\/km)\b/i)||[])[1] ||
        (txt.match(/\b(\d{1,2}:\d{2})\b/)||[])[1] ||
        "";
      const hr =
        (txt.match(/(\d{2,3})\s*bpm\b/i)||[])[1] ||
        ((txt.match(/\b(hf|herz)\s*[:\-]?\s*(\d{2,3})\b/i)||[])[2] || "");

      $("ocrDuration").value = dur;
      $("ocrCalories").value = kcal;
      $("ocrKm").value = km;
      $("ocrPace").value = pace;
      $("ocrHr").value = hr;

      // Auto sport
      if(km && pace) $("ocrType").value = "Joggen";
      else if(km && !pace) $("ocrType").value = "Schwimmen";
      else $("ocrType").value = "Krafttraining";

      $("ocrModal").style.display = "block";
      $("ocrStatus").textContent = "OCR fertig âœ…";
    } catch(e){
      console.error(e);
      $("ocrStatus").textContent = "OCR Fehler âŒ";
    }
  });

  $("ocrCancel").addEventListener("click", () => {
    $("ocrModal").style.display = "none";
  });

  $("ocrApply").addEventListener("click", () => {
    const d = $("entryDate").value;
    addSession(d, {
      type: $("ocrType").value || "Krafttraining",
      duration: $("ocrDuration").value || "",
      calories: $("ocrCalories").value || "",
      km: $("ocrKm").value || "",
      pace: $("ocrPace").value || "",
      hr: $("ocrHr").value || ""
    });
    $("ocrModal").style.display = "none";
    $("ocrStatus").textContent = "Session Ã¼bernommen âœ…";
    renderSessions();
  });

  /* ===================== START ===================== */
  renderSessions();
})();
</script>
</body>
</html>
