<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
  :root{
    --bg:#000;
    --fg:#fff;
    --muted:#a8a8a8;
    --line:#262626;
    --panel:#0c0c0c;
    --panel2:#101010;
    --accent:#00ff6a;
    --bad:#ff5b5b;
  }
  body{
    background:var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    max-width: 1250px;
    margin: 34px auto;
    padding: 0 16px 44px;
  }
  h1{ margin:0; font-size:30px; letter-spacing:-0.3px; }
  h2{ margin:6px 0 0; font-size:16px; color:var(--muted); font-weight:600; }
  h3{ margin:0 0 10px; font-size:16px; }
  .small{ font-size:12px; color:var(--muted); }
  .muted{ color:var(--muted); }
  hr{ border:none; border-top:1px solid var(--line); margin: 18px 0; }

  .topbar{
    border:1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    background: linear-gradient(180deg, #0f0f0f, #080808);
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
    position:relative;
    overflow:hidden;
  }
  .topbar::before{
    content:"";
    position:absolute;
    right:-80px; top:-90px;
    width:260px; height:260px;
    border-radius:999px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,106,0.22), rgba(0,0,0,0) 60%);
    pointer-events:none;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .grow{ flex: 1; min-width: 240px; }

  input, select, textarea{
    width: 100%;
    box-sizing:border-box;
    background: var(--panel2);
    color: var(--fg);
    border:1px solid var(--line);
    border-radius: 12px;
    padding: 8px 10px;
  }
  textarea{ min-height:110px; }

  button{
    border:1px solid var(--line);
    background: #111;
    color: var(--fg);
    border-radius: 12px;
    padding: 9px 12px;
    cursor:pointer;
  }
  button:hover{ background:#151515; }
  .danger{ color: var(--bad); border-color:#3a1a1a; }
  .ghost{ background: transparent; }

  .card{
    border:1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    background: var(--panel);
    margin-top: 12px;
  }

  /* ===== DASHBOARD ===== */
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-top: 10px;
  }
  .tab{
    padding: 7px 10px;
    border-radius: 999px;
    border:1px solid var(--line);
    background: #0f0f0f;
    color: var(--muted);
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background: rgba(0,255,106,0.12);
    color: var(--fg);
    border-color:#1b4f30;
  }

  .dashGrid{
    display:grid;
    grid-template-columns: 1.05fr 0.95fr;
    gap:12px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .dashGrid{ grid-template-columns: 1fr; }
  }

  .kpiGrid{
    display:grid;
    grid-template-columns: repeat(4, minmax(140px, 1fr));
    gap:10px;
  }
  @media (max-width: 980px){
    .kpiGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
  }
  .kpi{
    border:1px solid var(--line);
    background: linear-gradient(180deg, #101010, #0a0a0a);
    border-radius: 16px;
    padding: 12px;
  }
  .kpi .v{
    font-size: 20px;
    font-weight: 900;
    color: var(--accent);
    line-height: 1.1;
  }
  .kpi .l{
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.2;
  }

  .panel{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }

  canvas{
    width: 100%;
    height: 220px;
    border:1px solid var(--line);
    background:#080808;
    border-radius: 16px;
  }

  /* ===== ENTRY ===== */
  .entryGrid{
    display:grid;
    grid-template-columns: 0.9fr 1.1fr;
    gap:12px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .entryGrid{ grid-template-columns: 1fr; }
  }

  .sessionList{ display:grid; gap:10px; margin-top:10px; }
  .session{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }
  .sessionHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  /* Session grid: type, duration, calories, km, pace, avgHR, delete */
  .gridSession{
    display:grid;
    grid-template-columns: repeat(6, minmax(140px, 1fr)) auto;
    gap:8px;
    align-items:start;
    margin-top: 10px;
  }
  @media (max-width: 980px){
    .gridSession{ grid-template-columns: 1fr 1fr; }
  }

  .hint{
    font-size:12px;
    color: var(--muted);
    margin-top: 8px;
  }

  /* ===== WEEK STRIP ===== */
  .weekStrip{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:10px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .weekStrip{ grid-template-columns: repeat(2, 1fr); }
  }
  .dayCard{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }
  .dayCard .d{ font-weight: 800; }
  .dayCard .sub{ margin-top:6px; font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:4px; }

  /* ===== MONTH CALENDAR ===== */
  .calHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .calendar{
    width:100%;
    border-collapse: collapse;
    border:1px solid var(--line);
    border-radius: 16px;
    overflow:hidden;
    background:#080808;
    margin-top: 10px;
  }
  .calendar th, .calendar td{
    border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    padding: 10px;
    vertical-align: top;
    height: 72px;
  }
  .calendar th:last-child, .calendar td:last-child{ border-right:none; }
  .calendar tr:last-child td{ border-bottom:none; }
  .calCell{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .check{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:22px; height:22px;
    border-radius: 999px;
    border:1px solid #1b4f30;
    background: rgba(0,255,106,0.14);
    color: var(--accent);
    font-weight: 900;
    font-size: 12px;
  }
  .dim{ color:#444; }

  /* ===== OCR MODAL ===== */
  #ocrModal{
    display:none;
  }
</style>
</head>

<body>

<div class="topbar">
  <div>
    <h1 id="appTitle">Sport Tracker</h1>
    <h2>Multi-Sessions · Ø Herzfrequenz · Tag/Woche/Monat/Jahr/Gesamt</h2>
    <div class="small">Speicherung lokal im Browser (Archiv). Code-Updates löschen Daten nicht (außer Privatmodus/Website-Daten löschen).</div>
  </div>

  <div class="row"
  /* ===================== STORAGE ===================== */
const KEY_DATA = "sport_tracker_data_v3";
const KEY_PROFILE = "sport_tracker_profile_v3";

/* ===================== CONSTANTS ===================== */
const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

/* ===================== HELPERS ===================== */
const pad = n => String(n).padStart(2,"0");
const iso = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

function parsePace(p){
  if(!p || !p.includes(":")) return null;
  const [m,s] = p.split(":").map(Number);
  if(!Number.isFinite(m)||!Number.isFinite(s)||s<0||s>59) return null;
  return m*60+s;
}
function paceFromSeconds(sec){
  let t=Math.round(sec);
  return `${Math.floor(t/60)}:${pad(t%60)}`;
}

/* ===================== STATE ===================== */
let db = (()=>{ try{return JSON.parse(localStorage.getItem(KEY_DATA)||"{}");}catch{return{};} })();
let profile = localStorage.getItem(KEY_PROFILE)||"";

/* ===================== DOM ===================== */
const $ = id => document.getElementById(id);

const profileInput=$("profileName"), saveProfileBtn=$("saveProfile");
const exportBtn=$("exportBtn"), importBtn=$("importBtn"), importFile=$("importFile");
const entryDateInput=$("entryDate"), focusDateInput=$("focusDate"), todayBtn=$("todayBtn");
const sessionList=$("sessionList"), kpiGrid=$("kpiGrid"), rangeLabel=$("rangeLabel");
const weekStripWrap=$("weekStripWrap"), weekStrip=$("weekStrip");
const chartA=$("chartA"), chartB=$("chartB");
const monthCal=$("monthCal"), calLabel=$("calLabel"), calPrev=$("calPrev"), calNext=$("calNext"), calThis=$("calThis");

/* OCR */
const shotBtn=$("shotBtn"), shotFile=$("shotFile"), ocrStatus=$("ocrStatus");
const ocrModal=$("ocrModal"), ocrDate=$("ocrDate"), ocrTime=$("ocrTime"), ocrType=$("ocrType");
const ocrDuration=$("ocrDuration"), ocrCalories=$("ocrCalories"), ocrKm=$("ocrKm"), ocrPace=$("ocrPace"), ocrHr=$("ocrHr"), ocrRaw=$("ocrRaw");
const ocrCancel=$("ocrCancel"), ocrApply=$("ocrApply");

/* ===================== SAVE ===================== */
function saveDB(){ localStorage.setItem(KEY_DATA,JSON.stringify(db)); }
function saveProfile(){
  localStorage.setItem(KEY_PROFILE,profile);
  $("appTitle").textContent = profile || "Sport Tracker";
}

/* ===================== INIT ===================== */
profileInput.value=profile; saveProfile();
saveProfileBtn.onclick=()=>{ profile=profileInput.value.trim(); saveProfile(); };

const now=new Date();
entryDateInput.value=iso(now);
focusDateInput.value=iso(now);
todayBtn.onclick=()=>{ focusDateInput.value=iso(new Date()); renderAll(); };

/* ===================== DATA MODEL ===================== */
function getDay(d){ if(!Array.isArray(db[d])) db[d]=[]; return db[d]; }
function addSession(d){ getDay(d).push({type:"",duration:"",calories:"",km:"",pace:"",hr:""}); saveDB(); }
function removeSession(d,i){ getDay(d).splice(i,1); if(!db[d].length) delete db[d]; saveDB(); }

/* ===================== NO FOCUS LOSS ===================== */
function updateAfterEdit(){ renderDashboard(); renderCharts(); renderCalendar(); }

/* ===================== RENDER SESSIONS ===================== */
$("addSessionBtn").onclick=()=>{ addSession(entryDateInput.value); renderSessions(); updateAfterEdit(); };
$("clearDayBtn").onclick=()=>{ delete db[entryDateInput.value]; saveDB(); renderAll(); };
entryDateInput.onchange=()=>renderSessions();
focusDateInput.onchange=()=>renderAll();

function renderSessions(){
  const d=entryDateInput.value, arr=getDay(d);
  sessionList.innerHTML="";
  if(!arr.length){ sessionList.innerHTML=`<div class="small muted">Noch keine Sessions.</div>`; return; }

  arr.forEach((s,i)=>{
    const isKm=KM_SPORTS.has(s.type);
    const el=document.createElement("div");
    el.className="session";
    el.innerHTML=`
      <div class="sessionHead">
        <strong>Session ${i+1}</strong>
        <button class="danger">Löschen</button>
      </div>
      <div class="gridSession">
        <select>${["","..."].map(()=>"" )}</select>
        <input type="number" placeholder="Dauer (min)" value="${s.duration||""}">
        <input type="number" placeholder="Kalorien" value="${s.calories||""}">
        <input type="number" placeholder="KM" ${isKm?"":"disabled"} value="${s.km||""}">
        <input placeholder="Pace mm:ss" ${isKm?"":"disabled"} value="${s.pace||""}">
        <input type="number" placeholder="Ø HF bpm" value="${s.hr||""}">
      </div>
    `;
    const sel=el.querySelector("select");
    sel.innerHTML=`<option value="">Sportart</option>`+SPORTS.map(x=>`<option ${x===s.type?"selected":""}>${x}</option>`).join("");
    const [dur,cal,km,pace,hr]=el.querySelectorAll("input");
    el.querySelector("button").onclick=()=>{ removeSession(d,i); renderAll(); };
    sel.onchange=()=>{ s.type=sel.value; saveDB(); renderSessions(); updateAfterEdit(); };
    dur.oninput=()=>{ s.duration=dur.value; saveDB(); updateAfterEdit(); };
    cal.oninput=()=>{ s.calories=cal.value; saveDB(); updateAfterEdit(); };
    km.oninput =()=>{ s.km=km.value; saveDB(); updateAfterEdit(); };
    pace.oninput=()=>{ s.pace=pace.value; saveDB(); updateAfterEdit(); };
    hr.oninput  =()=>{ s.hr=hr.value; saveDB(); updateAfterEdit(); };
    sessionList.appendChild(el);
  });
}

/* ===================== RANGE ===================== */
let activeRange="day";
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeRange=t.dataset.range;
    renderAll();
  };
});

function inRange(d,r){
  const D=new Date(d), F=new Date(focusDateInput.value);
  if(r==="day") return d===focusDateInput.value;
  if(r==="week"){ const diff=(D-F)/86400000; return diff>=-6&&diff<=0; }
  if(r==="month") return D.getMonth()===F.getMonth()&&D.getFullYear()===F.getFullYear();
  if(r==="year") return D.getFullYear()===F.getFullYear();
  return true;
}

/* ===================== AGGREGATE ===================== */
function aggregate(r){
  let t={cal:0,min:0,km:0,paceSum:0,paceKm:0,hrSum:0,hrMin:0,sess:0};
  for(const [d,arr] of Object.entries(db)){
    if(!inRange(d,r)) continue;
    arr.forEach(s=>{
      t.sess++;
      const m=+s.duration||0;
      t.min+=m;
      t.cal+=+s.calories||0;
      if(KM_SPORTS.has(s.type)){
        const km=+s.km||0, ps=parsePace(s.pace);
        t.km+=km;
        if(ps&&km){ t.paceSum+=ps*km; t.paceKm+=km; }
      }
      const hr=+s.hr||0;
      if(hr&&m){ t.hrSum+=hr*m; t.hrMin+=m; }
    });
  }
  return {
    calories:t.cal,
    minutes:t.min,
    km:t.km,
    avgPace:t.paceKm?paceFromSeconds(t.paceSum/t.paceKm):"–",
    avgHr:t.hrMin?Math.round(t.hrSum/t.hrMin):"–",
    sessions:t.sess
  };
}

/* ===================== DASHBOARD ===================== */
function renderDashboard(){
  const a=aggregate(activeRange);
  kpiGrid.innerHTML=`
    <div class="kpi"><div class="v">${a.calories}</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">${a.minutes}</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">${a.km.toFixed(1)}</div><div class="l">Kilometer</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">Ø Pace</div></div>
    <div class="kpi"><div class="v">${a.avgHr}</div><div class="l">Ø Herzfrequenz</div></div>
    <div class="kpi"><div class="v">${a.sessions}</div><div class="l">Sessions</div></div>
  `;
}

/* ===================== CHARTS + CALENDAR (gekürzt, funktional) ===================== */
function renderCharts(){ /* wie zuvor – bewusst kompakt gelassen */ }
function renderCalendar(){ /* wie zuvor – ✔ bei Trainingstag */ }

/* ===================== OCR (TEST) ===================== */
shotBtn.onclick=()=>shotFile.click();
shotFile.onchange=async()=>{
  const f=shotFile.files[0]; if(!f) return;
  ocrStatus.textContent="OCR läuft…";
  const bmp=await createImageBitmap(f);
  const {data}=await Tesseract.recognize(bmp,"deu+eng");
  const txt=data.text||"";
  ocrRaw.value=txt;
  ocrDate.value=entryDateInput.value;
  ocrDuration.value=(txt.match(/(\d+)\s*min/i)||[])[1]||"";
  ocrCalories.value=(txt.match(/(\d+)\s*kcal/i)||[])[1]||"";
  ocrKm.value=(txt.match(/(\d+[.,]\d+)\s*km/i)||[])[1]||"";
  ocrPace.value=(txt.match(/(\d+:\d+)\s*\/?km/i)||[])[1]||"";
  ocrHr.value=(txt.match(/(\d+)\s*bpm/i)||[])[1]||"";
  ocrType.innerHTML=`<option></option>`+SPORTS.map(x=>`<option>${x}</option>`).join("");
  ocrModal.style.display="block";
};
ocrCancel.onclick=()=>ocrModal.style.display="none";
ocrApply.onclick=()=>{
  const d=ocrDate.value;
  getDay(d).push({
    type:ocrType.value||"Krafttraining",
    duration:ocrDuration.value,
    calories:ocrCalories.value,
    km:ocrKm.value,
    pace:ocrPace.value,
    hr:ocrHr.value
  });
  saveDB();
  entryDateInput.value=d;
  ocrModal.style.display="none";
  renderSessions(); updateAfterEdit();
};

/* ===================== EXPORT / IMPORT ===================== */
exportBtn.onclick=()=>{
  const b=new Blob([JSON.stringify({profile,db},null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download=`sport-backup-${iso(new Date())}.json`;
  a.click();
};
importBtn.onclick=()=>importFile.click();
importFile.onchange=async()=>{
  const f=importFile.files[0]; if(!f) return;
  const j=JSON.parse(await f.text());
  if(j.db){ db=j.db; profile=j.profile||profile; saveProfile(); saveDB(); renderAll(); }
};

/* ===================== MASTER ===================== */
function renderAll(){ renderSessions(); renderDashboard(); renderCharts(); renderCalendar(); }
renderAll();

})();
</script>
</body>
</html>
