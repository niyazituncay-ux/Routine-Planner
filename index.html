<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#a8a8a8;
  --line:#262626;
  --panel:#0c0c0c;
  --panel2:#101010;
  --accent:#00ff6a;
  --bad:#ff5b5b;
}
body{
  background:var(--bg);
  color:var(--fg);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  max-width: 1250px;
  margin: 34px auto;
  padding: 0 16px 44px;
}
h1{ margin:0; font-size:30px; }
h2{ margin:6px 0 0; font-size:16px; color:var(--muted); }
h3{ margin:0 0 10px; font-size:16px; }
.small{ font-size:12px; color:var(--muted); }

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.grow{ flex:1; min-width:240px; }

input, select, textarea{
  width:100%;
  background:var(--panel2);
  color:var(--fg);
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 10px;
}
button{
  border:1px solid var(--line);
  background:#111;
  color:#fff;
  border-radius:12px;
  padding:9px 12px;
}

.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  background:var(--panel);
  margin-top:12px;
}

.session{
  border:1px solid var(--line);
  background:#0b0b0b;
  border-radius:16px;
  padding:12px;
  margin-top:10px;
}

.gridSession{
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:8px;
}

@media (max-width: 900px){
  .gridSession{ grid-template-columns: 1fr 1fr; }
}
</style>
</head>

<body>

<div class="card">
  <h1 id="appTitle">Sport Tracker</h1>
  <div class="small">Multi-Sessions Â· Speicherung lokal</div>
</div>

<div class="card">
  <div class="row">
    <div class="grow">
      <div class="small">Profilname</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay">
    </div>
    <button id="saveProfile">Speichern</button>
  </div>
</div>

<div class="card">
  <h3>âž• Training</h3>

  <div class="row">
    <input id="entryDate" type="date">
    <button id="addSessionBtn">+ Session</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="shotBtn">ðŸ“· Screenshot importieren</button>
    <div id="ocrStatus" class="small"></div>
    <input id="shotFile" type="file" accept="image/*" style="display:none;">
  </div>

  <div id="sessionList"></div>
</div>

<div class="card" id="ocrModal" style="display:none;">
  <h3>OCR Vorschlag</h3>

  <div class="gridSession">
    <select id="ocrType"></select>
    <input id="ocrDuration" placeholder="Minuten">
    <input id="ocrCalories" placeholder="Kalorien">
    <input id="ocrKm" placeholder="KM">
    <input id="ocrPace" placeholder="Pace mm:ss">
    <input id="ocrHr" placeholder="Ã˜ HF">
  </div>

  <textarea id="ocrRaw" style="margin-top:10px;"></textarea>

  <div class="row" style="margin-top:10px;">
    <button id="ocrApply">Ãœbernehmen</button>
    <button id="ocrCancel">Abbrechen</button>
  </div>
</div>

<!-- WICHTIG: HIER NOCH KEIN JS -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(() => {

/* ===== STORAGE ===== */
const KEY_DATA = "sport_tracker_final";
const KEY_PROFILE = "sport_tracker_profile";

const SPORTS = ["Krafttraining","Joggen","Stretching","Ringen","Schwimmen","Tennis"];
const KM_SPORTS = new Set(["Joggen","Schwimmen"]);

const $ = id => document.getElementById(id);
const iso = d => d.toISOString().slice(0,10);

let db = JSON.parse(localStorage.getItem(KEY_DATA)||"{}");
let profile = localStorage.getItem(KEY_PROFILE)||"";

/* ===== INIT ===== */
$("profileName").value = profile;
$("appTitle").textContent = profile || "Sport Tracker";
$("entryDate").value = iso(new Date());

$("saveProfile").onclick = () => {
  profile = $("profileName").value;
  localStorage.setItem(KEY_PROFILE, profile);
  $("appTitle").textContent = profile || "Sport Tracker";
};

function saveDB(){
  localStorage.setItem(KEY_DATA, JSON.stringify(db));
}

function getDay(d){
  if(!db[d]) db[d]=[];
  return db[d];
}

/* ===== SESSIONS ===== */
$("addSessionBtn").onclick = () => {
  const d = $("entryDate").value;
  getDay(d).push({type:"",duration:"",calories:"",km:"",pace:"",hr:""});
  saveDB();
  renderSessions();
};

function renderSessions(){
  const d = $("entryDate").value;
  const list = $("sessionList");
  list.innerHTML = "";

  (db[d]||[]).forEach((s,i)=>{
    const div = document.createElement("div");
    div.className="session";
    div.innerHTML = `
      <div class="gridSession">
        <select>${SPORTS.map(x=>`<option ${x===s.type?"selected":""}>${x}</option>`).join("")}</select>
        <input value="${s.duration}">
        <input value="${s.calories}">
        <input value="${s.km}">
        <input value="${s.pace}">
        <input value="${s.hr}">
      </div>
    `;
    const [sel,dur,cal,km,pace,hr] = div.querySelectorAll("select,input");
    sel.onchange=()=>{s.type=sel.value; saveDB();};
    dur.oninput=()=>{s.duration=dur.value; saveDB();};
    cal.oninput=()=>{s.calories=cal.value; saveDB();};
    km.oninput=()=>{s.km=km.value; saveDB();};
    pace.oninput=()=>{s.pace=pace.value; saveDB();};
    hr.oninput=()=>{s.hr=hr.value; saveDB();};
    list.appendChild(div);
  });
}

/* ===== OCR ===== */
$("ocrType").innerHTML = SPORTS.map(x=>`<option>${x}</option>`).join("");

$("shotBtn").onclick = ()=> $("shotFile").click();

$("shotFile").onchange = async ()=>{
  const f = $("shotFile").files[0];
  if(!f) return;

  $("ocrStatus").textContent="OCR lÃ¤uftâ€¦";

  const reader = new FileReader();
  reader.onload = async ()=>{
    const img = new Image();
    img.onload = async ()=>{
      const c = document.createElement("canvas");
      c.width=img.width; c.height=img.height;
      c.getContext("2d").drawImage(img,0,0);
      const res = await Tesseract.recognize(c,"deu+eng");
      const t = res.data.text;

      $("ocrRaw").value = t;
      $("ocrDuration").value = (t.match(/(\d+)\s*min/i)||[])[1]||"";
      $("ocrCalories").value = (t.match(/(\d+)\s*kcal/i)||[])[1]||"";
      $("ocrKm").value = (t.match(/(\d+[.,]\d+)\s*km/i)||[])[1]||"";
      $("ocrPace").value = (t.match(/(\d+:\d+)/)||[])[1]||"";
      $("ocrHr").value = (t.match(/(\d+)\s*bpm/i)||[])[1]||"";

      $("ocrModal").style.display="block";
      $("ocrStatus").textContent="OCR fertig";
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
};

$("ocrCancel").onclick = ()=> $("ocrModal").style.display="none";

$("ocrApply").onclick = ()=>{
  const d = $("entryDate").value;
  getDay(d).push({
    type:$("ocrType").value,
    duration:$("ocrDuration").value,
    calories:$("ocrCalories").value,
    km:$("ocrKm").value,
    pace:$("ocrPace").value,
    hr:$("ocrHr").value
  });
  saveDB();
  $("ocrModal").style.display="none";
  renderSessions();
};

renderSessions();

})();
</script>
</body>
</html>
