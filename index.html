<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sport Tracker</title>

<style>
  :root{
    --bg:#000;
    --fg:#fff;
    --muted:#a8a8a8;
    --line:#262626;
    --panel:#0c0c0c;
    --panel2:#101010;
    --accent:#00ff6a;
    --warn:#ffcc00;
    --bad:#ff5b5b;
  }

  body{
    background:var(--bg);
    color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    max-width: 1250px;
    margin: 34px auto;
    padding: 0 16px 40px;
  }

  h1{ margin:0; font-size: 30px; letter-spacing:-0.3px; }
  h2{ margin:6px 0 0; font-size: 16px; color: var(--muted); font-weight: 600; }
  h3{ margin:0 0 10px; font-size: 16px; }
  .small{ font-size: 12px; color: var(--muted); }
  .muted{ color: var(--muted); }
  hr{ border:none; border-top:1px solid var(--line); margin: 18px 0; }

  .topbar{
    border:1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    background: linear-gradient(180deg, #0f0f0f, #080808);
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
    position:relative;
    overflow:hidden;
  }
  .topbar::before{
    content:"";
    position:absolute;
    right:-80px; top:-90px;
    width:260px; height:260px;
    border-radius:999px;
    background: radial-gradient(circle at 30% 30%, rgba(0,255,106,0.22), rgba(0,0,0,0) 60%);
    pointer-events:none;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .grow{ flex: 1; min-width: 240px; }

  input, select{
    width: 100%;
    box-sizing:border-box;
    background: var(--panel2);
    color: var(--fg);
    border:1px solid var(--line);
    border-radius: 12px;
    padding: 8px 10px;
  }
  input[type="checkbox"]{ width:auto; }

  button{
    border:1px solid var(--line);
    background: #111;
    color: var(--fg);
    border-radius: 12px;
    padding: 9px 12px;
    cursor:pointer;
  }
  button:hover{ background:#151515; }
  .danger{ color: var(--bad); border-color:#3a1a1a; }
  .ghost{ background: transparent; }

  .card{
    border:1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    background: var(--panel);
    margin-top: 12px;
  }

  /* ============== DASHBOARD ============== */
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-top: 10px;
  }
  .tab{
    padding: 7px 10px;
    border-radius: 999px;
    border:1px solid var(--line);
    background: #0f0f0f;
    color: var(--muted);
    cursor:pointer;
    user-select:none;
  }
  .tab.active{
    background: rgba(0,255,106,0.12);
    color: var(--fg);
    border-color:#1b4f30;
  }

  .dashGrid{
    display:grid;
    grid-template-columns: 1.05fr 0.95fr;
    gap:12px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .dashGrid{ grid-template-columns: 1fr; }
  }

  .kpiGrid{
    display:grid;
    grid-template-columns: repeat(4, minmax(140px, 1fr));
    gap:10px;
  }
  @media (max-width: 980px){
    .kpiGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
  }
  .kpi{
    border:1px solid var(--line);
    background: linear-gradient(180deg, #101010, #0a0a0a);
    border-radius: 16px;
    padding: 12px;
  }
  .kpi .v{
    font-size: 20px;
    font-weight: 900;
    color: var(--accent);
    line-height: 1.1;
  }
  .kpi .l{
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.2;
  }

  .panel{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }

  canvas{
    width: 100%;
    height: 220px;
    border:1px solid var(--line);
    background:#080808;
    border-radius: 16px;
  }

  /* ============== ENTRY ============== */
  .entryGrid{
    display:grid;
    grid-template-columns: 0.9fr 1.1fr;
    gap:12px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .entryGrid{ grid-template-columns: 1fr; }
  }

  .sessionList{ display:grid; gap:10px; margin-top:10px; }
  .session{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }
  .sessionHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .tag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border:1px solid var(--line);
    background:#0f0f0f;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    color: var(--muted);
  }

  .grid7{
    display:grid;
    grid-template-columns: repeat(6, minmax(140px, 1fr)) auto;
    gap:8px;
    align-items:start;
    margin-top: 10px;
  }
  @media (max-width: 980px){
    .grid7{ grid-template-columns: 1fr 1fr; }
  }

  .hint{
    font-size:12px;
    color: var(--muted);
    margin-top: 8px;
  }

  /* ============== WEEK STRIP ============== */
  .weekStrip{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:10px;
    margin-top: 12px;
  }
  @media (max-width: 980px){
    .weekStrip{ grid-template-columns: repeat(2, 1fr); }
  }
  .dayCard{
    border:1px solid var(--line);
    background: #0b0b0b;
    border-radius: 16px;
    padding: 12px;
  }
  .dayCard .d{ font-weight: 800; }
  .dayCard .sub{ margin-top:6px; font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:4px; }

  /* ============== MONTH CALENDAR ============== */
  .calHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .calendar{
    width:100%;
    border-collapse: collapse;
    border:1px solid var(--line);
    border-radius: 16px;
    overflow:hidden;
    background:#080808;
    margin-top: 10px;
  }
  .calendar th, .calendar td{
    border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    padding: 10px;
    vertical-align: top;
    height: 70px;
  }
  .calendar th:last-child, .calendar td:last-child{ border-right:none; }
  .calendar tr:last-child td{ border-bottom:none; }
  .calCell{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .check{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:22px; height:22px;
    border-radius: 999px;
    border:1px solid #1b4f30;
    background: rgba(0,255,106,0.14);
    color: var(--accent);
    font-weight: 900;
    font-size: 12px;
  }
  .dim{ color:#444; }

</style>
</head>

<body>

<div class="topbar">
  <div>
    <h1 id="appTitle">Sport Tracker</h1>
    <h2 id="appSub">Mehrere Sessions pro Tag ¬∑ Auswertung: Tag/Woche/Monat/Jahr/Gesamt</h2>
    <div class="small">Speicherung lokal im Browser (Archiv). Updates am Code l√∂schen deine Daten nicht ‚Äì au√üer Privatmodus/Website-Daten l√∂schen.</div>
  </div>

  <div class="row" style="min-width:280px;">
    <div class="grow">
      <div class="small muted" style="margin-bottom:6px;">Name / Profil</div>
      <input id="profileName" placeholder="z.B. Niyazi Tuncay" />
    </div>
    <div style="display:flex; gap:8px; align-items:end;">
      <button id="saveProfile">Speichern</button>
      <button id="exportBtn" class="ghost" title="Backup als JSON">Export</button>
      <button id="importBtn" class="ghost" title="Restore aus JSON">Import</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />
    </div>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <h3>üìä √úbersicht</h3>
      <div class="small">W√§hle Zeitraum ‚Äì alles ist auf einen Blick, ohne langes Scrollen.</div>
    </div>
    <div class="row">
      <input id="focusDate" type="date" style="max-width:220px;" />
      <button id="todayBtn">Heute</button>
    </div>
  </div>

  <div class="tabs" id="rangeTabs">
    <div class="tab active" data-range="day">Tag</div>
    <div class="tab" data-range="week">Woche</div>
    <div class="tab" data-range="month">Monat</div>
    <div class="tab" data-range="year">Jahr</div>
    <div class="tab" data-range="all">Gesamt</div>
  </div>

  <div class="dashGrid">
    <div class="panel">
      <div class="small muted" id="rangeLabel">‚Äî</div>
      <div class="kpiGrid" id="kpiGrid"></div>

      <div id="weekStripWrap" style="display:none;">
        <hr>
        <h3 style="margin-bottom:8px;">üî• Tageskalorien (Woche)</h3>
        <div class="weekStrip" id="weekStrip"></div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin-bottom:10px;">üìà Diagramme</h3>
      <div class="small muted" style="margin-bottom:8px;">Monat: Kalorien pro Tag ¬∑ Jahr: Kilometer pro Woche</div>
      <canvas id="chartA" width="900" height="260"></canvas>
      <div style="height:10px;"></div>
      <canvas id="chartB" width="900" height="260"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <h3>‚ûï Sport eintragen (Multi-Sessions)</h3>
  <div class="small">Joggen & Schwimmen: Dauer + Kilometer + Pace (mm:ss / km). Alles andere: Dauer + Kalorien.</div>

  <div class="entryGrid">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small muted">Datum</div>
          <input id="entryDate" type="date" />
        </div>
        <div style="display:flex; gap:8px; align-items:end;">
          <button id="addSessionBtn">+ Session</button>
          <button id="clearDayBtn" class="danger" title="L√∂scht alle Sessions an diesem Datum">Tag l√∂schen</button>
        </div>
      </div>

      <div class="hint">
        Pace Format: <b>mm:ss</b> (z.B. <b>5:30</b>). Kein 5:60 mehr ‚Äì wird korrekt normalisiert.
      </div>

      <div class="sessionList" id="sessionList"></div>
    </div>

    <div class="panel">
      <h3 style="margin-bottom:10px;">üóìÔ∏è Monatskalender</h3>
      <div class="small muted">‚úî erscheint, wenn du an dem Tag mindestens 1 Training hast.</div>

      <div class="calHeader" style="margin-top:10px;">
        <div class="row">
          <button id="calPrev">‚óÄ</button>
          <button id="calNext">‚ñ∂</button>
          <button id="calThis">Dieser Monat</button>
        </div>
        <div style="font-weight:900;" id="calLabel">‚Äî</div>
      </div>

      <div style="overflow:auto;">
        <table class="calendar" id="monthCal"></table>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
/* ===================== STORAGE ===================== */
const KEY_DATA = "sport_tracker_data_v1";
const KEY_PROFILE = "sport_tracker_profile_v1";

/* ===================== CONSTANTS ===================== */
const SPORTS = [
  "Krafttraining",
  "Joggen",
  "Stretching",
  "Ringen",
  "Schwimmen",
  "Tennis"
];

const KM_SPORTS = ["Joggen", "Schwimmen"];

/* ===================== HELPERS ===================== */
const pad = n => String(n).padStart(2, "0");
const iso = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

function parsePace(p){
  if(!p || !p.includes(":")) return null;
  const [m,s] = p.split(":").map(Number);
  if(!Number.isFinite(m) || !Number.isFinite(s)) return null;
  return m*60 + s;
}
function paceFromSeconds(sec){
  let total = Math.round(sec);
  const m = Math.floor(total / 60);
  const s = total % 60;
  return `${m}:${pad(s)}`;
}

/* ===================== STATE ===================== */
let db = JSON.parse(localStorage.getItem(KEY_DATA) || "{}");
let profile = localStorage.getItem(KEY_PROFILE) || "";

function saveDB(){ localStorage.setItem(KEY_DATA, JSON.stringify(db)); }
function saveProfile(){
  localStorage.setItem(KEY_PROFILE, profile);
  document.getElementById("appTitle").textContent = profile || "Sport Tracker";
}

/* ===================== PROFILE ===================== */
const profileInput = document.getElementById("profileName");
document.getElementById("saveProfile").onclick = () => {
  profile = profileInput.value.trim();
  saveProfile();
};
profileInput.value = profile;
saveProfile();

/* ===================== DATE CONTROL ===================== */
const entryDateInput = document.getElementById("entryDate");
const focusDateInput = document.getElementById("focusDate");
const todayBtn = document.getElementById("todayBtn");

let today = new Date();
entryDateInput.value = iso(today);
focusDateInput.value = iso(today);

todayBtn.onclick = () => {
  focusDateInput.value = iso(new Date());
  renderAll();
};

/* ===================== SESSIONS ===================== */
function getDay(date){
  if(!db[date]) db[date] = [];
  return db[date];
}

function addSession(date){
  getDay(date).push({
    type:"",
    duration:"",
    calories:"",
    km:"",
    pace:""
  });
  saveDB();
}

function removeSession(date, idx){
  getDay(date).splice(idx,1);
  if(getDay(date).length===0) delete db[date];
  saveDB();
}

/* ===================== RENDER SESSIONS ===================== */
const sessionList = document.getElementById("sessionList");
document.getElementById("addSessionBtn").onclick = () => {
  addSession(entryDateInput.value);
  renderSessions();
};
document.getElementById("clearDayBtn").onclick = () => {
  delete db[entryDateInput.value];
  saveDB();
  renderAll();
};

function renderSessions(){
  const date = entryDateInput.value;
  sessionList.innerHTML = "";
  const sessions = getDay(date);

  if(!sessions.length){
    sessionList.innerHTML = `<div class="small muted">Noch keine Sessions an diesem Tag.</div>`;
    return;
  }

  sessions.forEach((s, i) => {
    const isKm = KM_SPORTS.includes(s.type);

    const div = document.createElement("div");
    div.className = "session";
    div.innerHTML = `
      <div class="sessionHead">
        <strong>Session ${i+1}</strong>
        <button class="danger">L√∂schen</button>
      </div>
      <div class="grid7">
        <select>
          <option value="">Sportart</option>
          ${SPORTS.map(x=>`<option ${x===s.type?"selected":""}>${x}</option>`).join("")}
        </select>
        <input type="number" placeholder="Dauer (min)" value="${s.duration}">
        <input type="number" placeholder="Kalorien" value="${s.calories}">
        <input type="number" placeholder="Kilometer" value="${s.km}" ${isKm?"":"disabled"}>
        <input placeholder="Pace mm:ss" value="${s.pace}" ${isKm?"":"disabled"}>
      </div>
    `;

    const [sel,dur,cal,km,pace] = div.querySelectorAll("select,input");

    sel.onchange = () => {
      s.type = sel.value;
      renderSessions();
      renderAll();
    };
    dur.oninput = () => { s.duration = dur.value; saveDB(); renderAll(); };
    cal.oninput = () => { s.calories = cal.value; saveDB(); renderAll(); };
    km.oninput  = () => { s.km = km.value; saveDB(); renderAll(); };
    pace.oninput= () => { s.pace = pace.value; saveDB(); renderAll(); };

    div.querySelector("button").onclick = () => {
      removeSession(date,i);
      renderAll();
    };

    sessionList.appendChild(div);
  });
}

/* ===================== AGGREGATION ===================== */
function aggregate(range){
  let total = {
    calories:0,
    minutes:0,
    km:0,
    paceSum:0,
    paceKm:0,
    sessions:0
  };

  Object.entries(db).forEach(([date,sessions]) => {
    if(!inRange(date,range)) return;

    sessions.forEach(s=>{
      total.sessions++;
      total.minutes += Number(s.duration||0);
      total.calories += Number(s.calories||0);
      if(KM_SPORTS.includes(s.type)){
        const km = Number(s.km||0);
        const ps = parsePace(s.pace);
        if(km>0){
          total.km += km;
          if(ps!=null){
            total.paceSum += ps*km;
            total.paceKm += km;
          }
        }
      }
    });
  });

  total.avgPace = total.paceKm ? paceFromSeconds(total.paceSum/total.paceKm) : "‚Äì";
  return total;
}

/* ===================== RANGE ===================== */
let activeRange = "day";
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick = () => {
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeRange = t.dataset.range;
    renderAll();
  };
});

function inRange(date,range){
  const d = new Date(date);
  const f = new Date(focusDateInput.value);

  if(range==="day") return date===focusDateInput.value;
  if(range==="week"){
    const diff = (d - f) / 86400000;
    return diff>=-6 && diff<=0;
  }
  if(range==="month"){
    return d.getMonth()===f.getMonth() && d.getFullYear()===f.getFullYear();
  }
  if(range==="year"){
    return d.getFullYear()===f.getFullYear();
  }
  return true; // all
}

/* ===================== DASHBOARD ===================== */
const kpiGrid = document.getElementById("kpiGrid");
function renderDashboard(){
  const a = aggregate(activeRange);
  kpiGrid.innerHTML = `
    <div class="kpi"><div class="v">${a.calories}</div><div class="l">Kalorien</div></div>
    <div class="kpi"><div class="v">${a.minutes}</div><div class="l">Minuten</div></div>
    <div class="kpi"><div class="v">${a.km.toFixed(1)}</div><div class="l">Kilometer</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">√ò Pace</div></div>
  `;
}

/* ===================== PLACEHOLDER ===================== */
function renderCharts(){}
function renderCalendar(){}

/* ===================== MASTER ===================== */
function renderAll(){
  renderSessions();
  renderDashboard();
  renderCharts();
  renderCalendar();
}

renderAll();
/* ===================== EXPORT / IMPORT (Backup) ===================== */
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

exportBtn.onclick = () => {
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    profile,
    db
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `sport-tracker-backup-${iso(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

importBtn.onclick = () => importFile.click();

importFile.onchange = async () => {
  const file = importFile.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const payload = JSON.parse(text);

    // akzeptiere entweder komplettes payload oder nur db
    if(payload && payload.db && typeof payload.db === "object"){
      db = payload.db;
      if(typeof payload.profile === "string"){
        profile = payload.profile;
        profileInput.value = profile;
        saveProfile();
      }
      saveDB();
      renderAll();
      alert("Import erfolgreich ‚úÖ");
    } else if(payload && typeof payload === "object"){
      db = payload;
      saveDB();
      renderAll();
      alert("Import erfolgreich ‚úÖ");
    } else {
      alert("Import fehlgeschlagen: falsches Format.");
    }
  } catch(e){
    alert("Import fehlgeschlagen: Datei konnte nicht gelesen werden.");
  } finally {
    importFile.value = "";
  }
};

/* ===================== WEEK STRIP (Tageskalorien in der Woche) ===================== */
const weekStripWrap = document.getElementById("weekStripWrap");
const weekStrip = document.getElementById("weekStrip");
const rangeLabel = document.getElementById("rangeLabel");

function mondayOf(dateIso){
  const d = new Date(dateIso);
  const day = d.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  d.setDate(d.getDate()+diff);
  return iso(d);
}

function addDays(dateIso, n){
  const d = new Date(dateIso);
  d.setDate(d.getDate()+n);
  return iso(d);
}

function sumForDate(dateIso){
  const sessions = db[dateIso] || [];
  let calories=0, minutes=0, km=0, paceSum=0, paceKm=0, count=0;

  sessions.forEach(s=>{
    count++;
    minutes += Number(s.duration||0);
    calories += Number(s.calories||0);
    if(KM_SPORTS.includes(s.type)){
      const k = Number(s.km||0);
      const ps = parsePace(s.pace);
      if(k>0){
        km += k;
        if(ps!=null){ paceSum += ps*k; paceKm += k; }
      }
    }
  });

  return {
    calories,
    minutes,
    km,
    avgPace: paceKm ? paceFromSeconds(paceSum/paceKm) : "‚Äì",
    sessions: count
  };
}

/* ===================== CHARTS (Canvas) ===================== */
const chartA = document.getElementById("chartA");
const chartB = document.getElementById("chartB");

function clearCanvas(c){
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
}

function drawAxes(ctx, w, h, padL, padB){
  ctx.strokeStyle = "#202020";
  ctx.lineWidth = 1;
  // y-axis
  ctx.beginPath();
  ctx.moveTo(padL, 10);
  ctx.lineTo(padL, h - padB);
  ctx.stroke();
  // x-axis
  ctx.beginPath();
  ctx.moveTo(padL, h - padB);
  ctx.lineTo(w - 10, h - padB);
  ctx.stroke();
}

function drawBars(ctx, values, labels, title){
  const w = ctx.canvas.width;
  const h = ctx.canvas.height;
  const padL = 40;
  const padB = 26;

  ctx.fillStyle = "#ffffff";
  ctx.font = "14px system-ui";
  ctx.fillText(title, 12, 18);

  drawAxes(ctx, w, h, padL, padB);

  const maxVal = Math.max(1, ...values);
  const innerW = (w - 10) - padL;
  const innerH = (h - padB) - 24;
  const n = values.length;
  const gap = 6;
  const barW = Math.max(6, (innerW - gap*(n-1)) / n);

  values.forEach((v, i) => {
    const x = padL + i*(barW+gap);
    const bh = (v / maxVal) * innerH;
    const y = (h - padB) - bh;

    ctx.fillStyle = "rgba(0,255,106,0.55)";
    ctx.fillRect(x, y, barW, bh);

    ctx.fillStyle = "#9a9a9a";
    ctx.font = "10px system-ui";
    const lab = labels[i] ?? "";
    ctx.fillText(lab, x, h - 10);
  });
}

function drawLine(ctx, values, labels, title){
  const w = ctx.canvas.width;
  const h = ctx.canvas.height;
  const padL = 40;
  const padB = 26;

  ctx.fillStyle = "#ffffff";
  ctx.font = "14px system-ui";
  ctx.fillText(title, 12, 18);

  drawAxes(ctx, w, h, padL, padB);

  const maxVal = Math.max(1, ...values);
  const innerW = (w - 10) - padL;
  const innerH = (h - padB) - 24;
  const n = values.length;

  const stepX = n > 1 ? innerW/(n-1) : innerW;

  // line
  ctx.strokeStyle = "rgba(0,255,106,0.9)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v, i) => {
    const x = padL + i*stepX;
    const y = (h - padB) - (v/maxVal)*innerH;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // points + labels
  values.forEach((v, i) => {
    const x = padL + i*stepX;
    const y = (h - padB) - (v/maxVal)*innerH;

    ctx.fillStyle = "rgba(0,255,106,1)";
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "#9a9a9a";
    ctx.font = "10px system-ui";
    const lab = labels[i] ?? "";
    ctx.fillText(lab, x-6, h - 10);
  });
}

function getMonthDays(focusIso){
  const d = new Date(focusIso);
  const y = d.getFullYear();
  const m = d.getMonth();
  const first = new Date(y,m,1);
  const last = new Date(y,m+1,0);
  const days = last.getDate();
  const out = [];
  for(let i=1;i<=days;i++){
    out.push(iso(new Date(y,m,i)));
  }
  return out;
}

function weekNumberISO(dateIso){
  // ISO week number
  const d = new Date(dateIso);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
  const week1 = new Date(d.getFullYear(), 0, 4);
  return 1 + Math.round(((d - week1) / 86400000 - 3 + ((week1.getDay()+6)%7)) / 7);
}

function getYearWeeks(focusIso){
  const d = new Date(focusIso);
  const y = d.getFullYear();
  // we iterate days, bucket by ISO week
  const buckets = new Map(); // week -> km
  const start = new Date(y,0,1);
  const end = new Date(y,11,31);
  for(let cur = new Date(start); cur <= end; cur.setDate(cur.getDate()+1)){
    const dateKey = iso(cur);
    const wn = weekNumberISO(dateKey);
    const sum = sumForDate(dateKey);
    const prev = buckets.get(wn) || 0;
    buckets.set(wn, prev + Number(sum.km||0));
  }
  // produce arrays week 1..53
  const weeks = [];
  const kms = [];
  for(let w=1; w<=53; w++){
    if(!buckets.has(w) && w>52) break;
    weeks.push(w);
    kms.push(Number((buckets.get(w)||0).toFixed(2)));
  }
  return { weeks, kms };
}

/* ===================== RENDER CHARTS ===================== */
function renderCharts(){
  const f = focusDateInput.value;

  // Chart A: month daily calories bars
  clearCanvas(chartA);
  const ctxA = chartA.getContext("2d");
  const days = getMonthDays(f);
  const valsA = days.map(d => sumForDate(d).calories);
  const labelsA = days.map(d => String(Number(d.slice(-2)))); // day number
  const monthName = new Date(f).toLocaleString("de-DE", { month:"long", year:"numeric" });
  drawBars(ctxA, valsA, labelsA, `Kalorien pro Tag (${monthName})`);

  // Chart B: year weekly km line
  clearCanvas(chartB);
  const ctxB = chartB.getContext("2d");
  const { weeks, kms } = getYearWeeks(f);
  // label sparsely: every 4 weeks
  const labelsB = weeks.map(w => (w%4===0 ? String(w) : ""));
  const year = new Date(f).getFullYear();
  drawLine(ctxB, kms, labelsB, `Kilometer pro Woche (${year})`);
}

/* ===================== MONTH CALENDAR (‚úî if trained) ===================== */
const monthCal = document.getElementById("monthCal");
const calLabel = document.getElementById("calLabel");
const calPrev = document.getElementById("calPrev");
const calNext = document.getElementById("calNext");
const calThis = document.getElementById("calThis");

let calMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

calPrev.onclick = () => { calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1); renderCalendar(); };
calNext.onclick = () => { calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1); renderCalendar(); };
calThis.onclick = () => { calMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1); renderCalendar(); };

function renderCalendar(){
  const y = calMonth.getFullYear();
  const m = calMonth.getMonth();
  const monthName = calMonth.toLocaleString("de-DE", { month:"long", year:"numeric" });
  calLabel.textContent = monthName;

  const first = new Date(y,m,1);
  const last = new Date(y,m+1,0);
  const daysInMonth = last.getDate();
  const jsDay = first.getDay(); // Sun=0
  const offset = (jsDay===0 ? 6 : jsDay-1); // Mon=0

  const headers = ["Mo","Di","Mi","Do","Fr","Sa","So"];
  let html = "<thead><tr>" + headers.map(h=>`<th class="small muted">${h}</th>`).join("") + "</tr></thead><tbody>";

  let dayNum = 1 - offset;
  for(let row=0; row<6; row++){
    html += "<tr>";
    for(let col=0; col<7; col++){
      if(dayNum < 1 || dayNum > daysInMonth){
        html += `<td class="dim">&nbsp;</td>`;
      } else {
        const d = new Date(y,m,dayNum);
        const dateKey = iso(d);
        const trained = Array.isArray(db[dateKey]) && db[dateKey].length > 0;

        html += `<td>
          <div class="calCell">
            <div style="font-weight:800;">${dayNum}</div>
            ${trained ? `<div class="check">‚úì</div>` : ""}
          </div>
          <div class="small muted" style="margin-top:6px;">
            ${trained ? `${sumForDate(dateKey).calories} kcal ¬∑ ${sumForDate(dateKey).minutes} min` : ""}
          </div>
        </td>`;
      }
      dayNum++;
    }
    html += "</tr>";
  }
  html += "</tbody>";
  monthCal.innerHTML = html;
}

/* ===================== RANGE LABEL + WEEK STRIP ===================== */
function renderRangeLabelAndStrip(){
  const f = new Date(focusDateInput.value);

  if(activeRange==="day"){
    rangeLabel.textContent = `Tag: ${f.toLocaleDateString("de-DE")}`;
    weekStripWrap.style.display = "none";
  }
  if(activeRange==="week"){
    const mon = mondayOf(focusDateInput.value);
    const sun = addDays(mon, 6);
    rangeLabel.textContent = `Woche: ${new Date(mon).toLocaleDateString("de-DE")} ‚Äì ${new Date(sun).toLocaleDateString("de-DE")}`;

    weekStripWrap.style.display = "block";
    weekStrip.innerHTML = "";
    for(let i=0;i<7;i++){
      const dIso = addDays(mon, i);
      const s = sumForDate(dIso);
      const name = new Date(dIso).toLocaleDateString("de-DE", { weekday:"short" });
      const card = document.createElement("div");
      card.className = "dayCard";
      card.innerHTML = `
        <div class="d">${name}</div>
        <div class="sub">
          <span><b style="color:var(--accent)">${s.calories}</b> kcal</span>
          <span>${s.minutes} min ¬∑ ${s.sessions} sessions</span>
        </div>
      `;
      weekStrip.appendChild(card);
    }
  }
  if(activeRange==="month"){
    rangeLabel.textContent = `Monat: ${f.toLocaleDateString("de-DE", { month:"long", year:"numeric" })}`;
    weekStripWrap.style.display = "none";
  }
  if(activeRange==="year"){
    rangeLabel.textContent = `Jahr: ${f.getFullYear()}`;
    weekStripWrap.style.display = "none";
  }
  if(activeRange==="all"){
    rangeLabel.textContent = `Gesamt: alle Daten`;
    weekStripWrap.style.display = "none";
  }
}

/* ===================== IMPROVED KPI GRID (more infos) ===================== */
function renderDashboard(){
  const a = aggregate(activeRange);

  // Extra: √ò sessions pro Tag & √ò Minuten pro Tag im Range
  let daysCount = 1;
  const f = new Date(focusDateInput.value);

  if(activeRange==="week") daysCount = 7;
  if(activeRange==="month"){
    const y = f.getFullYear(), m = f.getMonth();
    daysCount = new Date(y,m+1,0).getDate();
  }
  if(activeRange==="year"){
    const y = f.getFullYear();
    daysCount = ((new Date(y,11,31) - new Date(y,0,1))/86400000) + 1;
  }
  if(activeRange==="all"){
    // approx: count unique days with any entry, but keep stable if empty
    const keys = Object.keys(db);
    daysCount = Math.max(1, keys.length);
  }

  const avgSessionsPerDay = (a.sessions / daysCount);
  const avgMinutesPerDay = (a.minutes / daysCount);
  const avgCaloriesPerDay = (a.calories / daysCount);

  kpiGrid.innerHTML = `
    <div class="kpi"><div class="v">${a.calories}</div><div class="l">Kalorien (${activeRange})</div></div>
    <div class="kpi"><div class="v">${a.minutes}</div><div class="l">Minuten (${activeRange})</div></div>
    <div class="kpi"><div class="v">${a.km.toFixed(1)}</div><div class="l">Kilometer (${activeRange})</div></div>
    <div class="kpi"><div class="v">${a.avgPace}</div><div class="l">√ò Pace (Joggen/Schwimmen)</div></div>

    <div class="kpi"><div class="v">${a.sessions}</div><div class="l">Sessions (${activeRange})</div></div>
    <div class="kpi"><div class="v">${avgSessionsPerDay.toFixed(2)}</div><div class="l">√ò Sessions / Tag</div></div>
    <div class="kpi"><div class="v">${Math.round(avgMinutesPerDay)}</div><div class="l">√ò Minuten / Tag</div></div>
    <div class="kpi"><div class="v">${Math.round(avgCaloriesPerDay)}</div><div class="l">√ò Kalorien / Tag</div></div>
  `;

  renderRangeLabelAndStrip();
}

/* ===================== HOOK FOCUS DATE ===================== */
focusDateInput.onchange = () => renderAll();
entryDateInput.onchange = () => renderSessions();

/* ===================== FINAL MASTER ===================== */
function renderAll(){
  renderSessions();
  renderDashboard();
  renderCharts();
  renderCalendar();
}

renderAll();

})();
</script>

</body>
</html>